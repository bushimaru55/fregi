server {
  listen 80;
  server_name localhost;

  # Laravelプロジェクトの public を root にする
  root /var/www/public;
  index index.php index.html;

  # Livewireルート（PHPで処理が必要）
  location ^~ /billing/livewire/ {
    try_files $uri /billing/index.php?$query_string;
  }

  # Livewireアセット用（/livewire/* → /billing/livewire/*へのリダイレクト対応）
  location ^~ /livewire/ {
    rewrite ^/livewire/(.*)$ /billing/livewire/$1 redirect;
  }

  # /billing/配下の静的ファイル（/billing/を除去してファイルを探す）
  location ~* ^/billing/(css|js|fonts|images)/ {
    rewrite ^/billing/(.*)$ /$1 break;
    expires 7d;
    add_header Cache-Control "public";
    try_files $uri =404;
  }

  # /billing ベースパスで動かす（本番再現）
  location /billing/ {
    try_files $uri $uri/ /billing/index.php?$query_string;
  }

  location = /billing {
    return 301 /billing/;
  }

  location ~ ^/billing/index\.php(/|$) {
    include fastcgi_params;
    fastcgi_pass app:9000;
    fastcgi_param SCRIPT_FILENAME $document_root/index.php;
    fastcgi_param REQUEST_URI $request_uri;
    fastcgi_split_path_info ^(/billing)(/.*)$;
    fastcgi_param PATH_INFO $fastcgi_path_info;
  }

  # PHP
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_pass app:9000;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_param PATH_INFO $fastcgi_path_info;
  }

  # 静的ファイル（任意調整）
  location ~* \.(css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2)$ {
    expires 7d;
    add_header Cache-Control "public";
    try_files $uri =404;
  }
}


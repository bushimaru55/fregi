# F-REGI 伝票番号（ID）ルール

確認日時: 2026-01-13

## 概要

F-REGIの発行受付API（`compsettleapply.cgi`）で使用する伝票番号（ID）のルールをまとめます。

## 基本ルール

### 1. 最大文字数

**最大20文字**

- F-REGI仕様では、伝票番号（ID）は最大20文字まで
- 20文字を超える場合は、F-REGI側でエラーが返される

### 2. 文字種制約

**英数字・ハイフン・アンダースコアが使用可能**

- アルファベット（A-Z, a-z）
- 数字（0-9）
- ハイフン（-）
- アンダースコア（_）

**注意:** 日本語（全角文字）は使用不可

### 3. 一意性

**加盟店内で一意である必要がある**

- 同じSHOPID内で、同じ伝票番号（ID）を重複して使用することはできない
- 一度使用した伝票番号は、再度使用できない（決済が完了またはキャンセルされた場合でも）

### 4. 必須パラメータ

**発行受付APIの必須パラメータ**

- `SHOPID` - 店舗ID
- `ID` - 伝票番号（最大20文字） ← **これ**
- `PAY` - 金額

## 現在の実装

### 伝票番号の生成ルール（ContractController.php）

```php
// 伝票番号（ID）は最大20文字（F-REGI仕様）
// 形式: ORD + YmdHis + 契約ID（パディング）
$timestamp = now()->format('YmdHis'); // 14文字（例: 20260113120541）
$contractId = str_pad((string)$contract->id, 4, '0', STR_PAD_LEFT); // 最大4桁（例: 0001）
$orderId = 'ORD' . $timestamp . $contractId; // 最大21文字（契約IDが4桁の場合）

// 20文字を超える場合は切り詰める（末尾を優先）
if (strlen($orderId) > 20) {
    $orderId = substr($orderId, -20);
}
```

### 生成形式の詳細

**形式:** `ORD` + `YYYYMMDDHHmmss` + `契約ID（4桁パディング）`

**例:**
- 契約ID = 1, 生成時刻 = 2026-01-13 12:05:41 の場合
  - `ORD202601131205410001` （21文字）
  - 20文字を超えるため、末尾20文字を取得: `RD202601131205410001` （20文字）

- 契約ID = 123, 生成時刻 = 2026-01-13 12:05:41 の場合
  - `ORD202601131205410123` （21文字）
  - 末尾20文字: `RD202601131205410123` （20文字）

- 契約ID = 9999, 生成時刻 = 2026-01-13 12:05:41 の場合
  - `ORD202601131205419999` （21文字）
  - 末尾20文字: `RD202601131205419999` （20文字）

### 実装の特徴

1. **プレフィックス:** `ORD`（Orderの略）
   - 実装上の識別子として使用
   - 20文字制限により、長い契約IDの場合に先頭が切り詰められる可能性がある

2. **タイムスタンプ:** `YmdHis`形式（14文字）
   - 年（4桁）+ 月（2桁）+ 日（2桁）+ 時（2桁）+ 分（2桁）+ 秒（2桁）
   - 例: `20260113120541`

3. **契約ID:** 4桁パディング（最大4桁）
   - 左側を0で埋める（例: `0001`, `0123`, `9999`）
   - 契約IDが4桁を超える場合は、数値のまま（例: `12345`）

4. **20文字制限処理:**
   - `substr($orderId, -20)` で末尾20文字を取得
   - 先頭の文字が切り詰められる可能性がある

## 制約と注意事項

### 1. 文字数制限

- **最大20文字**まで
- 20文字を超えるとF-REGI側でエラーが返される
- 実装では`substr($orderId, -20)`で切り詰めているが、プレフィックス（`ORD`）が失われる可能性がある

### 2. 一意性の保証

現在の実装では、以下の組み合わせで一意性を保証しています：

- **タイムスタンプ（秒単位）** + **契約ID**
- 同じ秒内に同じ契約IDで決済が発生することは考えにくいため、実質的に一意性が保証されている

**注意:** タイムスタンプが同じで、契約IDも同じ場合、伝票番号が重複する可能性がある（ただし、現実的には発生しない）

### 3. 切り詰めによる問題

現在の実装では、21文字を超える場合に末尾20文字を取得しています。これにより：

- プレフィックス（`ORD`）が失われる可能性がある
- 例: `ORD202601131205410001` → `RD202601131205410001`

この場合、伝票番号の先頭が`RD`となり、実装意図（`ORD`で始める）とは異なる形式になる可能性があります。

## 改善案

### 案1: タイムスタンプを短縮する

現在の形式: `ORD` + `YmdHis`（14文字） + `契約ID`（4桁） = 21文字

改善案: `ORD` + `YmdHis`（12文字、秒を削除） + `契約ID`（4桁） = 19文字

```php
$timestamp = now()->format('YmdHi'); // 12文字（秒を削除）
$contractId = str_pad((string)$contract->id, 4, '0', STR_PAD_LEFT);
$orderId = 'ORD' . $timestamp . $contractId; // 19文字（20文字以内）
```

**メリット:**
- 常に20文字以内に収まる
- プレフィックス（`ORD`）が保持される

**デメリット:**
- 秒単位の精度が失われる（分単位の精度）

### 案2: 契約IDの桁数を調整する

現在の形式: `ORD` + `YmdHis`（14文字） + `契約ID`（4桁） = 21文字

改善案: `ORD` + `YmdHis`（14文字） + `契約ID`（3桁） = 20文字

```php
$timestamp = now()->format('YmdHis'); // 14文字
$contractId = str_pad((string)$contract->id, 3, '0', STR_PAD_LEFT); // 3桁に変更
$orderId = 'ORD' . $timestamp . $contractId; // 20文字（ちょうど20文字）
```

**メリット:**
- 20文字に収まる
- 秒単位の精度が保持される

**デメリット:**
- 契約IDが3桁まで（999まで）
- 契約IDが1000を超える場合、4桁になる（21文字になる）

### 案3: ハッシュ値を使用する（推奨しない）

契約IDとタイムスタンプからハッシュ値を生成する方法もありますが、F-REGIの仕様上、伝票番号は人間が読める形式が推奨されるため、推奨しません。

## 現在の実装の評価

### ✅ 良い点

1. **一意性の保証:** タイムスタンプ + 契約IDの組み合わせで実質的に一意性が保証されている
2. **可読性:** タイムスタンプが含まれるため、伝票番号から作成日時が推測できる
3. **実用性:** 現在の実装で動作確認が取れている

### ⚠️ 注意点

1. **切り詰め処理:** 20文字を超える場合、先頭が切り詰められる（`ORD`が`RD`になる可能性）
2. **契約IDの桁数:** 契約IDが1000を超えると、確実に21文字を超える
3. **将来的な拡張性:** 契約IDが大きくなると、切り詰めが発生する可能性が高まる

## 推奨事項

### 現時点での対応

現在の実装で動作確認が取れているため、**現時点では変更不要**です。

ただし、以下の点を認識しておくことが重要です：

1. 伝票番号が20文字を超える場合、先頭が切り詰められる
2. F-REGI管理画面では、切り詰められた形式で表示される可能性がある（例: `RD202601131205410001`）
3. これは正常な動作です（F-REGIの仕様上、20文字以内であれば問題ありません）

### 将来的な改善検討

契約IDが大きくなり、切り詰めが頻繁に発生する場合は、以下の改善案を検討してください：

- **案1:** タイムスタンプから秒を削除（12文字）して、常に20文字以内に収める
- **案2:** 契約IDの桁数を3桁に制限（契約IDが1000未満の場合のみ）

ただし、これらの改善は、**既存の伝票番号との互換性**を考慮する必要があります。

## まとめ

| 項目 | 内容 |
|------|------|
| **最大文字数** | 20文字 |
| **現在の実装形式** | `ORD` + `YmdHis`（14文字） + `契約ID`（4桁パディング） |
| **文字数** | 最大21文字（契約IDが4桁の場合） |
| **切り詰め処理** | 20文字を超える場合、末尾20文字を取得（`substr($orderId, -20)`） |
| **一意性** | タイムスタンプ（秒単位） + 契約IDで実質的に保証 |
| **文字種** | 英数字（推奨）、ハイフン・アンダースコアも使用可能 |
| **必須/任意** | 必須パラメータ |

---

作成日: 2026-01-13

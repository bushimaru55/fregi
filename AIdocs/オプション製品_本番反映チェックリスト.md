# オプション製品機能：本番反映チェックリスト

作成日: 2026-01-22

## 概要

オプション製品（ベース製品に追加できるオプション、`products` テーブル保存・常に一回限り）がウェブ（本番）に反映されていなかった事象を受けて、**deploy に不足していたファイル・修正**を反映しました。

---

## 1. 反映したファイル・データ一覧

### 1.1 新規追加（deploy に存在しなかったもの）

| パス | 説明 |
|------|------|
| `app/Models/Product.php` | オプション製品モデル（`type`・`contractPlans` 等） |
| `app/Models/ContractItem.php` | 契約明細モデル（`contract_plan_id`・`product_id` 対応） |
| `app/Http/Controllers/Admin/ProductController.php` | 商品（オプション含む）CRUD |

### 1.2 更新（app と揃えたもの）

| パス | 主な変更 |
|------|----------|
| `app/Models/ContractPlan.php` | `optionProducts()` リレーション追加 |
| `app/Http/Controllers/Admin/ContractPlanController.php` | オプション製品対応（index/store/edit/update・製品種別・紐づけ） |
| `app/Http/Requests/ContractRequest.php` | `option_product_ids` のバリデーション・attributes 追加 |
| `resources/views/contracts/confirm.blade.php` | 配列対応 hidden、オプション製品表示・合計金額 |
| `resources/views/admin/contract-plans/index.blade.php` | ベース／オプション製品セクション・製品管理 |
| `resources/views/admin/contract-plans/_form.blade.php` | 製品種別・オプション紐づけ・ベース紐づけ・`optional($contractPlan)` |
| `resources/views/admin/contract-plans/create.blade.php` | タイトル「製品新規作成」 |
| `resources/views/admin/contract-plans/edit.blade.php` | タイトル「製品編集」 |
| `resources/views/admin/products/*` | index / _form / create / edit（app と同一） |
| `resources/views/layouts/admin.blade.php` | サイドメニュー「契約プラン管理」→「製品管理」 |

### 1.3 既に deploy にあったもの（変更なし）

- `routes/web.php`：`/contract/api/option-products/{id}`・`products` resource
- `ContractController`：`getOptionProducts`・`option_product_ids` 処理
- `contracts/create.blade.php`：オプション製品の動的表示・API 呼び出し

---

## 2. 本番で必要な前提

### 2.1 DB（マイグレーション SQL 実施済みであること）

以下の SQL が本番で実行済みであること（未実施の場合は `AIdocs/オプション商品機能_本番環境マイグレーションSQL.sql` を参照）。

- `products`：`type`・`description`・`is_active`・`display_order` 等
- `contract_items`：`contract_plan_id` 追加・`product_id` を nullable
- `contracts`：`payment_id` を nullable
- `contract_plan_option_products` テーブル作成

### 2.2 データ

- **オプション製品**：`products` に `type = 'option'` のレコードが存在すること
- **紐づけ**：`contract_plan_option_products` に、ベース（`contract_plans`）とオプション（`products`）の対応が登録されていること

オプションが申込フォームに表示されるには、**管理画面でオプション製品を作成し、対象のベース製品に紐づけておく**必要があります。

---

## 3. アップロード対象（FTP 等）

以下はすべて **`deploy/webroot_billing/` 配下**です。  
本番の `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/` に、**同一構造**で上書きアップロードしてください。

### 3.1 今回追加・更新したファイル（抜粋）

```
app/app/Models/Product.php
app/app/Models/ContractItem.php
app/app/Models/ContractPlan.php
app/app/Http/Controllers/Admin/ContractPlanController.php
app/app/Http/Controllers/Admin/ProductController.php
app/app/Http/Requests/ContractRequest.php
app/resources/views/contracts/confirm.blade.php
app/resources/views/admin/contract-plans/index.blade.php
app/resources/views/admin/contract-plans/_form.blade.php
app/resources/views/admin/contract-plans/create.blade.php
app/resources/views/admin/contract-plans/edit.blade.php
app/resources/views/admin/products/index.blade.php
app/resources/views/admin/products/_form.blade.php
app/resources/views/admin/products/create.blade.php
app/resources/views/admin/products/edit.blade.php
app/resources/views/layouts/admin.blade.php
```

### 3.2 手順

1. **バックアップ**：本番の該当ディレクトリをバックアップする。
2. **アップロード**：`deploy/webroot_billing/` の中身を、本番の `.../webroot/billing/` にそのまま上書き。
3. **`.env`**：本番用 `.env` は既存を維持（APP_KEY・DB 等）。上書きしない。
4. **権限**：`app/storage`・`app/bootstrap/cache` を 775 等、従来通りに設定。

---

## 4. 動作確認（本番）

1. **管理画面**
   - ログイン → **製品管理** に「ベース製品」「オプション製品」の両方があること。
   - 新規作成で「オプション製品」を選び、ベース製品を選択して作成できること。
   - 既存ベース製品の編集で「紐づけるオプション製品」を変更できること。

2. **申込フォーム**
   - ベース製品を選択すると、紐づくオプション製品が **動的に** 表示されること。
   - オプションを選択して確認画面へ進むと、オプション名・金額・合計が表示されること。
   - そのまま決済へ進み、エラーなく完了できること（決済連携の設定は既存どおり）。

3. **API**
   - `GET /contract/api/option-products/{contract_plan_id}` が 200 で JSON を返すこと（紐づくオプションのみ）。

---

## 5. トラブル時

- **オプションが表示されない**  
  - 対象ベース製品にオプションが紐づいているか（`contract_plan_option_products`）確認。  
  - 管理画面で紐づけを保存し直す。
- **500 エラー**  
  - `app/storage/logs/laravel.log` 等でエラー内容を確認。  
  - `Product`・`ContractItem` 等のクラス未找到の場合は、上記アップロードパス・配置の再確認。
- **確認画面で「配列」系エラー**  
  - `confirm.blade.php` の配列対応 hidden が本番に反映されているか確認。

---

## 6. 参考

- `AIdocs/オプション商品機能_本番環境マイグレーションSQL.sql`
- `AIdocs/オプション商品_管理画面操作手順_統合版.md`
- `AIdocs/本番環境ファイルアップロード手順_正確版.md`

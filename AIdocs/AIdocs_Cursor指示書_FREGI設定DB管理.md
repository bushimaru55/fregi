# Cursor指示書（AIdocs）: F-REGI接続設定をDBで管理（後から変更可能にする）

最終更新: 2026-01-07  
対象プロジェクト: Fレジ接続（F-REGI）

---

## 0. 目的（What）
F-REGI接続に必要な **SHOPID / 接続パスワード（チェックサム用） / 通知URL / 戻りURL / 環境（本番・テスト）** 等を、**DBに保存して管理画面から後で変更できる**ように実装する。  
また、**変更履歴（監査・ロールバック）** を残す。

---

## 1. 背景・前提（Why / Context）
- 接続パスワードはチェックサム生成に必要であり、運用で更新が発生しうる。
- URL（通知/戻り）も環境変更やドメイン変更などで更新が発生しうる。
- 秘密情報の平文保存は避け、**暗号化して保存**する。

---

## 2. 実装範囲（Scope）
### 2.1 DB（必須）
- 新規テーブル
  - `fregi_configs`（現在有効な設定）
  - `fregi_config_versions`（変更履歴）
- 既存のテナント/契約構造に合わせて **company_id / tenant_id** などの外部キーを付ける（本プロジェクトのデータモデルに合わせて実装）。

### 2.2 管理画面（必須）
- F-REGI設定の一覧・詳細・編集
- 接続パスワード（暗号化項目）は原則 **マスク表示（********）**。
  - 変更する場合のみ入力できる運用にする。
- 「テスト疎通」ボタン（可能なら推奨）
  - DBに保存した設定でチェックサム生成→F-REGIへテストリクエスト
  - 結果表示（成功/失敗、レスポンス概要）

### 2.3 アプリ利用側（必須）
- 既存のF-REGI連携処理は、ハードコード/環境変数依存をやめ、**DBから有効設定を取得**して使う。
- 「有効設定」選択ロジック：
  - `is_active = true` かつ `environment` が一致
  - テナント/会社単位で一意（重複時は例外）

### 2.4 セキュリティ（必須）
- `connect_password` は **暗号化してDB保存**（復号可能である必要がある）
- 復号キーは **環境変数** もしくは **KMS/Secret Manager** に配置
- ログ出力禁止（例外ログ、リクエストログに秘密情報を含めない）
- 権限：管理画面アクセスは最小限

---

## 3. 追加するDB定義（概要）
※ Excel（DB定義書）に追加済みの内容に合わせて実装すること。

### 3.1 `fregi_configs`
- 主なカラム例（実装に合わせて最終調整OK）
  - `id` (PK)
  - `company_id` or `tenant_id`（FK）
  - `environment`（`test` / `prod`）
  - `shop_id`
  - `connect_password_enc`（暗号化済み文字列）
  - `notify_url`
  - `return_url_success`
  - `return_url_cancel`
  - `is_active`（同一company/environmentで1件のみtrue）
  - `created_at`, `updated_at`, `updated_by`

**インデックス/制約**
- 一意制約：`(company_id, environment, is_active)` を工夫して「activeは1件」を担保  
  - DBによっては部分一意（partial unique）が必要。無理ならアプリ側で保証 + 監視。

### 3.2 `fregi_config_versions`
- 変更履歴
  - `id` (PK)
  - `config_id`（FK -> fregi_configs.id）
  - `version_no`
  - `snapshot_json`（変更後スナップショット推奨）
  - `changed_at`, `changed_by`
  - `change_reason`

---

## 4. 暗号化方針（実装ルール）
### 4.1 推奨方式
- AES-GCM（認証付き暗号）
- データはBase64で保存（`connect_password_enc`）

### 4.2 キー管理
- `FREGI_SECRET_KEY`（32byte相当）を環境変数で保持
- 可能なら Secret Manager / KMS に寄せる
- ローカル開発は `.env` に置く（Git管理しない）

### 4.3 実装ルール
- 平文はDBに保存しない
- 復号は「チェックサム生成直前」等、必要な最小範囲で行う
- 平文はログ・例外・返却値に含めない

---

## 5. 実装タスク（ToDo）
### 5.1 モデル/マイグレーション
1. `fregi_configs`, `fregi_config_versions` を作成
2. 既存の会社/契約モデルとのFK接続
3. マイグレーション実行 + ロールバック確認

### 5.2 暗号化ユーティリティ
1. `encrypt_secret(plaintext) -> ciphertext_b64`
2. `decrypt_secret(ciphertext_b64) -> plaintext`
3. 単体テスト
   - 暗号化→復号が一致
   - 異なるキーで復号できない
   - 不正入力で例外を適切に握る（秘密情報を含めない）

### 5.3 設定取得サービス
- `get_active_fregi_config(company_id, environment) -> config`
- 見つからない場合の例外（ユーザー向けメッセージは「設定が未登録」など）
- `is_active` の重複があれば例外 + 通知（監視ログ）

### 5.4 既存決済処理の差し替え
- SHOPID/接続パスワード/URL をDBから参照するように変更
- チェックサム生成部を「復号→生成」に変更

### 5.5 管理画面（CRUD）
- 一覧（company + environment + active表示）
- 詳細
- 編集
  - パスワードはマスク表示
  - 変更時のみ入力欄を有効化
- 更新時処理
  - 旧値との差分を取り、`fregi_config_versions` に保存
  - `is_active` の一意性を保つ（切替時にトランザクションで保証）

### 5.6 疎通テスト（任意だが推奨）
- 「テスト用チェックサム生成」＋最小パラメータでF-REGIへ到達確認
- 返却結果を管理画面に表示（成功/失敗、メッセージ）

---

## 6. 受け入れ条件（Acceptance Criteria）
- 管理画面から F-REGI設定を登録/編集できる
- 接続パスワードはDBに **暗号化保存** され、画面ではマスク表示
- 既存決済フローが DB設定参照で動作する
- 設定変更の履歴が `fregi_config_versions` に残る
- ログに秘密情報が出ない
- `test/prod` の設定を切り替えられる

---

## 7. テスト観点（最低限）
- DB
  - activeが複数にならない（アプリ制御 or 制約）
- 暗号化
  - encrypt/decryptの整合
- 管理画面
  - パスワード未変更時に上書きされない
  - 変更履歴が必ず1件増える
- 決済処理
  - DB設定が無い場合のエラーハンドリング
  - チェックサムが正しく生成される（既知値テスト）

---

## 8. 実装メモ（注意）
- 既存の `.env` や設定ファイルにF-REGIのSHOPID/パスワードが残っていれば削除（または移行後は参照しない）
- マイグレーション時に既存値がある場合は、**移行スクリプト** を用意して `fregi_configs` に投入する（初期登録）。
- 可能なら管理画面の権限を「決済管理者」のみに限定する。

---

## 9. 成果物（Deliverables）
- マイグレーションファイル（2テーブル）
- 暗号化ユーティリティ + 単体テスト
- 設定取得サービス
- 既存決済処理のDB参照化
- 管理画面（CRUD）
- （任意）疎通テスト機能

# 月額課金実装 進捗状況

作成日: 2026-01-13

## 実装方針

月額課金が主な機能であるため、オーソリ処理（authm.cgi）による月額課金機能を実装します。

## 実装ステップと進捗

### Phase 1: データベーススキーマとAPIサービス

#### ✅ 1.1 Contractテーブルにcustomer_idカラムを追加
- **ステータス**: 完了
- **マイグレーション**: `2026_01_13_055400_add_customer_id_to_contracts_table.php`
- **変更内容**: `customer_id` (VARCHAR(20), nullable) カラムを追加

#### ⏳ 1.2 FregiApiServiceにauthm.cgiメソッドを追加
- **ステータス**: 未実装
- **作業内容**: `authorizePayment()` メソッドの実装

#### ⏳ 1.3 FregiApiServiceにsalem.cgiメソッドを追加
- **ステータス**: 未実装
- **作業内容**: `processMonthlySale()` メソッドの実装

### Phase 2: カード情報入力と初回決済

#### ⏳ 2.1 カード情報入力フォームの実装
- **ステータス**: 未実装
- **作業内容**: `contracts.confirm.blade.php` にカード情報入力フィールドを追加

#### ⏳ 2.2 フォームバリデーションの追加
- **ステータス**: 未実装
- **作業内容**: `ContractRequest` にカード情報のバリデーションを追加

#### ⏳ 2.3 ContractControllerの決済処理をauthm.cgiに切り替え
- **ステータス**: 未実装
- **作業内容**: `store()`メソッドをauthm.cgi対応に修正

#### ⏳ 2.4 CUSTOMERIDの生成・保存機能
- **ステータス**: 未実装
- **作業内容**: ContractモデルにCUSTOMERID生成メソッドを追加

### Phase 3: 月次売上処理と通知

#### ⏳ 3.1 月次売上処理コマンドの実装
- **ステータス**: 未実装
- **作業内容**: `ProcessMonthlySales` コマンドの作成

#### ⏳ 3.2 Cronスケジュールの設定
- **ステータス**: 未実装
- **作業内容**: Kernel.phpでスケジュール設定

#### ⏳ 3.3 承認結果通知URLの実装
- **ステータス**: 未実装
- **作業内容**: `/api/fregi/auth-notify` エンドポイントの実装

### Phase 4: テストと調整

#### ⏳ 4.1 テスト環境での動作確認
- **ステータス**: 未実装
- **作業内容**: テスト環境での動作確認

## 次のステップ

1. FregiApiServiceにauthm.cgiメソッドを追加
2. カード情報入力フォームの実装
3. ContractControllerの決済処理をauthm.cgiに切り替え

## 参考資料

- `AIdocs/F-REGI月額課金仕様書（authm.cgi）.md`
- `AIdocs/月額プランの自動引き落としについて.md`
- `AIdocs/月額課金実装計画.md`

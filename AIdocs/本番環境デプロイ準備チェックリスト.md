# 本番環境デプロイ準備チェックリスト

作成日: 2026-01-15

## デプロイ前の準備確認

このチェックリストを使用して、デプロイ前に必要な準備が完了しているか確認してください。

---

## ✅ ローカル環境での準備

### ファイルの準備

- [ ] `composer install --no-dev --optimize-autoloader` を実行して `vendor/` ディレクトリを生成
- [ ] `app/public/index.php.production` が作成されている
- [ ] `app/public/.htaccess.production` が作成されている
- [ ] `AIdocs/本番環境.envテンプレート.txt` を確認

### 情報の準備

- [ ] 本番環境のデータベース接続情報を確認
  - [ ] データベースホスト名
  - [ ] データベース名
  - [ ] データベースユーザー名
  - [ ] データベースパスワード
- [ ] 本番環境のF-REGI設定情報を確認
  - [ ] SHOPID
  - [ ] 接続パスワード
- [ ] ローカル環境の `FREGI_SECRET_KEY` を確認（本番環境でも同じ値を使用）
- [ ] ローカル環境の `APP_KEY` を確認（または本番環境で生成する準備）

---

## ✅ FTP接続情報の確認

- [ ] FTPホスト名
- [ ] FTPユーザー名
- [ ] FTPパスワード
- [ ] FTP接続ポート（通常は21）
- [ ] 接続方式（FTP/FTPS/SFTP）

---

## ✅ アップロード先ディレクトリの確認

- [ ] Laravel本体のアップロード先: `/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/`
- [ ] 公開ディレクトリのアップロード先: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`
- [ ] ディレクトリが存在するか確認（存在しない場合は作成が必要）

---

## ✅ アップロードするファイルの確認

### Laravel本体（`/laravel_billing/` にアップロード）

- [ ] `app/` ディレクトリ
- [ ] `bootstrap/` ディレクトリ
- [ ] `config/` ディレクトリ
- [ ] `database/` ディレクトリ
- [ ] `resources/` ディレクトリ
- [ ] `routes/` ディレクトリ
- [ ] `storage/` ディレクトリ
- [ ] `vendor/` ディレクトリ
- [ ] `.env` ファイル（後で設定）
- [ ] `.gitignore`
- [ ] `artisan`
- [ ] `composer.json`
- [ ] `composer.lock`

### 公開ディレクトリ（`/webroot/billing/` にアップロード）

- [ ] `index.php.production` → `index.php` にリネーム
- [ ] `.htaccess.production` → `.htaccess` にリネーム
- [ ] `css/` ディレクトリ（存在する場合）
- [ ] `js/` ディレクトリ（存在する場合）
- [ ] `fonts/` ディレクトリ（存在する場合）
- [ ] `images/` ディレクトリ（存在する場合）
- [ ] その他の静的ファイル

---

## ✅ デプロイ後の設定確認

### .envファイルの設定

- [ ] `APP_ENV=production` を設定
- [ ] `APP_DEBUG=false` を設定
- [ ] `APP_URL=https://dschatbot.ai/billing` を設定
- [ ] `APP_KEY` を設定（生成またはローカル環境からコピー）
- [ ] データベース接続情報を設定
- [ ] `SESSION_COOKIE=billing_session` を設定
- [ ] `SESSION_PATH=/billing` を設定
- [ ] `FREGI_SECRET_KEY` を設定
- [ ] `FREGI_ENV=prod` を設定（本番環境では `prod` を設定）

### パーミッションの設定

- [ ] `storage/` ディレクトリのパーミッションを `775` に設定
- [ ] `bootstrap/cache/` ディレクトリのパーミッションを `775` に設定
- [ ] 必要に応じて所有者を設定

### データベースのセットアップ

- [ ] **データベースのバックアップを取得**（必須）
- [ ] **オプション製品機能のマイグレーションSQLを実行**（phpMyAdmin）
  - `AIdocs/オプション商品機能_本番環境マイグレーションSQL.sql` を使用
  - 詳細手順: `AIdocs/オプション商品機能_本番環境マイグレーション手順.md` を参照
- [ ] マイグレーション実行後の確認（テーブル構造確認）
- [ ] 管理者アカウントを作成
- [ ] F-REGI設定を登録（管理画面から、`environment=prod` を設定）

---

## ✅ 動作確認

### 基本動作確認

- [ ] `https://dschatbot.ai/webroot/billing/` にアクセスできる
- [ ] 新規申込フォームが表示される
- [ ] 404エラーが発生しない
- [ ] 静的ファイル（CSS、JS、画像）が正しく読み込まれる

### オプション製品機能の確認

- [ ] 公開フォームで製品を選択すると、オプション製品が動的に表示される
- [ ] 管理画面でオプション製品を登録・編集できる
- [ ] ベース製品にオプション製品を紐づけられる
- [ ] APIエンドポイント（`/contract/api/option-products/{id}`）が正常に動作する

### 管理画面の確認

- [ ] `https://dschatbot.ai/billing/login` にアクセスできる
- [ ] ログインが正常に動作する
- [ ] ダッシュボードが表示される
- [ ] 各管理画面が正常に動作する

### エラーの確認

- [ ] エラーログを確認（`storage/logs/laravel.log`）
- [ ] 契約・決済ログを確認（`storage/logs/contract-payment-YYYY-MM-DD.log`）
  - ログファイルの場所: `/httpdocs/webroot/billing/app/storage/logs/`
  - Pleskファイルマネージャーから確認可能
- [ ] Apacheのエラーログを確認（必要に応じて）
- [ ] ブラウザの開発者ツールでエラーがないか確認

---

## トラブルシューティング

問題が発生した場合の確認事項：

- [ ] パーミッションが正しく設定されているか
- [ ] `.env` ファイルが正しく設定されているか
- [ ] `index.php` のパスが正しいか
- [ ] `.htaccess` が正しく配置されているか
- [ ] データベース接続が正常か
- [ ] Apacheの `mod_rewrite` が有効か

---

## 参考資料

- `AIdocs/本番環境セットアップガイド.md` - 詳細なセットアップ手順
- `AIdocs/本番環境デプロイチェックリスト.md` - デプロイ後の確認事項
- `AIdocs/本番環境整合性確認レポート.md` - 整合性確認結果

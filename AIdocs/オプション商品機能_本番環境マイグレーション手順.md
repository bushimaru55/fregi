# オプション商品機能：本番環境マイグレーション手順

作成日: 2026-01-21

## 概要

本番環境（Plesk/レンタルサーバー）ではSSH/CLIが使えないため、マイグレーションを直接実行できません。以下の手順でSQLファイルを実行してください。

---

## 実行方法

### 方法1: phpMyAdminを使用（推奨）

1. **Pleskにログイン**
   - データベース一覧を表示
   - `billing_prod`（本番DB名）を選択

2. **phpMyAdminを開く**
   - 「phpMyAdminで開く」または「Webadmin」をクリック

3. **SQLタブを選択**
   - 左メニューから「SQL」タブをクリック

4. **SQLファイルを実行**
   - SQLファイルの内容（`オプション商品機能_本番環境マイグレーションSQL.sql`）をコピー
   - SQLタブのテキストエリアに貼り付け
   - 「実行」ボタンをクリック

5. **実行結果を確認**
   - エラーがないことを確認
   - 各テーブルの構造を確認（DESCRIBEコマンドを使用）

### 方法2: Pleskのデータベースインポート機能を使用

1. **Pleskにログイン**
   - データベース一覧を表示
   - `billing_prod`を選択

2. **ダンプをインポート**
   - 「ダンプをインポート」をクリック
   - SQLファイルをアップロード
   - 「インポート」をクリック

---

## 実行前の確認事項

### 1. データベースのバックアップ

**重要**: 実行前に必ずデータベースのバックアップを取得してください。

- Plesk > データベース > `billing_prod` > 「エクスポート」
- 完全バックアップをダウンロード

### 2. 既存データの確認

```sql
-- productsテーブルの既存データを確認
SELECT COUNT(*) FROM `products`;

-- contract_itemsテーブルの既存データを確認
SELECT COUNT(*) FROM `contract_items`;
SELECT COUNT(*) FROM `contract_items` WHERE `product_id` IS NOT NULL;

-- contractsテーブルのpayment_idにNULLがないことを確認（実行前）
SELECT COUNT(*) FROM `contracts` WHERE `payment_id` IS NULL;
```

**注意**: `contracts.payment_id`がNOT NULLのままの場合、既存データにNULLがないことを確認してください。

---

## 実行後の確認

### 1. テーブル構造の確認

```sql
-- productsテーブル
DESCRIBE `products`;
-- 確認項目: type, description, is_active, display_order カラムが存在するか

-- contract_itemsテーブル
DESCRIBE `contract_items`;
-- 確認項目: contract_plan_id カラムが存在し、product_id が nullable か

-- contractsテーブル
DESCRIBE `contracts`;
-- 確認項目: payment_id が nullable か
```

### 2. 外部キー制約の確認

```sql
SELECT 
    CONSTRAINT_NAME, 
    TABLE_NAME, 
    COLUMN_NAME, 
    REFERENCED_TABLE_NAME, 
    REFERENCED_COLUMN_NAME 
FROM 
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
WHERE 
    TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME IN ('products', 'contract_items', 'contracts')
    AND REFERENCED_TABLE_NAME IS NOT NULL
ORDER BY TABLE_NAME, CONSTRAINT_NAME;
```

### 3. 既存データの整合性確認

```sql
-- productsテーブルの既存データにtypeが設定されているか確認
SELECT id, code, name, type, is_active FROM `products`;

-- contract_itemsテーブルの既存データを確認
SELECT id, contract_id, contract_plan_id, product_id, product_name 
FROM `contract_items` 
LIMIT 10;
```

---

## エラーが発生した場合

### エラー1: 外部キー制約エラー

**原因**: `contract_items.product_id_foreign`の外部キー制約が既に存在しない可能性

**対処**: 
- SQLファイルの`DROP FOREIGN KEY`部分をコピーして実行
- エラーメッセージで実際の制約名を確認し、適切な制約名に変更

```sql
-- 実際の制約名を確認
SELECT 
    CONSTRAINT_NAME 
FROM 
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE 
WHERE 
    TABLE_SCHEMA = DATABASE() 
    AND TABLE_NAME = 'contract_items' 
    AND COLUMN_NAME = 'product_id' 
    AND REFERENCED_TABLE_NAME IS NOT NULL;
```

### エラー2: カラムが既に存在する

**原因**: 同じマイグレーションが既に実行されている可能性

**対処**: 
- エラーメッセージで既に存在するカラムを確認
- そのカラムを追加するSQLをスキップして実行

### エラー3: payment_idのNOT NULL制約エラー

**原因**: `contracts`テーブルに既に`payment_id`がNULLのレコードが存在する可能性

**対処**: 
- 実行前の確認SQLでNULLレコードを確認
- NULLレコードがある場合は、問題ありません（既にnullableになっている）

---

## ロールバック手順（必要な場合）

### 1. データベースをバックアップから復元

- Plesk > データベース > `billing_prod` > 「ダンプをインポート」
- 実行前のバックアップをインポート

### 2. 手動でロールバック（SQL）

```sql
-- 注意: 本番環境では通常は実行しないでください

-- contractsテーブル
ALTER TABLE `contracts` 
MODIFY COLUMN `payment_id` BIGINT UNSIGNED NOT NULL;

-- contract_itemsテーブル
ALTER TABLE `contract_items` 
DROP INDEX `contract_items_contract_plan_id_index`;
ALTER TABLE `contract_items` 
DROP FOREIGN KEY `contract_items_contract_plan_id_foreign`;
ALTER TABLE `contract_items` 
DROP COLUMN `contract_plan_id`;
ALTER TABLE `contract_items` 
DROP FOREIGN KEY `contract_items_product_id_foreign`;
ALTER TABLE `contract_items` 
MODIFY COLUMN `product_id` BIGINT UNSIGNED NOT NULL;
ALTER TABLE `contract_items` 
ADD CONSTRAINT `contract_items_product_id_foreign` 
FOREIGN KEY (`product_id`) 
REFERENCES `products` (`id`) 
ON DELETE RESTRICT;

-- productsテーブル
ALTER TABLE `products` 
DROP INDEX `products_is_active_type_display_order_index`;
ALTER TABLE `products` 
DROP COLUMN `display_order`;
ALTER TABLE `products` 
DROP COLUMN `is_active`;
ALTER TABLE `products` 
DROP COLUMN `description`;
ALTER TABLE `products` 
DROP COLUMN `type`;
```

---

## 実行タイミング

- **推奨**: メンテナンス時間帯（利用者が少ない時間）
- **必須**: データベースのバックアップ取得後

---

## 参考

- **SQLファイル**: `オプション商品機能_本番環境マイグレーションSQL.sql`
- **実装仕様書**: `オプション商品機能_実装仕様.md`
- **deploy_rules.md**: 本番環境のデプロイルール

---

作成日: 2026-01-21
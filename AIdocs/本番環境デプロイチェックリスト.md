# 本番環境デプロイチェックリスト

作成日: 2026-01-15

## 前提条件

- 現在ドメイン全体にBasic認証がかかっている
- まずはシステムが正常に動作することを優先
- セキュリティ設定の改善は後で対応

---

## デプロイ前の確認事項

### 1. ファイルの配置確認

- [ ] Laravel本体が `/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/` に配置されている
- [ ] `public/` ディレクトリの内容が `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/` に配置されている
- [ ] `webroot/billing/index.php` が正しく設定されている（本体へのパス参照）

### 2. 環境変数（`.env`）の確認

- [ ] `APP_ENV=production` が設定されている
- [ ] `APP_DEBUG=false` が設定されている（動作確認後はfalse推奨）
- [ ] `APP_URL=https://dschatbot.ai/billing` が設定されている
- [ ] データベース接続情報が正しく設定されている
- [ ] `FREGI_SECRET_KEY` が設定されている
- [ ] `SESSION_COOKIE=billing_session` が設定されている
- [ ] `SESSION_PATH=/billing` が設定されている

### 3. データベースの確認

- [ ] マイグレーションが適用されている
- [ ] 管理者アカウントが作成されている
- [ ] F-REGI設定が登録されている（`environment=prod`）

---

## デプロイ後の動作確認

### 1. 基本動作確認

- [ ] `https://dschatbot.ai/billing/` にアクセスできる
- [ ] 新規申込フォームが表示される
- [ ] 404エラーが発生しない
- [ ] 静的ファイル（CSS、JS、画像）が正しく読み込まれる

### 2. 管理画面の確認

- [ ] `https://dschatbot.ai/billing/login` にアクセスできる
- [ ] ログインが正常に動作する
- [ ] ダッシュボードが表示される
- [ ] 各管理画面が正常に動作する

### 3. ルーティングの確認

- [ ] 公開ページのルーティングが正しく動作する
- [ ] 管理画面のルーティングが正しく動作する
- [ ] APIエンドポイントが正しく動作する

### 4. データベース接続の確認

- [ ] データベース接続が正常に動作する
- [ ] データの読み書きが正常に動作する

### 5. F-REGI設定の確認

- [ ] 管理画面からF-REGI設定を確認できる
- [ ] `environment=prod` の設定が存在する
- [ ] 設定値が正しく保存されている

---

## 問題が発生した場合の確認事項

### 1. 404エラーが発生する場合

- [ ] `.htaccess` ファイルが正しく配置されている
- [ ] Apacheの `mod_rewrite` が有効になっている
- [ ] `AllowOverride` が `All` または `FileInfo` に設定されている
- [ ] `RewriteBase /billing/` を追加してみる

### 2. データベース接続エラーが発生する場合

- [ ] `.env` のデータベース接続情報を確認
- [ ] データベースサーバーが起動している
- [ ] データベースのユーザー名・パスワードが正しい
- [ ] データベース名が正しい

### 3. 静的ファイルが読み込まれない場合

- [ ] ファイルのパーミッションを確認
- [ ] ファイルパスが正しいか確認
- [ ] Apacheの設定を確認

### 4. セッションが動作しない場合

- [ ] `storage/framework/sessions/` のパーミッションを確認
- [ ] `.env` の `SESSION_COOKIE` と `SESSION_PATH` を確認

---

## セキュリティ設定の改善（後で対応）

### 優先度: 中（システムが正常に動作することを確認してから対応）

#### 1. PHP設定の修正

- [ ] `display_errors = Off` に変更
- [ ] `display_startup_errors = Off` に変更
- [ ] `log_errors = On` に変更
- [ ] `error_log` を設定

#### 2. セッションセキュリティ設定

- [ ] `session.cookie_httponly = 1` に変更
- [ ] `session.cookie_secure = 1` に変更
- [ ] `session.use_strict_mode = 1` に変更

#### 3. その他のセキュリティ設定

- [ ] `APP_DEBUG=false` が設定されている
- [ ] エラーログの監視を設定
- [ ] アクセスログの監視を設定

---

## 参考資料

- `AIdocs/本番環境整合性確認レポート.md`
- `AIdocs/Apache設定確認レポート.md`
- `AIdocs/AIdocs_Cursor指示書_Billingアプリ_ローカルDocker開始.md`

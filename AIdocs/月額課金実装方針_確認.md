# 月額課金実装方針の確認

作成日: 2026-01-13

## ユーザーの要望

1. **カード情報はF-REGI側で管理**
   - カード情報を自社DBに保存する必要はない
   - F-REGIの管理画面で管理を行う

2. **自社システムでの対応範囲**
   - 決済画面と処理のみ対応
   - カード情報の直接入力は不要

## 確認事項

### F-REGIの仕様について

#### リダイレクト決済（compsettleapply.cgi）
- ユーザーをF-REGIの決済画面にリダイレクト
- F-REGI画面でカード情報を入力
- **カード情報はF-REGI側で管理される**
- 月額課金の自動引き落としは不可（MONTHLYMODEパラメータが使用できない）

#### オーソリ処理（authm.cgi）
- **直接APIでカード情報を送信する方式**
- カード情報（PAN1-4, CARDEXPIRY1-2, CARDNAME等）をパラメータで送信
- `MONTHLY=1` を指定すると、顧客としてF-REGI側に登録される
- `CUSTOMERID` を使用して後続の月次売上処理（salem.cgi）を実行
- **カード情報はF-REGI側で管理される（CUSTOMERIDで参照）**

## 実装方針の見直し

### ✅ 正しい理解

1. **カード情報の保存**
   - **自社DBにはカード情報を保存しない**
   - **CUSTOMERIDのみを保存する**
   - カード情報はF-REGI側で管理される

2. **カード情報入力**
   - オーソリ処理（authm.cgi）を使用する場合、**カード情報を直接APIで送信する必要がある**
   - ただし、ユーザーの要望として「F-REGI側で管理し、自社では決済画面と処理のみ対応」とのこと

### ⚠️ 重要な確認が必要

**オーソリ処理（authm.cgi）を使用する場合、カード情報を自社サイトで入力する必要があります。**

これは以下の2つの選択肢があります：

#### 選択肢A: オーソリ処理（authm.cgi）を使用する
- **カード情報を自社サイトで入力する必要がある**
- カード情報をAPIパラメータで直接送信
- セキュリティ対応（PCI DSS準拠など）が必要
- 月額課金の自動引き落としが可能

#### 選択肢B: リダイレクト決済（compsettleapply.cgi）を継続使用する
- **カード情報はF-REGI画面で入力**
- カード情報を自社サイトで扱わない
- セキュリティ負担が少ない
- **ただし、月額課金の自動引き落としは実装できない**

## 質問

ユーザーの要望「F-REGI側でカード情報を管理し、自社では決済画面と処理のみ対応」を実現するためには：

1. **オーソリ処理（authm.cgi）を使用する場合**
   - 初回のみ、自社サイトでカード情報を入力する必要がある
   - その後、CUSTOMERIDでF-REGI側のカード情報を参照
   - この方式で進めてよろしいでしょうか？

2. **リダイレクト決済（compsettleapply.cgi）を継続使用する場合**
   - カード情報は常にF-REGI画面で入力
   - ただし、月額課金の自動引き落としは実装できない
   - この方式でよろしいでしょうか？

3. **F-REGIの機能確認**
   - F-REGI側で既にカード情報が管理されている場合、オーソリ処理でCUSTOMERIDのみを指定して月額課金を開始できるか？
   - それとも、初回のオーソリ処理でカード情報を送信する必要があるか？

## 推奨される確認手順

1. F-REGI管理画面で既存の顧客情報・カード情報が管理されているか確認
2. 既存のCUSTOMERIDを使用して月額課金を開始できるか確認
3. オーソリ処理（authm.cgi）でCUSTOMERIDのみを指定できるか確認

## 結論

**カード情報を自社DBに保存する必要はありません。CUSTOMERIDのみを保存すれば十分です。**

ただし、オーソリ処理（authm.cgi）を使用する場合、初回のみカード情報を自社サイトで入力する必要がある可能性があります。この点について、F-REGIの仕様を確認する必要があります。

# 月額課金実装方針の確認結果

作成日: 2026-01-13

## ユーザーの要望

1. **カード情報はF-REGI側で管理**
   - カード情報を自社DBに保存する必要はない
   - F-REGIの管理画面で管理を行う

2. **自社システムでの対応範囲**
   - 決済画面と処理のみ対応
   - カード情報の直接入力は不要

## 重要な確認結果

### ✅ 正しい理解

1. **カード情報の保存**
   - **自社DBにはカード情報を保存しない**
   - **CUSTOMERIDのみを保存する**
   - カード情報はF-REGI側で管理される

2. **月次売上処理（salem.cgi）**
   - **CUSTOMERIDのみを指定**して月次売上処理を実行
   - カード情報は不要（F-REGI側で管理されている）
   - **ユーザーの要望と完全に一致しています**

### ⚠️ 確認が必要な点

**初回の顧客登録について：**

F-REGIの仕様書によると：
- **月次売上処理（salem.cgi）**: CUSTOMERIDのみを指定（カード情報不要）✅
- **オーソリ処理（authm.cgi）新規顧客登録**: カード情報（PAN1-4等）を送信する必要がある
- **オーソリ処理（authm.cgi）既存顧客使用**: CUSTOMERIDのみを指定（カード情報不要）✅

## 実装方針（ユーザーの要望に合わせた場合）

### 前提条件の確認が必要

1. **F-REGI管理画面で既に顧客・カード情報が登録されている場合**
   - 既存のCUSTOMERIDを使用して月額課金を開始できる
   - オーソリ処理（authm.cgi）でCUSTOMERIDのみを指定
   - **カード情報入力は不要**
   - 月次売上処理（salem.cgi）でCUSTOMERIDを指定
   - **ユーザーの要望と一致**

2. **新規顧客の場合**
   - F-REGI管理画面で事前に顧客登録を行う？
   - または、別の方法で顧客登録を行う？

## 推奨される実装方針

### 方針: F-REGI管理画面で顧客情報を管理

1. **初回決済（既存顧客の場合）**
   - F-REGI管理画面で既に顧客・カード情報が登録されている
   - 既存のCUSTOMERIDを取得・使用
   - オーソリ処理（authm.cgi）でCUSTOMERIDのみを指定（カード情報不要）
   - または、リダイレクト決済（compsettleapply.cgi）を使用してF-REGI画面でカード情報入力

2. **月次売上処理（salem.cgi）**
   - CUSTOMERIDのみを指定して月次売上処理を実行
   - カード情報は不要
   - **ユーザーの要望と一致**

3. **自社DB**
   - CUSTOMERIDのみを保存
   - カード情報は保存しない

## 実装内容（要望に合わせた場合）

### 必要な実装

1. **CUSTOMERIDの保存機能**
   - Contractテーブルにcustomer_idカラムを追加 ✅（完了）
   - CUSTOMERIDを保存・取得する機能

2. **月次売上処理（salem.cgi）APIサービスの実装**
   - CUSTOMERIDのみを指定して月次売上処理を実行
   - カード情報は不要

3. **月次売上処理のCronスケジュール設定**
   - 毎月1日の深夜に実行
   - CUSTOMERIDを使用して月次売上処理を実行

4. **初回決済処理**
   - F-REGI管理画面で既に顧客登録されている前提
   - CUSTOMERIDのみを使用
   - または、リダイレクト決済（compsettleapply.cgi）を使用してF-REGI画面でカード情報入力

### 不要な実装

- ❌ カード情報入力フォーム（自社サイト）
- ❌ カード情報のDB保存
- ❌ オーソリ処理（authm.cgi）でのカード情報送信（既存顧客の場合）

## 質問

ユーザーの環境では：

1. **F-REGI管理画面で既に顧客・カード情報が登録されていますか？**
   - 既に登録されている場合：CUSTOMERIDのみを使用すればよい

2. **初回決済時のフロー**
   - F-REGI管理画面で事前に顧客登録 → CUSTOMERIDのみを使用
   - または、リダイレクト決済（compsettleapply.cgi）を使用してF-REGI画面でカード情報入力 → その後、CUSTOMERIDを取得して月次売上処理に使用

3. **CUSTOMERIDの取得方法**
   - F-REGI管理画面から取得？
   - または、リダイレクト決済の結果から取得？

## 結論

**カード情報を自社DBに保存する必要はありません。CUSTOMERIDのみを保存すれば十分です。**

月次売上処理（salem.cgi）では、CUSTOMERIDのみを指定すればよく、ユーザーの要望と一致しています。

実装は以下のようになります：
- CUSTOMERIDのみをDBに保存
- 月次売上処理（salem.cgi）でCUSTOMERIDを指定
- カード情報入力フォームは不要

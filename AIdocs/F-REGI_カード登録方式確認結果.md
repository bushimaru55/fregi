# F-REGI カード登録方式（AUTOREGISTER）確認結果

確認日時: 2026-01-13

## 確認内容

F-REGIのカード登録方式（AUTOREGISTERパラメータ）が現在どのように設定されているかを確認しました。

## 確認結果

### ✅ **現在のカード登録方式は「選択登録」（AUTOREGISTER = 0）です**

## 実装状況

### 1. 現在の実装

現在の実装では、**AUTOREGISTERパラメータを送信していません**（省略しています）。

**ContractController.php（実装コード）:**
```php
// 発行受付APIのパラメータを構築
// 注意: AUTOREGISTERは省略可能（省略時はF-REGI側で「0: 選択登録」が設定される）
// テスト環境では送信しない方が良いため、省略
$apiParams = [
    'SHOPID' => $fregiConfig->shopid,
    'ID' => $payment->orderid, // 伝票番号（最大20文字）
    'PAY' => (string)$payment->amount, // 金額
];
// AUTOREGISTERパラメータは含まれていない
```

**FregiApiService.php（コメント）:**
```php
// AUTOREGISTERは省略可能（省略時はF-REGI側で「0: 選択登録」が設定される）
// パラメータが指定されている場合のみ送信
// 注意: テスト環境によってはAUTOREGISTERを送信しない方が良い場合がある
```

### 2. AUTOREGISTERパラメータの仕様

F-REGIのAUTOREGISTERパラメータには、以下の2つの値があります：

- **`0`（または省略）**: **選択登録**
  - ユーザーがカード情報を入力する際に、「カード情報を登録する」かどうかを選択できる
  - ユーザーの意思でカード情報を登録するかどうかを決定する

- **`1`**: **自動登録**
  - カード情報が自動的に登録される
  - ユーザーの選択に関わらず、カード情報が登録される

### 3. 省略時の動作

**AUTOREGISTERパラメータを省略した場合、F-REGI側で自動的に「0: 選択登録」が設定されます。**

つまり、現在の実装では：
- AUTOREGISTERパラメータを送信していない（省略）
- F-REGI側で「0: 選択登録」がデフォルトとして適用される
- ユーザーがカード情報を入力する際に、カード情報を登録するかどうかを選択できる

## 任意パラメータかどうか

### ✅ **AUTOREGISTERは任意パラメータです**

- 必須パラメータではない
- 省略可能
- 省略時は「0: 選択登録」がデフォルトとして適用される

## サンプルプログラムの確認

F-REGIから提供されているサンプルプログラム（`compsettleapply_sample.php`）にも、AUTOREGISTERパラメータは含まれていません。

サンプルプログラムに含まれるパラメータ：
- `SHOPID` - 必須
- `ID` - 必須
- `PAY` - 必須
- `USERNAME1`, `USERNAME2` - 任意
- `USERNAMEKANA1`, `USERNAMEKANA2` - 任意
- `USERTEL` - 任意
- `ITEMTITLE`, `ITEMNAME`, `ITEMNAMEKANA` - 任意
- `EXPIRE` - 任意
- `CHARCODE` - 任意
- `QUIET` - 任意

**AUTOREGISTERは含まれていません。**

## 実装の経緯

過去の実装では、AUTOREGISTERパラメータを送信しようとしていた可能性がありますが、テスト環境でエラーが発生したため、**パラメータを省略する実装に変更**された経緯があります。

コメントに「テスト環境によってはAUTOREGISTERを送信しない方が良い場合がある」と記載されていることからも、この経緯が推測できます。

## まとめ

| 項目 | 内容 |
|------|------|
| **現在の設定** | 選択登録（AUTOREGISTER = 0、デフォルト） |
| **パラメータ送信** | 送信していない（省略） |
| **必須/任意** | 任意パラメータ |
| **省略時の動作** | F-REGI側で「0: 選択登録」が自動的に設定される |
| **ユーザー体験** | ユーザーがカード情報を登録するかどうかを選択できる |

## 推奨事項

### 現在の実装で問題ありません

- AUTOREGISTERパラメータを省略することで、「選択登録」が適用される
- ユーザーがカード情報を登録するかどうかを選択できるため、ユーザーフレンドリー
- テスト環境でも問題なく動作している

### 自動登録に変更する場合

もし将来的に「自動登録」（AUTOREGISTER = 1）に変更する必要がある場合は、以下のようにパラメータを追加できます：

```php
$apiParams = [
    'SHOPID' => $fregiConfig->shopid,
    'ID' => $payment->orderid,
    'PAY' => (string)$payment->amount,
    'AUTOREGISTER' => '1', // 自動登録を指定
];
```

ただし、自動登録にすると、ユーザーの意思に関わらずカード情報が登録されるため、**プライバシーポリシーや利用規約で明示する必要があります**。

---

作成日: 2026-01-13

# Phase 2 テスト実行手順（修正版 v2）

作成日: 2026-01-13  
修正: 仕様要件に基づきテスト項目を追加

## テスト環境情報

### F-REGI設定
- **SHOPID**: 23034 ✅ 確認済み
- **環境**: test ✅ 確認済み

### テスト用プラン
- **一回限りプラン**: ID 21 - テスト用 一回限りプラン (¥10,000) ✅ 確認済み
- **月額課金プラン**: ID 22 - テスト用 月額課金プラン (¥5,000) ✅ 確認済み

### テストカード情報
- **カード番号**: 4980-1111-1111-1111
- **有効期限**: 10/30（未来年月）
- **カード名義**: 任意（例: TEST USER）
- **セキュリティコード**: 111（承認成功）または 123（承認失敗）

---

## テスト0: 公開ページの基本確認

### テスト0-1: ログイン不要の確認
**目的**: 公開ページがログイン不要でアクセス可能であることを確認

**手順**:
1. シークレットウィンドウまたは別ブラウザで以下のURLにアクセス:
   - `http://localhost:8080/billing/contract/create`
2. ログイン画面にリダイレクトされないことを確認
3. 申込フォームが表示されることを確認

**期待結果**: ✅ ログイン画面に飛ばされず、申込フォームが表示される

---

## テスト1: 商品ID付きURLでの固定表示

### テスト1-1: 単一プランの固定表示（plansパラメータ）
**目的**: URLパラメータで指定されたプランのみが表示されることを確認

**手順**:
1. 以下のURLにアクセス（プランID: 21）:
   - `http://localhost:8080/billing/contract/create?plans=21`
2. 画面上に「テスト用 一回限りプラン（ID: 21）」のみが表示されることを確認
3. 他のプラン（例: ID 22）が表示されないことを確認

**期待結果**: ✅ 指定されたプラン（ID: 21）のみが表示される

### テスト1-2: 複数プランの表示（plansパラメータ、複数指定）
**目的**: 複数プランを指定した場合の動作を確認

**手順**:
1. 以下のURLにアクセス（プランID: 21, 22）:
   - `http://localhost:8080/billing/contract/create?plans=21,22`
2. 画面上に「テスト用 一回限りプラン（ID: 21）」と「テスト用 月額課金プラン（ID: 22）」が表示されることを確認
3. 指定されていないプランが表示されないことを確認

**期待結果**: ✅ 指定されたプラン（ID: 21, 22）のみが表示される

### テスト1-3: パラメータなしの場合
**目的**: パラメータなしの場合は全プランが表示されることを確認

**手順**:
1. 以下のURLにアクセス（パラメータなし）:
   - `http://localhost:8080/billing/contract/create`
2. 全てのアクティブなプランが表示されることを確認

**期待結果**: ✅ 全てのアクティブなプランが表示される

---

## テスト2: 改ざん/存在しないIDのテスト

### テスト2-1: 存在しないプランIDでアクセス
**目的**: 存在しないプランIDでアクセスした場合の動作を確認

**手順**:
1. 以下のURLにアクセス（存在しないプランID: 9999）:
   - `http://localhost:8080/billing/contract/create?plans=9999`
2. エラー画面（404）が表示されるか、または「指定されたプランが見つかりません」というメッセージが表示されることを確認

**期待結果**: ✅ 404エラーまたはエラーメッセージが表示される（空のフォームが表示されるのは不適切）

### テスト2-2: 非公開プランIDでアクセス
**目的**: 非公開（is_active=false）プランIDでアクセスした場合の動作を確認

**手順**:
1. 管理画面で非公開プランを確認（is_active=false のプランIDを確認）
2. 以下のURLにアクセス（非公開プランIDを指定）:
   - `http://localhost:8080/billing/contract/create?plans={非公開プランID}`
3. エラー画面（404）が表示されるか、または「指定されたプランが見つかりません」というメッセージが表示されることを確認

**期待結果**: ✅ 404エラーまたはエラーメッセージが表示される（非公開プランは表示されない）

### テスト2-3: 不正なパラメータ値でアクセス
**目的**: 不正なパラメータ値（文字列など）でアクセスした場合の動作を確認

**手順**:
1. 以下のURLにアクセス（不正なパラメータ値）:
   - `http://localhost:8080/billing/contract/create?plans=abc`
   - `http://localhost:8080/billing/contract/create?plans=21,abc`
2. エラーが発生するか、または適切に処理されることを確認

**期待結果**: ✅ エラーハンドリングが適切に動作する（空のフォームが表示されるのは不適切）

---

## テスト3: カード情報入力フォームの表示確認

### 手順
1. 公開申込フォームにアクセス: `http://localhost:8080/billing/contract/create?plans=21`
2. 必須項目を入力：
   - 会社名: 「テスト会社株式会社」
   - 担当者名: 「テスト 太郎」
   - メールアドレス: `test@example.com`
   - 電話番号: `03-1234-5678`
   - 契約プラン: 「テスト用 一回限りプラン」を選択（ID: 21）または固定表示
   - 利用開始希望日: 今日以降の日付を選択
   - 利用規約への同意: チェック
3. 「確認画面へ」ボタンをクリック
4. 確認画面でカード情報入力フォームが表示されることを確認：
   - カード番号入力フィールド（PAN1-4、4桁ずつ）
   - 有効期限入力（月：ドロップダウン、年：テキスト入力）
   - カード名義入力フィールド
   - セキュリティコード入力フィールド

**期待結果**: ✅ カード情報入力フォームが正しく表示される

---

## テスト4: フォームバリデーションの確認

### 手順
1. 確認画面でカード情報を入力：
   - カード番号を3桁で入力 → エラーが表示されるか確認
   - 有効期限（月）を選択せずに送信 → エラーが表示されるか確認
   - カード名義を入力せずに送信 → エラーが表示されるか確認

**期待結果**: ✅ 各フィールドのバリデーションエラーが正しく表示される

---

## テスト5: 一回限り決済のテスト

### 手順
1. 公開申込フォームにアクセス: `http://localhost:8080/billing/contract/create?plans=21`
2. 必須項目を入力（テスト3と同じ）
3. 「確認画面へ」ボタンをクリック
4. 確認画面でカード情報を入力：
   - カード番号: 4980-1111-1111-1111
   - 有効期限（月）: 10
   - 有効期限（年）: 30
   - カード名義: TEST USER
   - セキュリティコード: 111
5. 「決済へ進む」ボタンをクリック
6. 正常に完了画面にリダイレクトされることを確認

**期待結果**: ✅ 正常に決済が完了し、完了画面が表示される

---

## テスト6: 月額課金決済のテスト

### 手順
1. 公開申込フォームにアクセス: `http://localhost:8080/billing/contract/create?plans=22`
2. 必須項目を入力（テスト3と同じ）
3. 「確認画面へ」ボタンをクリック
4. 確認画面でカード情報を入力：
   - カード番号: 4980-1111-1111-1111
   - 有効期限（月）: 10
   - 有効期限（年）: 30
   - カード名義: TEST USER
   - セキュリティコード: 111
5. 「決済へ進む」ボタンをクリック
6. 正常に完了画面にリダイレクトされることを確認
7. データベースで `customer_id` が保存されていることを確認

**期待結果**: ✅ 正常に決済が完了し、完了画面が表示される。`customer_id` が保存される。

---

## テスト7: エラーハンドリングのテスト

### 手順
1. 確認画面で無効なカード情報を入力：
   - カード番号: 4980-1111-1111-1111
   - 有効期限（月）: 10
   - 有効期限（年）: 30
   - カード名義: TEST USER
   - セキュリティコード: 123（承認失敗用）
2. 「決済へ進む」ボタンをクリック
3. エラーメッセージが表示されることを確認
4. 確認画面に戻ることを確認

**期待結果**: ✅ エラーメッセージが表示され、確認画面に戻る

---

## テスト8: 決済戻りの検証（冪等性）

### テスト8-1: F-REGI戻りURL処理の確認
**目的**: F-REGIから戻りURL処理が正しく動作することを確認

**手順**:
1. テスト5またはテスト6を実行して決済を完了
2. データベースで決済情報を確認:
   ```sql
   SELECT id, contract_id, status, receiptno, slipno, orderid, settleno 
   FROM payments 
   ORDER BY id DESC 
   LIMIT 1;
   ```
3. 決済ステータスが `completed` または `paid` になっていることを確認
4. `receiptno`（承認番号）と `slipno`（取引番号）が保存されていることを確認

**期待結果**: ✅ 決済情報が正しく更新される

### テスト8-2: 冪等性の確認（二重更新防止）
**目的**: 同一通知が複数回来た場合でも二重更新・二重決済にならないことを確認

**注意**: このテストは実装の確認が主目的。実際のF-REGIからの二重通知をシミュレートするのは困難なため、コードレビューで確認する。

**確認項目**:
- `FregiPaymentService::processNotify()` に冪等性チェックがあること（109-111行目）
- 既に確定済み（`paid`, `failed`, `canceled`）の場合は更新しないこと

**期待結果**: ✅ 冪等性チェックが実装されている

---

## データベース確認（テスト後）

```sql
-- 最新の契約を確認
SELECT id, contract_plan_id, status, customer_id, billing_type, created_at 
FROM contracts 
ORDER BY id DESC 
LIMIT 5;

-- 最新の決済を確認
SELECT id, contract_id, status, receiptno, slipno, orderid, settleno, created_at 
FROM payments 
ORDER BY id DESC 
LIMIT 5;

-- 月額課金の場合、customer_idが保存されているか確認
SELECT id, customer_id, status, billing_type 
FROM contracts 
WHERE billing_type = 'monthly' 
ORDER BY id DESC 
LIMIT 1;
```

---

## ログ確認

```bash
cd /Users/dfn4459wgl/Desktop/billing/app
docker-compose exec app tail -f storage/logs/contract_payment.log
# または
docker-compose exec app tail -f storage/logs/laravel.log
```

---

## まとめ

### 追加されたテスト項目
1. ✅ **ログイン不要の確認**（テスト0-1）
2. ✅ **商品ID付きURLでの固定表示**（テスト1-1, 1-2, 1-3）
3. ✅ **改ざん/存在しないIDのテスト**（テスト2-1, 2-2, 2-3）
4. ✅ **決済戻りの検証（冪等性）**（テスト8-1, 8-2）

### 確認事項
- ✅ 公開URLは `/contract/create`（`/admin` 配下ではない）
- ✅ 公開URLに `auth` ミドルウェアは付いていない（ログイン不要）
- ✅ 管理画面は商品/注文参照のみ（`/admin/contract-plans`, `/admin/contracts`）

### 実装上の注意点
- ⚠️ 現在の実装では、存在しないプランIDでアクセスした場合、空のフォームが表示される可能性がある（エラーハンドリングの改善が必要）
- ⚠️ `plan_id`（単数）パラメータには現在対応していない（`plans`（複数）パラメータのみ対応）

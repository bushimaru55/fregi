# 本番環境デプロイ手順書（最新版）

作成日: 2026-01-21  
対象: オプション製品機能対応版

---

## デプロイ前の準備

### 1. デプロイパッケージの確認

**重要**: デプロイパッケージ（`deploy/webroot_billing/`）が最新のコードを反映していることを確認してください。

**確認項目**:
- [ ] `app/resources/views/contracts/create.blade.php` に最新の修正が含まれているか
- [ ] `app/app/Http/Controllers/ContractController.php` に `getOptionProducts()` メソッドが含まれているか
- [ ] `app/routes/web.php` に `contract.api.option-products` ルートが含まれているか

**デプロイパッケージが古い場合**: デプロイパッケージを再生成してください。

### 2. データベースバックアップの取得

**必須**: マイグレーション実行前に必ずデータベースのバックアップを取得してください。

1. Pleskにログイン
2. データベース一覧から `billing_prod` を選択
3. 「エクスポート」をクリック
4. 完全バックアップをダウンロード

### 3. .envファイルの準備

`AIdocs/本番環境.envテンプレート.txt` をコピーして `.env` ファイルを作成し、以下の値を設定：

**必須設定**:
- `APP_KEY`: 生成済みの値
- `FREGI_SECRET_KEY`: ローカル環境と同じ値
- `FREGI_ENV=prod`: 本番環境では `prod` を設定
- データベース接続情報

---

## デプロイ手順

### ステップ1: マイグレーションSQLの実行

1. **Pleskにログイン**
   - データベース一覧から `billing_prod` を選択

2. **phpMyAdminを開く**
   - 「phpMyAdminで開く」をクリック

3. **SQLタブを選択**
   - 左メニューから「SQL」タブをクリック

4. **SQLファイルを実行**
   - `AIdocs/オプション商品機能_本番環境マイグレーションSQL.sql` の内容をコピー
   - SQLタブのテキストエリアに貼り付け
   - 「実行」ボタンをクリック

5. **実行結果を確認**
   - エラーがないことを確認
   - テーブル構造を確認（DESCRIBEコマンドを使用）

**詳細手順**: `AIdocs/オプション商品機能_本番環境マイグレーション手順.md` を参照

### ステップ2: ファイルのアップロード（FTP）

#### 2.1 Laravel本体のアップロード

**アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/`

**アップロードする内容**:
- `app/` ディレクトリ（`public/` を除く）
- `bootstrap/`, `config/`, `database/`, `resources/`, `routes/`
- `storage/`（ディレクトリ構造のみ）
- `vendor/`
- `.env`（本番環境用）
- `artisan`, `composer.json`, `composer.lock`

#### 2.2 公開ディレクトリのアップロード

**アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`

**アップロードする内容**:
- `index.production.php` → `index.php` にリネーム
- `.htaccess`
- `css/`, `js/`, `build/` ディレクトリ

### ステップ3: パーミッションの設定

以下のパーミッションを設定：

- `storage/` ディレクトリ: `775`
- `bootstrap/cache/` ディレクトリ: `775`
- `storage/logs/` ディレクトリ: `775`

### ステップ4: Config Cacheのクリア（必要に応じて）

`/httpdocs/webroot/billing/app/bootstrap/cache/config.php` を削除すると、次回アクセス時に自動的に再生成されます。

---

## デプロイ後の確認

### 1. 基本動作確認

- [ ] `https://dschatbot.ai/webroot/billing/contract/create` にアクセスできる
- [ ] 新規申込フォームが表示される
- [ ] 静的ファイル（CSS、JS）が正しく読み込まれる

### 2. オプション製品機能の確認

- [ ] 製品（契約プラン）を選択すると、オプション製品が動的に表示される
- [ ] ブラウザの開発者ツール（コンソール）でエラーがないことを確認
- [ ] 管理画面でオプション製品を登録・編集できる
- [ ] ベース製品にオプション製品を紐づけられる

### 3. ログの確認

- [ ] ログファイルが作成されている（`/httpdocs/webroot/billing/app/storage/logs/contract-payment-YYYY-MM-DD.log`）
- [ ] エラーログに問題がない
- [ ] オプション製品取得APIのログを確認

**ログ確認方法**: `AIdocs/ログ機能説明.md` を参照

---

## トラブルシューティング

### オプション製品が表示されない場合

1. **ブラウザの開発者ツールを確認**
   - コンソールタブでエラーを確認
   - ネットワークタブで `/contract/api/option-products/{id}` へのリクエストを確認
   - ステータスコードが 200 OK か確認

2. **ログファイルを確認**
   - `contract-payment-YYYY-MM-DD.log` で `オプション製品取得エラー` を検索
   - エラーメッセージとスタックトレースを確認

3. **デプロイパッケージを確認**
   - `deploy/webroot_billing/app/routes/web.php` に `contract.api.option-products` ルートが含まれているか
   - `deploy/webroot_billing/app/app/Http/Controllers/ContractController.php` に `getOptionProducts()` メソッドが含まれているか

### その他のエラー

詳細は `AIdocs/FTPデプロイ手順書.md` の「トラブルシューティング」セクションを参照してください。

---

## 参考資料

- `AIdocs/FTPデプロイ手順書.md` - 詳細なデプロイ手順
- `AIdocs/本番環境デプロイ準備チェックリスト.md` - デプロイ前の準備確認
- `AIdocs/本番環境デプロイチェックリスト.md` - デプロイ後の確認事項
- `AIdocs/オプション商品機能_本番環境マイグレーション手順.md` - マイグレーション手順
- `AIdocs/ログ機能説明.md` - ログ機能の説明と確認方法

---

作成日: 2026-01-21

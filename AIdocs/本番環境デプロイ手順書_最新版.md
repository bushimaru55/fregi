# 本番環境デプロイ手順書（最新版）

作成日: 2026-01-21  
対象: 申込受付・通知メール仕様（1フォルダパッケージ）

---

## デプロイ前の準備

### 1. デプロイパッケージの生成・確認

**重要**: デプロイパッケージ（`deploy/webroot_billing/`）を最新のコードから再生成してください。

**手順**:
1. プロジェクトルートで `./scripts/build_deploy_webroot_billing.sh` を実行
2. スクリプトはローカルの `app/public/build/` を変更せず、一時ディレクトリで Vite ビルドして成果物のみ `deploy/webroot_billing/` に出力する
3. 生成後、`deploy/webroot_billing/build/manifest.json` が存在することを確認
4. `deploy/webroot_billing/app/` に Laravel 一式（.env 除く）が含まれることを確認

**確認項目**:
- [ ] `deploy/webroot_billing/index.php` が存在する（スクリプトが生成。`index.production.php` のリネームは不要）
- [ ] `deploy/webroot_billing/app/` に `app/`, `bootstrap/`, `config/`, `database/`, `resources/`, `routes/`, `storage/`, `vendor/` 等が含まれる

### 2. データベースバックアップの取得

**必須**: SQL 実行前に必ずデータベースのバックアップを取得してください。

1. Pleskにログイン
2. データベース一覧から `billing_prod` を選択
3. 「エクスポート」をクリック
4. 完全バックアップをダウンロード

### 3. .envファイルの準備

`AIdocs/本番環境.envテンプレート.txt` をコピーし、**deploy/webroot_billing/app/.env** として配置します。本番用の値を設定してください。

**必須設定**:
- `APP_KEY`: ローカルで `php artisan key:generate` で生成した値
- データベース接続情報（`DB_DATABASE`, `DB_USERNAME`, `DB_PASSWORD`）
- `APP_URL=https://dschatbot.ai/webroot/billing`
- `SESSION_PATH=/webroot/billing`
- 申込受付通知・送信テスト用の `MAIL_*`（本番メールサーバに合わせる）

**重要**:
- `APP_DEBUG=false` を設定（本番環境）
- `LOG_LEVEL=error` を設定

---

## デプロイ手順

### ステップ1: マイグレーションSQLの実行（必要な場合）

本番では `php artisan migrate` が使えないため、スキーマ・追加カラムは SQL で投入します。

1. Pleskにログインし、データベース `billing_prod` を選択
2. phpMyAdminを開き、SQLタブで該当SQLを実行
3. 既存のマイグレーション用SQLがある場合は、`AIdocs/` 内の該当ファイルを参照

**初回構築時**: ローカルDBから `mysqldump --no-data --routines --triggers ... billing > billing_schema.sql` でスキーマをエクスポートし、Pleskでインポート

### ステップ2: ファイルのアップロード（FTP）

**アップロード先（1箇所）**: `/httpdocs/webroot/billing/`（Plesk の実際のパスは `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/` 等）

**アップロードする内容**: **deploy/webroot_billing/** の中身をそのままアップロード

- `index.php`（スクリプトが生成済み。リネーム不要）
- `.htaccess`
- `build/`, `css/`, `js/`, `favicon.ico`, `robots.txt` 等
- `app/` ディレクトリ一式（Laravel 本体。その中に `.env` を本番用で配置済みであること）

**注意**:
- `.env` はスクリプトではコピーされない。事前に `AIdocs/本番環境.envテンプレート.txt` を元に **deploy/webroot_billing/app/.env** を作成し、本番の DB・MAIL_* 等を記入してからアップロードする

### ステップ3: パーミッションの設定

以下のパーミッションを設定（FTPクライアントまたはPleskファイルマネージャで可能な範囲で）：

- `app/storage/`: `775`
- `app/bootstrap/cache/`: `775`
- `app/storage/logs/`: `775`

### ステップ4: Config Cacheのクリア（必要に応じて）

`.env` を変更した場合、Pleskでは `php artisan config:clear` が使えないため、  
`/httpdocs/webroot/billing/app/bootstrap/cache/config.php` を削除すると、次回アクセス時に自動で再生成されます。

---

## デプロイ後の確認

### 1. 基本動作確認

- [ ] `https://dschatbot.ai/webroot/billing/` で申込フォーム（またはトップ）が表示される
- [ ] `https://dschatbot.ai/webroot/billing/build/manifest.json` が 200 で返る
- [ ] 新規申込フォームが表示され、静的ファイル（CSS、JS）が正しく読み込まれる

### 2. 管理画面・申込の確認

- [ ] 管理画面にログインでき、申込一覧・契約詳細が表示される
- [ ] 申込フォーム〜申込受付完了まで正常に動作する
- [ ] 送信先メールアドレスの設定・保存ができる
- [ ] 送信テストが実行できる（本番 MAIL_* 設定後）

### 3. ログの確認

- [ ] ログファイルが作成されている（`/httpdocs/webroot/billing/app/storage/logs/` 配下）
- [ ] メール送信エラー時は `mail-YYYY-MM-DD.log` で原因を確認できる

**ログ確認方法**: `AIdocs/ログ機能説明.md` を参照

---

## トラブルシューティング

### 申込・管理画面が表示されない場合

1. `deploy/webroot_billing/` が最新で再生成されているか確認
2. `.htaccess` の `RewriteBase /webroot/billing/` が設定されているか確認
3. `app/.env` の `APP_URL` と `SESSION_PATH` が `/webroot/billing` になっているか確認

### その他のエラー

詳細は `AIdocs/FTPデプロイ手順書.md` の「トラブルシューティング」セクションを参照してください。

---

## 参考資料

- `AIdocs/FTPデプロイ手順書.md` - 詳細なデプロイ手順
- `AIdocs/本番環境デプロイ準備チェックリスト.md` - デプロイ前の準備確認
- `AIdocs/本番環境デプロイチェックリスト.md` - デプロイ後の確認事項
- `deploy/AIdocs/deploy_rules.md` - デプロイの前提とルール
- `AIdocs/ログ機能説明.md` - ログ機能の説明と確認方法

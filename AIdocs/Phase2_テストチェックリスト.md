# Phase 2 実装 テストチェックリスト

作成日: 2026-01-13

## テスト項目

### 1. カード情報入力フォーム

- [ ] 確認画面（`/contract/confirm`）にカード情報入力フォームが表示される
- [ ] カード番号（PAN1-4）が4桁ずつ入力できる
- [ ] 有効期限（月）が01-12の選択肢から選択できる
- [ ] 有効期限（年）が2桁または4桁で入力できる
- [ ] カード名義が入力できる（45文字以内）
- [ ] セキュリティコードが入力できる（任意、3桁または4桁）

### 2. フォームバリデーション

- [ ] カード番号（PAN1-4）が4桁数字でない場合、エラーが表示される
- [ ] 有効期限（月）が選択されていない場合、エラーが表示される
- [ ] 有効期限（年）が入力されていない場合、エラーが表示される
- [ ] カード名義が入力されていない場合、エラーが表示される
- [ ] カード名義が45文字を超える場合、エラーが表示される

### 3. 一回限り決済（billing_type='one_time'）

- [ ] 一回限りプランで申込フォームから決済まで正常に処理される
- [ ] オーソリ処理（authm.cgi）が呼び出される
- [ ] MONTHLY=0が送信される
- [ ] 承認番号、取引番号が取得・保存される
- [ ] Payment.statusが'completed'になる
- [ ] Contract.statusが'active'になる
- [ ] 完了画面（`/contract/complete`）にリダイレクトされる

### 4. 月額課金決済（billing_type='monthly'）

- [ ] 月額課金プランで申込フォームから決済まで正常に処理される
- [ ] オーソリ処理（authm.cgi）が呼び出される
- [ ] MONTHLY=1, MONTHLYMODE=0が送信される
- [ ] CUSTOMERIDが生成・送信される
- [ ] 承認番号、取引番号が取得・保存される
- [ ] CUSTOMERIDがContract.customer_idに保存される
- [ ] Payment.statusが'completed'になる
- [ ] Contract.statusが'active'になる
- [ ] 完了画面（`/contract/complete`）にリダイレクトされる

### 5. エラーハンドリング

- [ ] F-REGI API呼び出し失敗時にエラーメッセージが表示される
- [ ] エラー時に確認画面に戻る
- [ ] ログにエラー情報が記録される

### 6. ログ

- [ ] オーソリ処理開始時にログが記録される（カード情報はマスクされる）
- [ ] オーソリ処理結果時にログが記録される
- [ ] 決済処理完了時にログが記録される
- [ ] エラー時にログが記録される

## テスト手順

1. **F-REGIテスト環境の設定確認**
   - F-REGIテスト環境の設定が正しいか確認
   - SHOPID、接続パスワードが正しく設定されているか確認

2. **一回限り決済のテスト**
   - 一回限りプランを選択
   - 申込フォームを入力
   - 確認画面でカード情報を入力
   - 「決済へ進む」をクリック
   - 正常に完了画面にリダイレクトされるか確認

3. **月額課金決済のテスト**
   - 月額課金プランを選択
   - 申込フォームを入力
   - 確認画面でカード情報を入力
   - 「決済へ進む」をクリック
   - 正常に完了画面にリダイレクトされるか確認
   - CUSTOMERIDが保存されているか確認

4. **エラーハンドリングのテスト**
   - 無効なカード情報でテスト
   - エラーメッセージが表示されるか確認
   - 確認画面に戻るか確認

## 確認事項

- [ ] カード情報がログに出力されていないか（マスクされているか）
- [ ] カード名義が大文字に変換されているか
- [ ] 有効期限の年が2桁に変換されているか（4桁入力の場合）
- [ ] CUSTOMERIDが20文字以内で生成されているか
- [ ] データベースに正しい値が保存されているか

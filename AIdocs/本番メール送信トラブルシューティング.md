# 本番メール送信トラブルシューティング

## ログの確認場所（本番サーバー）

- **メール送信ログ**: `/httpdocs/webroot/billing/app/storage/logs/mail-YYYY-MM-DD.log`
- **メインログ**: `/httpdocs/webroot/billing/app/storage/logs/laravel.log`

Plesk のファイルマネージャで上記パスを開く。

## 送信テスト時に記録される内容

1. **送信試行時**: `送信テストメール送信試行` に MAIL_HOST, MAIL_PORT, MAIL_USERNAME/MAIL_PASSWORD が (set) か (empty) か、MAIL_ENCRYPTION が記録される（パスワードの値は記録しない）。
2. **送信失敗時**: `送信テストメール送信エラー` に例外クラス・メッセージ・トレースが記録される。

## よくある原因と対処

| 原因 | ログの目安 | 対処 |
|------|------------|------|
| MAIL_PASSWORD が空 | `MAIL_PASSWORD` が `(empty)` または 画面エラー「A non-empty secret is required.」 | 本番 .env に `MAIL_PASSWORD=...` を設定し、`bootstrap/cache/config.php` を削除して再アクセス |
| SMTP 認証エラー | 例外メッセージに "Authentication" や "535" 等 | MAIL_USERNAME / MAIL_PASSWORD を確認、SMTP サーバ側で送信許可を確認 |
| 接続拒否・タイムアウト | 例外に "Connection refused" や "timed out" | MAIL_HOST / MAIL_PORT / ファイアウォールを確認 |
| 設定キャッシュが古い | ログの MAIL_* が想定と違う | `app/bootstrap/cache/config.php` を削除して再アクセス |

## 手順（本番でメールが送信されない場合）

1. 本番で管理画面 → 管理者管理 → 送信先メールアドレス設定画面で **「送信テスト」** を実行する。
2. 上記 **mail-YYYY-MM-DD.log** を開き、直近の `送信テストメール送信試行` と `送信テストメール送信エラー`（あれば）の行を確認する。
3. `MAIL_PASSWORD` が `(empty)` なら .env に本番SMTPのパスワードを設定する。
4. 例外メッセージに合わせて上表の対処を行う。
5. 設定変更後は **bootstrap/cache/config.php** を削除してから再度送信テストする。

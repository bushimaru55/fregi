# Phase 2 テスト実行手順（手動テスト）

作成日: 2026-01-13

## テスト環境情報

### F-REGI設定
- **SHOPID**: 23034 ✅ 確認済み
- **環境**: test ✅ 確認済み

### テスト用プラン
- **一回限りプラン**: ID 21 - テスト用 一回限りプラン (¥10,000) ✅ 確認済み
- **月額課金プラン**: ID 22 - テスト用 月額課金プラン (¥5,000) ✅ 確認済み

### テストカード情報
- **カード番号**: 4980-1111-1111-1111
- **有効期限**: 10/30（未来年月）
- **カード名義**: 任意（例: TEST USER）
- **セキュリティコード**: 111（承認成功）または 123（承認失敗）

## テスト1: カード情報入力フォームの表示確認

### 手順
1. 公開申込フォームにアクセス: `http://localhost:8080/billing/contract/create`
2. 必須項目を入力：
   - 会社名: 「テスト会社株式会社」
   - 契約プラン: 「テスト用 一回限りプラン」を選択（ID: 21）
   - 利用開始希望日: 今日以降の日付を選択
   - 利用規約への同意: チェック
3. 「確認画面へ」ボタンをクリック
4. 確認画面でカード情報入力フォームが表示されることを確認：
   - カード番号入力フィールド（PAN1-4、4桁ずつ）
   - 有効期限入力（月：ドロップダウン、年：テキスト入力）
   - カード名義入力フィールド
   - セキュリティコード入力フィールド

## テスト2: フォームバリデーションの確認

### 手順
1. 確認画面でカード情報を入力：
   - カード番号を3桁で入力 → エラーが表示されるか確認
   - 有効期限（月）を選択せずに送信 → エラーが表示されるか確認
   - カード名義を入力せずに送信 → エラーが表示されるか確認

## テスト3: 一回限り決済のテスト

### 手順
1. 公開申込フォームにアクセス: `http://localhost:8080/billing/contract/create`
2. 必須項目を入力：
   - 会社名: 「テスト会社株式会社」
   - 契約プラン: 「テスト用 一回限りプラン」を選択（ID: 21）
   - 利用開始希望日: 今日以降の日付を選択
   - 利用規約への同意: チェック
3. 「確認画面へ」ボタンをクリック
4. 確認画面でカード情報を入力：
   - カード番号: 4980-1111-1111-1111
   - 有効期限（月）: 10
   - 有効期限（年）: 30
   - カード名義: TEST USER
   - セキュリティコード: 111
5. 「決済へ進む」ボタンをクリック
6. 正常に完了画面にリダイレクトされることを確認

## テスト4: 月額課金決済のテスト

### 手順
1. 公開申込フォームにアクセス: `http://localhost:8080/billing/contract/create`
2. 必須項目を入力：
   - 会社名: 「テスト会社株式会社」
   - 契約プラン: 「テスト用 月額課金プラン」を選択（ID: 22）
   - 利用開始希望日: 今日以降の日付を選択
   - 利用規約への同意: チェック
3. 「確認画面へ」ボタンをクリック
4. 確認画面でカード情報を入力：
   - カード番号: 4980-1111-1111-1111
   - 有効期限（月）: 10
   - 有効期限（年）: 30
   - カード名義: TEST USER
   - セキュリティコード: 111
5. 「決済へ進む」ボタンをクリック
6. 正常に完了画面にリダイレクトされることを確認
7. データベースで `customer_id` が保存されていることを確認

## テスト5: エラーハンドリングのテスト

### 手順
1. 確認画面で無効なカード情報を入力：
   - カード番号: 4980-1111-1111-1111
   - 有効期限（月）: 10
   - 有効期限（年）: 30
   - カード名義: TEST USER
   - セキュリティコード: 123（承認失敗用）
2. 「決済へ進む」ボタンをクリック
3. エラーメッセージが表示されることを確認
4. 確認画面に戻ることを確認

## データベース確認（テスト後）

```sql
-- 最新の契約を確認
SELECT id, contract_plan_id, status, customer_id, billing_type, created_at 
FROM contracts 
ORDER BY id DESC 
LIMIT 5;

-- 最新の決済を確認
SELECT id, contract_id, status, receiptno, slipno, created_at 
FROM payments 
ORDER BY id DESC 
LIMIT 5;

-- 月額課金の場合、customer_idが保存されているか確認
SELECT id, customer_id, status, billing_type 
FROM contracts 
WHERE billing_type = 'monthly' 
ORDER BY id DESC 
LIMIT 1;
```

## ログ確認

```bash
cd /Users/dfn4459wgl/Desktop/billing/app
docker-compose exec app tail -f storage/logs/contract_payment.log
# または
docker-compose exec app tail -f storage/logs/laravel.log
```

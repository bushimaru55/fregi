# 月額課金実装計画

作成日: 2026-01-13

## 実装方針

月額課金が主な機能であるため、オーソリ処理（authm.cgi）による月額課金機能を実装します。

## 実装ステップ

### 1. データベーススキーマの拡張

#### 1.1 ContractテーブルにCUSTOMERIDカラムを追加
- `customer_id` (VARCHAR(20), nullable): F-REGIの顧客番号

#### 1.2 マイグレーション作成
- `add_customer_id_to_contracts_table.php`

### 2. オーソリ処理（authm.cgi）APIサービスの実装

#### 2.1 FregiApiServiceにauthm.cgiメソッドを追加
- `authorizePayment()` メソッドの実装
- パラメータ: SHOPID, PAY, PAN1-4, CARDEXPIRY1-2, CARDNAME, MONTHLY, MONTHLYMODE, CUSTOMERID等
- レスポンス処理: OK/NG判定、承認番号、取引番号の取得

#### 2.2 月次売上処理（salem.cgi）メソッドの実装
- `processMonthlySale()` メソッドの実装
- パラメータ: SHOPID, CUSTOMERID, PAY, SALEDATE等

### 3. カード情報入力フォームの実装

#### 3.1 確認画面からカード情報入力画面への変更
- `contracts.confirm.blade.php` を修正
- カード情報入力フィールドを追加（PAN1-4, CARDEXPIRY1-2, CARDNAME, SCODE等）
- セキュリティ対応の検討（将来的にPCI DSS準拠が必要）

#### 3.2 フォームバリデーション
- `ContractRequest` にカード情報のバリデーションを追加

### 4. ContractControllerの決済処理をauthm.cgiに切り替え

#### 4.1 store()メソッドの修正
- リダイレクト決済（compsettleapply.cgi）からオーソリ処理（authm.cgi）への切り替え
- MONTHLY=1, MONTHLYMODE=0 を指定
- CUSTOMERIDを生成・保存
- 月額課金プラン（billing_type='monthly'）の場合のみオーソリ処理を使用

#### 4.2 一回限り決済との共存
- billing_type='one_time' の場合は従来のリダイレクト決済を使用
- billing_type='monthly' の場合はオーソリ処理を使用

### 5. CUSTOMERIDの生成・管理

#### 5.1 CUSTOMERID生成ロジック
- 形式: 契約IDベースの一意なID（20文字以内）
- Contractモデルに生成メソッドを追加

#### 5.2 CUSTOMERIDの保存
- 契約作成時にCUSTOMERIDを生成
- オーソリ処理成功時にF-REGIから返却されたCUSTOMERIDを保存

### 6. 月次売上処理の実装

#### 6.1 月次売上処理コマンドの作成
- `ProcessMonthlySales` コマンドの作成
- 月額課金契約（billing_type='monthly', status='active'）を取得
- salem.cgi APIを呼び出して月次売上処理を実行

#### 6.2 Cronスケジュールの設定
- 毎月1日の深夜に実行（Kernel.phpでスケジュール設定）

### 7. 承認結果通知URLの実装

#### 7.1 通知受信エンドポイントの作成
- `/api/fregi/auth-notify` ルートの追加
- `Api/FregiAuthNotifyController` の作成
- 通知パラメータの検証・処理
- 契約・決済ステータスの更新

### 8. エラーハンドリングとログ

#### 8.1 オーソリ処理のエラーハンドリング
- エラー時のログ記録
- ユーザーへのエラーメッセージ表示

#### 8.2 月次売上処理のエラーハンドリング
- 失敗時のログ記録
- 再試行ロジックの実装

## 実装の優先順位

1. **Phase 1: データベーススキーマとAPIサービス**
   - CUSTOMERIDカラムの追加
   - FregiApiServiceのauthm.cgi実装
   - FregiApiServiceのsalem.cgi実装

2. **Phase 2: カード情報入力と初回決済**
   - カード情報入力フォームの実装
   - ContractControllerのstore()メソッドをauthm.cgiに切り替え
   - CUSTOMERIDの生成・保存

3. **Phase 3: 月次売上処理と通知**
   - 月次売上処理コマンドの実装
   - Cronスケジュールの設定
   - 承認結果通知URLの実装

4. **Phase 4: テストと調整**
   - テスト環境での動作確認
   - エラーハンドリングの強化

## 注意事項

### セキュリティ
- カード情報の直接入力はPCI DSS準拠の検討が必要
- カード情報の暗号化・安全な保存が必要
- トークン化の検討（将来的に）

### F-REGI管理画面での設定
- 月次課金サービスの有効化
- 承認結果通知URLの設定（`203.76.164.2`をホワイトリストに登録）
- 自動決済のスケジュール設定

### 一回限り決済との共存
- billing_type='one_time' の場合は従来のリダイレクト決済を継続使用
- billing_type='monthly' の場合はオーソリ処理を使用

## 参考資料

- `AIdocs/F-REGI月額課金仕様書（authm.cgi）.md`
- `AIdocs/月額プランの自動引き落としについて.md`

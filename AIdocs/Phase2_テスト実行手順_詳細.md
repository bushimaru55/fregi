# Phase 2 テスト実行手順（詳細版）

作成日: 2026-01-13

## テスト環境の準備

### 1. F-REGIテスト環境の設定確認

#### 手順1: 管理画面にログイン

1. ブラウザで以下のURLにアクセス:
   - `http://localhost:8080/billing/login`

2. ログイン情報を入力:
   - メールアドレス: `kanri@dschatbot.ai`
   - パスワード: `cs20051101`

3. 「ログイン」ボタンをクリック

#### 手順2: F-REGI設定画面にアクセス

1. ログイン後、以下のURLにアクセス:
   - `http://localhost:8080/billing/admin/fregi-configs`

2. 設定の確認:
   - テスト環境（environment='test'）の設定が存在するか確認
   - `is_active=true` の設定が1件存在するか確認
   - SHOPIDが正しく設定されているか確認（例: `23034`）
   - 接続パスワードが正しく設定されているか確認

#### 手順3: 設定が存在しない場合

設定が存在しない場合、以下のいずれかの方法で作成:

**方法A: 管理画面から作成**
1. 「新規作成」ボタンをクリック
2. 以下の情報を入力:
   - 環境: `test`
   - SHOP ID: `23034`（F-REGIテスト環境のSHOPID）
   - 接続パスワード: `iGkwdy2a`（F-REGIテスト環境の接続パスワード）
   - 通知URL: `http://localhost:8080/billing/api/fregi/notify`
   - 戻りURL（成功）: `http://localhost:8080/billing/contract/complete`
   - 戻りURL（キャンセル）: `http://localhost:8080/billing/contract/create`
   - アクティブ: ✅ チェック
3. 「登録」ボタンをクリック

**方法B: コマンドラインから作成**
```bash
cd /Users/dfn4459wgl/Desktop/billing/app
docker compose exec app bash -lc "cd /var/www && php artisan fregi:register-test-config"
```

### 2. テスト用プランの確認

#### 手順1: 契約プラン管理画面にアクセス

1. 以下のURLにアクセス:
   - `http://localhost:8080/billing/admin/contract-plans`

2. プランの確認:
   - 一回限りプラン（billing_type='one_time'）が存在するか確認
   - 月額課金プラン（billing_type='monthly'）が存在するか確認
   - 両方とも `is_active=true` であることを確認

#### 手順2: プランが存在しない場合

プランが存在しない場合、以下のいずれかの方法で作成:

**方法A: 管理画面から作成**
1. 「新規作成」ボタンをクリック
2. 一回限りプランを作成:
   - 契約プランマスター: 適切なマスターを選択（または新規作成）
   - 商品コード: `TEST-ONE-TIME`
   - プラン名: `テスト用 一回限りプラン`
   - 料金: `10000`
   - 決済タイプ: `一回限り`
   - アクティブ: ✅ チェック
3. 「登録」ボタンをクリック
4. 同様に月額課金プランを作成:
   - 商品コード: `TEST-MONTHLY`
   - プラン名: `テスト用 月額課金プラン`
   - 料金: `5000`
   - 決済タイプ: `月額課金`
   - アクティブ: ✅ チェック

**方法B: コマンドラインから作成**
```bash
cd /Users/dfn4459wgl/Desktop/billing/app
docker compose exec app bash -lc "cd /var/www && php artisan test:create-plans"
```

## テスト実行

### テスト1: カード情報入力フォームの表示確認

#### 手順1: 申込フォームにアクセス

1. ブラウザで以下のURLにアクセス（ログアウト状態でもアクセス可能）:
   - `http://localhost:8080/billing/contract/create`

#### 手順2: 申込フォームを入力

1. プランを選択（一回限りプランまたは月額課金プラン）
2. 必要項目を入力:
   - 会社名: `テスト株式会社`
   - 担当者名: `テスト 太郎`
   - メールアドレス: `test@example.com`
   - 電話番号: `03-1234-5678`
   - 利用開始希望日: 今日以降の日付を選択
   - 利用規約への同意: ✅ チェック

3. 「確認画面へ」ボタンをクリック

#### 手順3: 確認画面でカード情報入力フォームを確認

確認画面（`/contract/confirm`）が表示されたら、以下を確認:

1. **カード情報入力フォームが表示されているか**
   - 「4. お支払い情報」セクションが表示されているか
   - セキュリティメッセージ（「SSL暗号化通信により安全に送信されます」）が表示されているか

2. **カード番号入力フィールド（PAN1-4）**
   - 4つの入力フィールドが表示されているか
   - 各フィールドが4桁ずつ入力できるか
   - プレースホルダー（`1234`, `5678`, `9012`, `3456`）が表示されているか

3. **有効期限入力**
   - 月（ドロップダウン）が表示されているか
   - 01-12の選択肢が表示されているか
   - 年（テキスト入力）が表示されているか
   - プレースホルダー（`25 または 2025`）が表示されているか

4. **カード名義入力フィールド**
   - 入力フィールドが表示されているか
   - プレースホルダー（`TARO YAMADA`）が表示されているか
   - 説明文（「45文字以内」）が表示されているか

5. **セキュリティコード入力フィールド**
   - 入力フィールドが表示されているか（任意項目）
   - プレースホルダー（`123`）が表示されているか
   - 説明文（「3桁または4桁の数字」）が表示されているか

**確認項目**:
- [ ] カード情報入力フォームが表示される
- [ ] カード番号（PAN1-4、4桁ずつ）が入力できる
- [ ] 有効期限（月：ドロップダウン、年：テキスト入力）が入力できる
- [ ] カード名義が入力できる（45文字以内）
- [ ] セキュリティコードが入力できる（任意、3桁または4桁）

---

### テスト2: フォームバリデーションの確認

#### 手順1: カード番号のバリデーション

1. 確認画面でカード情報を入力
2. カード番号（PAN1）を3桁で入力（例: `123`）
3. 他の必須項目も入力
4. 「決済へ進む」ボタンをクリック
5. エラーメッセージが表示されるか確認
   - 「カード番号（1〜4桁目）は4桁の数字で入力してください。」が表示されるか

#### 手順2: 有効期限のバリデーション

1. カード番号を正しく入力（4桁ずつ）
2. 有効期限（月）を選択しない
3. 他の必須項目も入力
4. 「決済へ進む」ボタンをクリック
5. エラーメッセージが表示されるか確認

#### 手順3: カード名義のバリデーション

1. カード情報を入力
2. カード名義を入力しない
3. 他の必須項目も入力
4. 「決済へ進む」ボタンをクリック
5. エラーメッセージが表示されるか確認

**確認項目**:
- [ ] カード番号（PAN1-4）が4桁数字でない場合、エラーが表示される
- [ ] 有効期限（月）が選択されていない場合、エラーが表示される
- [ ] 有効期限（年）が入力されていない場合、エラーが表示される
- [ ] カード名義が入力されていない場合、エラーが表示される
- [ ] カード名義が45文字を超える場合、エラーが表示される

---

### テスト3: 一回限り決済のテスト

#### 手順1: 一回限りプランを選択

1. 申込フォーム（`/contract/create`）にアクセス
2. 一回限りプラン（billing_type='one_time'）を選択
3. 申込フォームを入力
4. 「確認画面へ」ボタンをクリック

#### 手順2: カード情報を入力

1. 確認画面でカード情報を入力:
   - **テストカード情報（F-REGIテスト環境用）**:
     - カード番号: `4111111111111111`（Visaテストカード）
     - 有効期限: 未来の日付（例: `12` / `25`）
     - カード名義: `TEST TARO`
     - セキュリティコード: `123`（任意）

2. 「決済へ進む」ボタンをクリック

#### 手順3: 処理結果の確認

1. **完了画面へのリダイレクト**
   - 正常に完了画面（`/contract/complete`）にリダイレクトされるか確認

2. **データベースでの確認**
   - 管理画面の契約管理（`/admin/contracts`）から最新の契約を確認
   - Payment.status が `completed` になっているか確認
   - Contract.status が `active` になっているか確認
   - 承認番号（receiptno）、取引番号（slipno）が保存されているか確認

3. **ログの確認**
   ```bash
   cd /Users/dfn4459wgl/Desktop/billing/app
   docker compose exec app bash -lc "cd /var/www && tail -n 100 storage/logs/laravel.log | grep -A 20 'F-REGIオーソリ処理'"
   ```
   - オーソリ処理開始時にログが記録されているか確認
   - カード情報がマスク（`****`）されているか確認
   - オーソリ処理結果時にログが記録されているか確認
   - `MONTHLY=0`が送信されているか確認（ログに含まれるか）

**確認項目**:
- [ ] 一回限りプランで申込フォームから決済まで正常に処理される
- [ ] オーソリ処理（authm.cgi）が呼び出される
- [ ] MONTHLY=0が送信される
- [ ] 承認番号、取引番号が取得・保存される
- [ ] Payment.statusが'completed'になる
- [ ] Contract.statusが'active'になる
- [ ] 完了画面（`/contract/complete`）にリダイレクトされる

---

### テスト4: 月額課金決済のテスト

#### 手順1: 月額課金プランを選択

1. 申込フォーム（`/contract/create`）にアクセス
2. 月額課金プラン（billing_type='monthly'）を選択
3. 申込フォームを入力
4. 「確認画面へ」ボタンをクリック

#### 手順2: カード情報を入力

1. 確認画面でカード情報を入力（テストカード情報を使用）
2. 「決済へ進む」ボタンをクリック

#### 手順3: 処理結果の確認

1. **完了画面へのリダイレクト**
   - 正常に完了画面にリダイレクトされるか確認

2. **データベースでの確認**
   - 管理画面の契約管理から最新の契約を確認
   - Payment.status が `completed` になっているか確認
   - Contract.status が `active` になっているか確認
   - **Contract.customer_id が保存されているか確認**（重要）
   - 承認番号、取引番号が保存されているか確認

3. **ログの確認**
   - オーソリ処理開始時にログが記録されているか確認
   - カード情報がマスクされているか確認
   - オーソリ処理結果時にログが記録されているか確認
   - `MONTHLY=1`, `MONTHLYMODE=0`が送信されているか確認
   - CUSTOMERIDが生成・送信されているか確認

**確認項目**:
- [ ] 月額課金プランで申込フォームから決済まで正常に処理される
- [ ] オーソリ処理（authm.cgi）が呼び出される
- [ ] MONTHLY=1, MONTHLYMODE=0が送信される
- [ ] CUSTOMERIDが生成・送信される
- [ ] 承認番号、取引番号が取得・保存される
- [ ] CUSTOMERIDがContract.customer_idに保存される
- [ ] Payment.statusが'completed'になる
- [ ] Contract.statusが'active'になる
- [ ] 完了画面（`/contract/complete`）にリダイレクトされる

---

### テスト5: エラーハンドリングのテスト

#### 手順1: 無効なカード情報でテスト

1. 申込フォームから確認画面まで進む
2. 無効なカード情報を入力:
   - カード番号: `1234567890123456`（無効な番号）
   - 有効期限: 未来の日付
   - カード名義: `TEST USER`
3. 「決済へ進む」ボタンをクリック

#### 手順2: エラーメッセージの確認

1. エラーメッセージが表示されるか確認
   - 「決済処理に失敗しました: [エラーメッセージ]」が表示されるか

2. 確認画面に戻るか確認
   - エラー時に確認画面に戻るか確認
   - 入力した情報が保持されているか確認

3. ログの確認
   - エラー時にログが記録されているか確認
   - エラーメッセージがログに含まれているか確認

**確認項目**:
- [ ] F-REGI API呼び出し失敗時にエラーメッセージが表示される
- [ ] エラー時に確認画面に戻る
- [ ] ログにエラー情報が記録される

---

## ログ確認方法

### リアルタイムでログを確認

```bash
cd /Users/dfn4459wgl/Desktop/billing/app
docker compose exec app bash -lc "cd /var/www && tail -f storage/logs/laravel.log"
```

### 決済関連のログのみを確認

```bash
docker compose exec app bash -lc "cd /var/www && tail -n 200 storage/logs/laravel.log | grep -i 'contract_payment\|F-REGI'"
```

### ログファイルの場所

- メインログ: `storage/logs/laravel.log`
- 決済ログ（contract_paymentチャンネル）: 設定により異なる（通常は`storage/logs/laravel.log`に統合）

---

## 確認事項チェックリスト

- [ ] カード情報がログに出力されていないか（マスクされているか）
- [ ] カード名義が大文字に変換されているか
- [ ] 有効期限の年が2桁に変換されているか（4桁入力の場合）
- [ ] CUSTOMERIDが20文字以内で生成されているか
- [ ] データベースに正しい値が保存されているか

---

## トラブルシューティング

### ログインできない場合

1. データベースに管理者ユーザーが存在するか確認
2. パスワードが正しいか確認
3. セッションクッキーが有効か確認

### F-REGI設定が見つからない場合

1. 管理画面でF-REGI設定が作成されているか確認
2. `is_active=true` になっているか確認
3. `environment='test'` になっているか確認

### プランが表示されない場合

1. 管理画面で契約プランが作成されているか確認
2. `is_active=true` になっているか確認

### 決済処理でエラーが発生する場合

1. F-REGIテスト環境のSHOPID、接続パスワードが正しいか確認
2. ログを確認してエラーメッセージを確認
3. カード情報が正しく入力されているか確認
4. F-REGIテスト環境が利用可能か確認

# 修正内容：カード情報バリデーションの分離

作成日: 2026-01-13

## 問題点

「確認画面へ」ボタンをクリックした際に、カード情報のバリデーションエラーが表示され、確認画面に遷移しない問題がありました。

**エラーメッセージ**:
- The カード番号（1〜4桁目） field is required.
- The カード番号（5〜8桁目） field is required.
- The カード番号（9〜12桁目） field is required.
- The カード番号（13〜16桁目） field is required.
- The カード有効期限（月） field is required.
- The カード有効期限（年） field is required.
- The カード名義 field is required.

## 原因

`ContractRequest` のバリデーションルールで、カード情報（pan1-4, card_expiry_month, card_expiry_year, card_name, scode）がすべて `required` になっていました。

しかし、フローは以下のようになっています：
1. **申込フォーム（create）** → POST `/contract/confirm` → `ContractController::confirm()` メソッド
   - この時点ではカード情報は不要（確認画面で入力する）
2. **確認画面（confirm）** → POST `/contract/store` → `ContractController::store()` メソッド
   - この時点でカード情報が必要（決済処理を実行）

つまり、`confirm()` メソッドが `ContractRequest` を使ってバリデーションしていますが、カード情報は確認画面で入力するものなので、最初のフォーム送信時（create → confirm）にはカード情報は不要です。

## 修正内容

`ContractRequest` の `rules()` メソッドを修正し、ルート名に応じてバリデーションルールを変更するようにしました。

**修正箇所**: `app/app/Http/Requests/ContractRequest.php`

```php
public function rules(): array
{
    $routeName = $this->route()->getName();
    
    $rules = [
        // 契約プラン
        'contract_plan_id' => ['required', 'exists:contract_plans,id'],
        
        // 申込企業情報
        'company_name' => ['required', 'string', 'max:255'],
        // ... 他の基本フィールド ...
        
        // 契約内容
        'desired_start_date' => ['required', 'date', 'after_or_equal:today'],
        
        // 利用規約への同意
        'terms_agreed' => ['required', 'accepted'],
    ];
    
    // カード情報は決済処理（store）時のみ必須
    // 確認画面表示（confirm）時は不要
    if ($routeName === 'contract.store') {
        $rules = array_merge($rules, [
            // カード情報（authm.cgi用）
            'pan1' => ['required', 'string', 'regex:/^\d{4}$/'],
            'pan2' => ['required', 'string', 'regex:/^\d{4}$/'],
            'pan3' => ['required', 'string', 'regex:/^\d{4}$/'],
            'pan4' => ['required', 'string', 'regex:/^\d{4}$/'],
            'card_expiry_month' => ['required', 'string', 'regex:/^(0[1-9]|1[0-2])$/'],
            'card_expiry_year' => ['required', 'string', 'regex:/^\d{2,4}$/'],
            'card_name' => ['required', 'string', 'max:45'],
            'scode' => ['nullable', 'string', 'regex:/^\d{3,4}$/'],
        ]);
    }
    
    return $rules;
}
```

## 動作確認

### テストケース1: 申込フォームから確認画面へ遷移
1. `/contract/create?plans=21` にアクセス
2. 必須項目（会社名、担当者名、メール、電話、プラン選択、利用開始希望日、利用規約への同意）を入力
3. **カード情報は入力しない**
4. 「確認画面へ」ボタンをクリック
5. **期待結果**: 確認画面に遷移し、カード情報入力フォームが表示される

### テストケース2: 確認画面から決済処理へ
1. 確認画面でカード情報を入力
2. 「決済へ進む」ボタンをクリック
3. **期待結果**: カード情報がバリデーションされ、決済処理が実行される

### テストケース3: 確認画面でカード情報未入力
1. 確認画面でカード情報を入力せずに「決済へ進む」ボタンをクリック
2. **期待結果**: カード情報のバリデーションエラーが表示される

## まとめ

- カード情報のバリデーションを `contract.store` ルート（決済処理時）のみに適用
- `contract.confirm` ルート（確認画面表示時）ではカード情報のバリデーションを行わない
- これにより、申込フォームから確認画面への遷移が正常に動作する

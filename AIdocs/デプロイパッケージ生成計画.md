# デプロイパッケージ生成計画

作成日: 2026-01-15

## 1. 現状のプロジェクト構造

### 1.1 リポジトリ直下のディレクトリ一覧

```
/Users/dfn4459wgl/Desktop/billing/
├── .git/
├── AIdocs/
├── app/                    # Laravel本体
├── deploy/                 # デプロイパッケージ生成先（作成予定）
├── docker/
├── docker-compose.yml
├── README.md
└── .gitignore
```

### 1.2 billing.zip展開後のトップ階層（billing/ 配下）の構造

```
billing/
├── AIdocs/
├── app/                    # Laravel本体
│   ├── app/
│   ├── artisan            # ← Laravel本体の所在
│   ├── bootstrap/
│   ├── composer.json      # ← Laravel本体の所在
│   ├── config/
│   ├── database/
│   ├── public/            # ← public/ の所在
│   ├── resources/
│   ├── routes/
│   ├── storage/
│   ├── vendor/
│   └── ...
├── deploy/
│   └── webroot_billing/   # デプロイパッケージ（生成予定）
├── docker/
└── docker-compose.yml
```

### 1.3 Laravel本体の場所

- **artisan**: `./app/artisan`
- **composer.json**: `./app/composer.json`
- **public/**: `./app/public/`

---

## 2. 生成予定のデプロイ成果物構造

### 2.1 deploy/webroot_billing/ 配下の構造（計画）

```
deploy/webroot_billing/
├── index.php              # 修正版（app/ を参照）
├── .htaccess              # public/.htaccess をコピー
├── build/                 # Viteビルド成果物（public/build/ からコピー）
│   └── manifest.json      # ← 動作確認用
├── css/                   # public/css/ からコピー
├── js/                    # public/js/ からコピー
├── favicon.ico            # public/favicon.ico からコピー
├── robots.txt             # public/robots.txt からコピー
├── app/                   # Laravel本体
│   ├── .htaccess          # 新規作成（Require all denied）
│   ├── artisan
│   ├── app/
│   ├── bootstrap/
│   │   └── cache/         # 書き込み権限必要（775）
│   ├── config/
│   ├── database/
│   ├── resources/
│   ├── routes/
│   ├── storage/           # 書き込み権限必要（775）
│   │   ├── app/
│   │   ├── framework/
│   │   └── logs/
│   ├── vendor/            # composer install --no-dev で生成
│   ├── composer.json
│   ├── composer.lock
│   └── .env               # 本番環境用（手動で設定）
└── README.md              # FTPアップロード手順
```

### 2.2 生成するファイル/ディレクトリの一覧（計画）

#### deploy/webroot_billing/ 直下（公開ディレクトリ）

1. **index.php** - 修正版
   - `require __DIR__.'/app/vendor/autoload.php';`
   - `$app = require_once __DIR__.'/app/bootstrap/app.php';`
   - `$maintenance = __DIR__.'/app/storage/framework/maintenance.php';`

2. **.htaccess** - `app/public/.htaccess` をコピー
   - `RewriteBase /webroot/billing/` を追加（推奨）

3. **build/** - `app/public/build/` からコピー（Viteビルド後）
   - `manifest.json` を含む

4. **css/** - `app/public/css/` からコピー

5. **js/** - `app/public/js/` からコピー

6. **favicon.ico** - `app/public/favicon.ico` からコピー

7. **robots.txt** - `app/public/robots.txt` からコピー

#### deploy/webroot_billing/app/ 配下（Laravel本体）

1. **.htaccess** - 新規作成
   ```apache
   Require all denied
   ```

2. **app/** - `app/app/` からコピー

3. **bootstrap/** - `app/bootstrap/` からコピー
   - `cache/` は書き込み権限必要

4. **config/** - `app/config/` からコピー

5. **database/** - `app/database/` からコピー

6. **resources/** - `app/resources/` からコピー

7. **routes/** - `app/routes/` からコピー

8. **storage/** - `app/storage/` からコピー
   - 書き込み権限必要

9. **vendor/** - `composer install --no-dev` で生成

10. **artisan** - `app/artisan` からコピー

11. **composer.json** - `app/composer.json` からコピー

12. **composer.lock** - `app/composer.lock` からコピー

13. **.env** - 手動で設定（テンプレートから作成）

#### 除外するファイル/ディレクトリ

- `node_modules/`
- `.git/`
- `__MACOSX/`
- `.DS_Store`
- `tests/`
- `phpunit.xml`
- `package.json`, `package-lock.json`
- `vite.config.js`
- `tailwind.config.js`
- `postcss.config.js`

---

## 3. スクリプト作成計画

### 3.1 スクリプト名・配置先

- **スクリプト名**: `scripts/build_deploy_webroot_billing.sh`
- **配置先**: `/Users/dfn4459wgl/Desktop/billing/scripts/build_deploy_webroot_billing.sh`

### 3.2 スクリプトの処理フロー

1. 作業ディレクトリの確認
2. `deploy/webroot_billing/` のクリーンアップ（既存があれば削除）
3. `deploy/webroot_billing/` の作成
4. Viteビルドの実行（`app/` ディレクトリで `npm run build`）
5. `public/` の中身を `deploy/webroot_billing/` にコピー
6. `index.php` の修正
7. Laravel本体を `deploy/webroot_billing/app/` にコピー
8. `deploy/webroot_billing/app/.htaccess` の作成
9. `composer install --no-dev` の実行（`deploy/webroot_billing/app/` で）
10. パーミッションの設定（storage/, bootstrap/cache/）
11. README.md の生成

---

## 4. npm run build の実行

### 4.1 実行ディレクトリ

```bash
cd /Users/dfn4459wgl/Desktop/billing/app
npm run build
```

### 4.2 成功条件

- **manifest.json の場所**: `app/public/build/.vite/manifest.json` または `app/public/build/manifest.json`
- **確認方法**: 
  ```bash
  ls -la app/public/build/.vite/manifest.json
  # または
  ls -la app/public/build/manifest.json
  ```
- **ビルド成果物**: `app/public/build/` ディレクトリに以下が生成される
  - CSSファイル
  - JSファイル
  - manifest.json

### 4.3 ビルド後の確認

```bash
# ビルド成果物の確認
ls -la app/public/build/
# manifest.json の存在確認
test -f app/public/build/.vite/manifest.json && echo "Vite build成功" || echo "Vite build失敗"
```

---

## 5. 動作確認URL（デプロイ後）

### 5.1 正常にアクセスできるURL

- `https://dschatbot.ai/webroot/billing/` - トップページ
- `https://dschatbot.ai/webroot/billing/build/manifest.json` - ビルド成果物の確認

### 5.2 403エラーが返るべきURL（セキュリティ確認）

- `https://dschatbot.ai/webroot/billing/app/.env` - 403エラー（.htaccessで保護）
- `https://dschatbot.ai/webroot/billing/app/vendor/` - 403エラー（.htaccessで保護）
- `https://dschatbot.ai/webroot/billing/app/storage/` - 403エラー（.htaccessで保護）

---

## 6. 次のステップ

1. スクリプト `scripts/build_deploy_webroot_billing.sh` を作成
2. スクリプトを実行してデプロイパッケージを生成
3. 生成されたパッケージの確認
4. README.md の確認
5. FTPアップロード手順の確認

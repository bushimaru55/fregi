# 決済フロー用ログ機能

## 概要

決済フローのテスト時にエラーが発生した場合、原因を追跡できるように詳細なログを記録する機能を実装しました。

## ログファイルの場所

ログファイルは以下の場所に保存されます：

```
storage/logs/contract-payment-YYYY-MM-DD.log
```

例：`storage/logs/contract-payment-2026-01-13.log`

## ログの保持期間

ログファイルは **30日間** 保持されます。30日を超えたログファイルは自動的に削除されます。

## 記録される情報

### 1. 申込フォーム表示時 (`create`メソッド)

- URL（完全なURL）
- 選択されたプランID（`plans`パラメータ）
- 表示されたプラン数
- アクセス元IPアドレス
- ユーザーエージェント
- タイムスタンプ

### 2. 確認画面表示時 (`confirm`メソッド)

- 契約プランID
- プラン名・価格
- 会社名（マスク済み：最初の3文字のみ表示）
- メールアドレス（マスク済み：最初の3文字のみ表示）
- アクセス元IPアドレス
- ユーザーエージェント
- タイムスタンプ

### 3. 決済処理時 (`store`メソッド)

#### 処理開始
- 契約プランID
- アクセス元IPアドレス
- ユーザーエージェント

#### 契約作成完了
- 契約ID
- 契約プランID
- ステータス

#### 決済情報作成完了
- 決済ID
- 契約ID
- 伝票番号（orderid）
- 金額
- ステータス

#### F-REGI API呼び出し
- 決済ID
- 伝票番号
- APIパラメータ
- 決済タイプ（一回限り/月額）
- 環境（test/prod）

#### F-REGI API結果
- 決済ID
- 結果（OK/NG）
- 発行番号（settleno）
- エラーメッセージ（エラー時）

#### 決済処理完了
- 決済ID
- 契約ID
- 伝票番号
- 発行番号
- 決済画面URL
- 処理時間（ミリ秒）

### 4. エラー発生時

- エラーメッセージ
- スタックトレース
- ファイル名・行番号
- アクセス元IPアドレス
- 処理時間（ミリ秒）

## ログの確認方法

### 1. Dockerコンテナ内から確認

```bash
docker compose exec app bash
cd /var/www
tail -f storage/logs/contract-payment-$(date +%Y-%m-%d).log
```

### 2. 最新のログを確認

```bash
docker compose exec app bash -c "cd /var/www && tail -100 storage/logs/contract-payment-$(date +%Y-%m-%d).log"
```

### 3. エラーログのみを確認

```bash
docker compose exec app bash -c "cd /var/www && grep -i error storage/logs/contract-payment-$(date +%Y-%m-%d).log"
```

### 4. 特定の決済IDで検索

```bash
docker compose exec app bash -c "cd /var/www && grep 'payment_id.*123' storage/logs/contract-payment-*.log"
```

## ログレベル

- `info`: 正常な処理フロー
- `error`: エラー発生時
- `warning`: 警告（現在は使用していません）

## セキュリティ上の注意

- 個人情報（会社名、メールアドレス）はマスクして記録されます
- パスワードやカード情報は記録されません
- IPアドレスとユーザーエージェントは記録されます（トラブルシューティング用）

## トラブルシューティング

### ログファイルが見つからない場合

1. ログディレクトリの権限を確認
```bash
docker compose exec app bash -c "cd /var/www && ls -la storage/logs/"
```

2. ログファイルが作成されているか確認
```bash
docker compose exec app bash -c "cd /var/www && ls -lh storage/logs/contract-payment-*.log"
```

### ログが記録されない場合

1. ログチャンネルの設定を確認
```bash
docker compose exec app bash -c "cd /var/www && php artisan config:show logging.channels.contract_payment"
```

2. ログレベルを確認
```bash
docker compose exec app bash -c "cd /var/www && php artisan config:show logging.channels.contract_payment.level"
```

## ログファイルの例

```
[2026-01-13 10:30:45] local.INFO: 申込フォーム表示 {"url":"http://localhost:8080/billing/contract/create?plans=22","plan_ids":[22],"plan_count":1,"ip":"172.18.0.1","user_agent":"Mozilla/5.0...","timestamp":"2026-01-13T10:30:45+09:00"}

[2026-01-13 10:31:20] local.INFO: 確認画面表示 {"contract_plan_id":22,"plan_name":"学習ページ数 50","plan_price":5500,"company_name":"サン***","email":"sam***","ip":"172.18.0.1","user_agent":"Mozilla/5.0...","timestamp":"2026-01-13T10:31:20+09:00"}

[2026-01-13 10:31:45] local.INFO: 決済処理開始 {"contract_plan_id":22,"ip":"172.18.0.1","user_agent":"Mozilla/5.0...","timestamp":"2026-01-13T10:31:45+09:00"}

[2026-01-13 10:31:45] local.INFO: 契約作成完了 {"contract_id":123,"contract_plan_id":22,"status":"draft"}

[2026-01-13 10:31:45] local.INFO: 決済情報作成完了 {"payment_id":456,"contract_id":123,"orderid":"ORD20260113103145123","amount":5500,"status":"created"}

[2026-01-13 10:31:46] local.INFO: F-REGI API呼び出し開始 {"payment_id":456,"orderid":"ORD20260113103145123","api_params":{"SHOPID":"23034","ID":"ORD20260113103145123","PAY":"5500"},"billing_type":"one_time","environment":"test"}

[2026-01-13 10:31:47] local.INFO: F-REGI API呼び出し結果 {"payment_id":456,"result":"OK","settleno":"20260113103147001"}

[2026-01-13 10:31:47] local.INFO: 決済処理完了・リダイレクト {"payment_id":456,"contract_id":123,"orderid":"ORD20260113103145123","settleno":"20260113103147001","payment_page_url":"https://...","processing_time_ms":1250.5}
```

## 実装ファイル

- `app/config/logging.php`: ログチャンネル設定
- `app/app/Http/Controllers/ContractController.php`: ログ記録処理

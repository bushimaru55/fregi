# オプション商品：管理画面操作手順（統合版）

作成日: 2026-01-21  
更新日: 2026-01-21（契約プラン管理に統合）

## 概要

オプション商品の管理は、**契約プラン管理画面**に統合されました。同じ画面でベース商品（契約プラン）とオプション商品の両方を管理できます。

---

## アクセス方法

### ローカル環境
- **管理画面ログイン**: `http://localhost:8080/billing/login`
- **契約プラン管理**: `http://localhost:8080/billing/admin/contract-plans`

### 本番環境
- **管理画面ログイン**: `https://dschatbot.ai/webroot/billing/login`
- **契約プラン管理**: `https://dschatbot.ai/webroot/billing/admin/contract-plans`

### ログイン情報
- **メールアドレス**: `kanri@dschatbot.ai`
- **パスワード**: `cs20051101`

---

## オプション商品の新規登録手順

### 1. 管理画面にログイン

1. ログイン画面にアクセス
2. メールアドレスとパスワードを入力
3. 「ログイン」ボタンをクリック

### 2. 契約プラン管理画面に移動

1. 管理画面のメニューから「契約プラン管理」をクリック
   - または直接 `/billing/admin/contract-plans` にアクセス

### 3. 新規商品を作成

1. 契約プラン管理画面の右上にある「新規作成」ボタンをクリック
2. 商品登録フォームに以下の情報を入力：

   **必須項目:**
   - **商品種別**: 「オプション商品」を選択 ⭐ **重要**
   - **プランコード（ITEM）**: 例）「OPT-SUPPORT」（重複不可）
   - **プラン名（ITEMNAME相当）**: 例）「プライオリティサポート」
   - **料金（AMOUNT相当・税込）**: 例）`5000`（円単位、税込）
   - **表示順**: 例）`1`（数値が小さいほど上に表示）

   **任意項目:**
   - **プラン説明**: 商品の詳細説明（任意）
   - **このプランを有効にする**: チェックを入れる（デフォルトでON）

   **注意**: 商品種別で「オプション商品」を選択すると、以下のフィールドが非表示になります：
   - 契約プランマスター
   - 決済タイプ（オプション商品は常に一回限り）

3. 「作成」ボタンをクリック

### 4. 登録完了確認

- 契約プラン管理画面に戻り、「オプション商品」セクションに登録した商品が表示されることを確認
- 「有効」ステータスになっていることを確認

---

## オプション商品の編集手順

### 1. 契約プラン管理画面から編集対象を選択

1. 契約プラン管理画面（`/billing/admin/contract-plans`）にアクセス
2. 「オプション商品」セクションを確認
3. 編集したい商品の行にある「編集」ボタンをクリック

### 2. 商品情報を編集

1. 商品編集フォームで必要な項目を修正
   - 商品名、商品コード、単価、商品説明、表示順、有効フラグなど
2. 「更新」ボタンをクリック

### 3. 更新完了確認

- 契約プラン管理画面に戻り、変更が反映されていることを確認

---

## オプション商品の削除手順

### 注意事項

⚠️ **重要**: 既に契約で使用されている商品は削除できません。

削除を試みた場合、エラーメッセージが表示され、削除は実行されません。

### 削除手順

1. 契約プラン管理画面で削除したい商品の行にある「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック
3. 削除が完了すると、オプション商品セクションから該当商品が消えます

---

## 画面構成

### 契約プラン管理画面の構成

契約プラン管理画面は、以下の2つのセクションで構成されています：

1. **ベース商品（契約プラン）セクション**
   - 契約プランとして使用される商品
   - `contract_plans`テーブルに保存
   - 月額課金または一回限りを選択可能

2. **オプション商品セクション**
   - ベース商品に追加できるオプション商品
   - `products`テーブルに保存
   - 常に一回限り（買い切り）

---

## 商品種別の説明

### ベース商品（契約プラン）
- 契約プランとして使用される商品
- `contract_plans`テーブルに保存
- 決済タイプ：月額課金または一回限りを選択可能
- 契約プランマスターに紐付け可能

### オプション商品 ⭐
- ベース商品（契約プラン）に追加できるオプション商品
- `products`テーブルに保存
- **常に一回限り（買い切り）**として扱われます
- 申込フォームでチェックボックスで選択可能

---

## オプション商品の設定例

### 例1: プライオリティサポート

- **商品種別**: オプション商品
- **プランコード**: `OPT-SUPPORT`
- **プラン名**: プライオリティサポート
- **料金（税込）**: `5000`
- **プラン説明**: 24時間以内の優先サポート対応
- **表示順**: `1`
- **有効フラグ**: ON

### 例2: データバックアップ

- **商品種別**: オプション商品
- **プランコード**: `OPT-BACKUP`
- **プラン名**: データバックアップ
- **料金（税込）**: `3000`
- **プラン説明**: 月次自動バックアップサービス
- **表示順**: `2`
- **有効フラグ**: ON

### 例3: 追加ストレージ

- **商品種別**: オプション商品
- **プランコード**: `OPT-STORAGE-100`
- **プラン名**: 追加ストレージ 100GB
- **料金（税込）**: `2000`
- **プラン説明**: 追加ストレージ容量 100GB
- **表示順**: `3`
- **有効フラグ**: ON

---

## 申込フォームでの表示確認

### 確認手順

1. 公開ページの申込フォームにアクセス
   - ローカル: `http://localhost:8080/billing/contract/create`
   - 本番: `https://dschatbot.ai/webroot/billing/contract/create`

2. オプション商品セクションを確認
   - 「オプション商品」という見出しが表示される
   - 登録したオプション商品がチェックボックスで表示される
   - 商品名、単価、説明が表示される

3. オプション商品を選択して申込フローを確認
   - チェックボックスを選択
   - 「確認画面へ」をクリック
   - 確認画面で選択したオプション商品と合計金額が表示されることを確認

---

## よくある質問（FAQ）

### Q1: 商品コードは何を入力すればいいですか？

**A**: 商品を識別するための一意のコードです。例：
- `OPT-SUPPORT`（オプション-サポート）
- `OPT-BACKUP`（オプション-バックアップ）
- `PLAN-050`（プラン-50ページ）

重複は不可です（`contract_plans`テーブルと`products`テーブルの両方でチェックされます）。

### Q2: 表示順はどのように設定すればいいですか？

**A**: 数値が小さいほど上に表示されます。
- `1` → 最上部
- `2` → 2番目
- `10` → 10番目

同じ数値の場合は、IDの昇順で表示されます。

### Q3: オプション商品を無効にするとどうなりますか？

**A**: 申込フォームに表示されなくなります。既存の契約には影響しません。

### Q4: 商品を削除できないのはなぜですか？

**A**: 既に契約で使用されている商品は削除できません。削除したい場合は、まず該当する契約を確認してください。

### Q5: オプション商品の価格を変更した場合、既存の契約に影響はありますか？

**A**: ありません。契約明細（`contract_items`）には契約時点の価格がスナップショットとして保存されるため、商品マスタの価格変更は既存契約に影響しません。

### Q6: ベース商品とオプション商品の違いは何ですか？

**A**: 
- **ベース商品**: 契約プランとして使用され、月額課金または一回限りを選択可能
- **オプション商品**: ベース商品に追加できるオプションで、常に一回限り（買い切り）

### Q7: オプション商品を月額課金にすることはできますか？

**A**: いいえ。オプション商品は常に一回限り（買い切り）として扱われます。月額課金が必要な場合は、ベース商品として登録してください。

---

## トラブルシューティング

### エラー: 「商品コードが既に使用されています」

**原因**: 同じ商品コードが既に登録されています（`contract_plans`または`products`テーブル）。

**対処**: 別の商品コードを使用してください。

### エラー: 「この商品は既に契約で使用されているため削除できません」

**原因**: この商品が既に契約明細（`contract_items`）で使用されています。

**対処**: 
1. 該当する契約を確認
2. 削除が必要な場合は、まず契約を削除または変更してから商品を削除

### オプション商品が申込フォームに表示されない

**確認項目:**
1. 商品種別が「オプション商品」になっているか
2. 有効フラグがONになっているか
3. ブラウザのキャッシュをクリアして再読み込み

### 商品種別を選択してもフィールドが非表示にならない

**対処**: 
1. ブラウザのキャッシュをクリア
2. ページを再読み込み
3. JavaScriptが有効になっているか確認

---

## 参考資料

- **実装仕様書**: `オプション商品機能_実装仕様.md`
- **データベース構造**: `オプション商品機能_本番環境マイグレーションSQL.sql`
- **契約プラン管理**: `AIdocs_商品管理と認証機能.md`

---

作成日: 2026-01-21  
更新日: 2026-01-21（契約プラン管理に統合）

# 月額プランの自動引き落としについて

確認日時: 2026-01-13

## 質問

月額プランのクレジットカードの引き落としは自動的に行われますか？

## 回答

**現時点では、月額プランでも自動的な月次引き落としは行われません。**

## 現在の実装状況

### 1. 現在の実装方法

現在のシステムは**リダイレクト決済（compsettleapply.cgi）**を使用しており、これは**一回限りの決済用**のAPIです。

- 月額課金プラン（`billing_type = 'monthly'`）でも、一回限り決済と同じように処理されます
- ユーザーがF-REGIの決済画面でカード情報を入力し、**初回の1回のみ決済が実行**されます
- その後、自動的に毎月引き落とされる機能は実装されていません

### 2. 実装コードの状況

```php
// ContractController.php の実装
// 月額課金プランでも、リダイレクト決済ではMONTHLYMODEを送信しない
// 月額課金の実装が必要な場合は、別のAPIを使用する必要がある
// if ($billingType === 'monthly') {
//     $apiParams['MONTHLYMODE'] = '0'; // リダイレクト決済では指定不可
// }
```

現在の実装では：
- `MONTHLYMODE`パラメータを送信しない（リダイレクト決済では使用不可）
- 月額課金プランも一回限り決済として処理される
- **自動的な月次引き落としは行われない**

## F-REGIの仕様について

### リダイレクト決済（compsettleapply.cgi）の特徴

- **一回限りの決済用**
- ユーザーをF-REGIの決済画面にリダイレクトする
- カード情報はユーザーがF-REGI画面で入力
- `MONTHLYMODE`パラメータは使用できない

### 月次課金サービスの実装方法

F-REGIで月次課金（自動引き落とし）を実装する場合、以下のいずれかの方法が必要です：

1. **F-REGIの月次課金サービスAPIを使用**
   - 別のAPIエンドポイントを使用する可能性がある
   - F-REGI管理画面での月次課金サービスの設定が必要
   - 自動決済のスケジュール設定が必要

2. **オーソリ処理（authm.cgi）に切り替える**
   - 直接APIで決済を実行する方式
   - カード情報を直接送信する必要がある（セキュリティ面での考慮が必要）
   - `MONTHLY`、`MONTHLYMODE`パラメータが使用できる可能性がある
   - ただし、月次課金サービスの設定は別途必要

## 現状の動作

### 月額課金プラン（billing_type = 'monthly'）の場合

1. ユーザーが申込フォームからプランを選択
2. 決済情報を作成
3. F-REGI発行受付API（`compsettleapply.cgi`）を呼び出し
4. お支払い方法選択画面へリダイレクト
5. ユーザーがカード情報を入力
6. **初回の1回のみ決済処理実行**
7. 通知受領（/api/fregi/notify）
8. 戻りURL処理（/return）
9. 契約完了
10. **以降の自動引き落としは行われない**

## 自動引き落としを実装する場合の必要作業

自動的な月次引き落としを実装するには、以下の作業が必要です：

### 1. F-REGIの仕様確認

詳細は `AIdocs/F-REGI月額課金仕様書（authm.cgi）.md` を参照してください。

**重要なポイント:**
- オーソリ処理（`authm.cgi`）を使用する必要がある
- `MONTHLY=1`, `MONTHLYMODE=0` を指定して顧客登録
- `CUSTOMERID` を生成・指定
- 月次売上処理（`salem.cgi`）で `CUSTOMERID` を使用して自動引き落とし

### 2. F-REGI管理画面での設定

- 月次課金サービスの有効化
- 自動決済のスケジュール設定
- 月次課金用の設定確認
- 承認結果通知URLの設定
- 一括売上結果通知URLの設定（必要に応じて）
- IPアドレス制限: `203.76.164.2` をホワイトリストに登録

### 3. 実装作業

#### 3.1 初回決済処理の変更

- リダイレクト決済（`compsettleapply.cgi`）からオーソリ処理（`authm.cgi`）への切り替え
- カード情報の直接入力フォームの実装
- `MONTHLY=1`, `MONTHLYMODE=0` の指定
- `CUSTOMERID` の生成・保存

#### 3.2 月次売上処理の実装

- `salem.cgi` API呼び出し処理の実装
- 月次実行スケジュール（Cron等）の設定
- `CUSTOMERID` を使用した売上処理

#### 3.3 通知処理の実装

- 承認結果通知URL（`/api/fregi/auth-notify` など）の実装
- 一括売上結果通知URL（必要に応じて）の実装
- 通知の検証・処理ロジック

#### 3.4 セキュリティ対応

- PCI DSS準拠の検討（カード情報の直接入力・送信）
- カード情報の暗号化・安全な保存
- トークン化の検討

### 4. テスト

- テスト環境（`/connecttest/`）での動作確認
- 月次課金の自動決済が正常に動作するか確認
- 毎月の自動決済通知を受信できるか確認

## まとめ

| 項目 | 現在の状況 |
|------|-----------|
| **月額プランの自動引き落とし** | ❌ **実装されていない** |
| **月額プランの初回決済** | ✅ 実装済み（一回限り決済として処理） |
| **自動的な月次引き落とし** | ❌ **行われない** |
| **月次課金サービスAPI** | ❌ 未実装 |

**結論**: 現時点では、月額プランでも自動的な月次引き落としは行われません。月額プランも一回限り決済として処理されており、初回の1回のみ決済が実行されます。

自動引き落とし機能を実装する場合は、F-REGIの月次課金サービスAPIの仕様を確認し、別途実装作業が必要です。

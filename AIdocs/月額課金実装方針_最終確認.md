# 月額課金実装方針の最終確認

作成日: 2026-01-13

## ユーザーの要望

1. **カード情報はF-REGI側で管理**
   - カード情報を自社DBに保存する必要はない
   - F-REGIの管理画面で管理を行う

2. **自社システムでの対応範囲**
   - 決済画面と処理のみ対応
   - カード情報の直接入力は不要

## 重要な確認事項

### F-REGIの仕様について

#### 月次売上処理（salem.cgi）
- **CUSTOMERIDのみを指定**して月次売上処理を実行
- カード情報は不要（F-REGI側で管理されている）
- **この部分はユーザーの要望と一致しています**

#### オーソリ処理（authm.cgi）の新規顧客登録
- 新規に顧客を登録する場合、カード情報（PAN1-4, CARDEXPIRY1-2, CARDNAME等）をAPIパラメータで送信する必要がある
- `MONTHLY=1` を指定すると、顧客としてF-REGI側に登録される

#### オーソリ処理（authm.cgi）の既存顧客使用
- 既に登録されている顧客の場合、**CUSTOMERIDのみを指定**すればよい
- カード情報（PAN1-4等）は省略可能

## 実装方針の結論

### ✅ 正しい理解

1. **カード情報の保存**
   - **自社DBにはカード情報を保存しない**
   - **CUSTOMERIDのみを保存する**
   - カード情報はF-REGI側で管理される

2. **月次売上処理（salem.cgi）**
   - **CUSTOMERIDのみを指定**して月次売上処理を実行
   - カード情報は不要
   - ユーザーの要望と一致

### ⚠️ 確認が必要な点

**初回の顧客登録について：**

1. **F-REGI管理画面で既に顧客・カード情報が登録されている場合**
   - 既存のCUSTOMERIDを使用して月額課金を開始できる
   - オーソリ処理（authm.cgi）でCUSTOMERIDのみを指定
   - **この場合はカード情報入力は不要**

2. **新規に顧客を登録する場合**
   - オーソリ処理（authm.cgi）でカード情報を送信する必要がある
   - ただし、ユーザーの要望として「F-REGI側で管理」とのこと

## 推奨される実装方針

### 方針A: F-REGI管理画面で既に顧客情報が登録されている前提

1. **初回決済（顧客登録済みの場合）**
   - F-REGI管理画面で既に顧客・カード情報が登録されている
   - 既存のCUSTOMERIDを取得・使用
   - オーソリ処理（authm.cgi）でCUSTOMERIDのみを指定
   - カード情報は送信しない

2. **月次売上処理（salem.cgi）**
   - CUSTOMERIDのみを指定して月次売上処理を実行
   - カード情報は不要

3. **自社DB**
   - CUSTOMERIDのみを保存
   - カード情報は保存しない

### 方針B: 新規顧客登録が必要な場合（要確認）

もし新規に顧客を登録する必要がある場合は：
- F-REGI管理画面で事前に顧客・カード情報を登録
- または、別の方法で顧客登録を行う
- 自社システムではCUSTOMERIDのみを使用

## 質問

ユーザーの環境では：

1. **F-REGI管理画面で既に顧客・カード情報が登録されていますか？**
   - 既に登録されている場合：CUSTOMERIDのみを使用すればよい

2. **新規顧客の場合、どのように顧客登録を行いますか？**
   - F-REGI管理画面で手動登録？
   - それとも、自社システムからオーソリ処理で登録する必要があるか？

3. **初回決済時のフロー**
   - F-REGI管理画面で事前に顧客登録 → CUSTOMERIDのみを使用
   - または、初回決済時にオーソリ処理で顧客登録 → カード情報入力が必要

## 結論

**カード情報を自社DBに保存する必要はありません。CUSTOMERIDのみを保存すれば十分です。**

月次売上処理（salem.cgi）では、CUSTOMERIDのみを指定すればよく、ユーザーの要望と一致しています。

ただし、初回の顧客登録について、F-REGI管理画面で既に登録されているか、新規登録が必要かを確認する必要があります。

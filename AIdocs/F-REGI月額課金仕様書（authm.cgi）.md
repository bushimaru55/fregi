# F-REGI月額課金仕様書（authm.cgi）

参考資料: F-REGI クレジットカード処理インターフェース仕様書（月次課金仕様 authm.cgi）Ver2.8 2025/07/23版

確認日時: 2026-01-13

## 概要

このドキュメントは、F-REGIの月額課金（月次課金）機能を実装するための仕様書です。

**重要な区別:**
- **リダイレクト決済（compsettleapply.cgi）**: 現在実装済み。一回限りの決済用。ユーザーをF-REGIの決済画面にリダイレクトする。
- **オーソリ処理（authm.cgi）**: 月額課金用。直接APIで決済を実行する。カード情報を直接送信する必要がある。

## 1. オーソリ処理（authm.cgi）

### 1.1 エンドポイント

**本番環境:**
```
https://ssl.f-regi.com/connect/authm.cgi
```

**テスト環境:**
```
https://ssl.f-regi.com/connecttest/authm.cgi
```

### 1.2 顧客登録（初回）のパラメータ

#### 必須パラメータ

| パラメータ名 | 説明 | 形式・制約 |
|------------|------|-----------|
| `SHOPID` | 店舗ID | - |
| `PAY` | 金額（カンマ不要） | - |
| `PAN1` | カード番号1~4桁目 | 半角数字4桁 |
| `PAN2` | カード番号5~8桁目 | 半角数字4桁 |
| `PAN3` | カード番号9~12桁目 | 半角数字4桁 |
| `PAN4` | カード番号13~16桁目（14桁・15桁の場合は前詰め） | 半角数字4桁 |
| `CARDEXPIRY1` | 有効期限（月） | 半角数字2桁 |
| `CARDEXPIRY2` | 有効期限（年） | 半角数字2桁 |
| `CARDNAME` | カード名義 | ASCII文字45文字以内 |

#### 任意パラメータ（月額課金に重要）

| パラメータ名 | 説明 | 形式・制約 | 省略時の扱い |
|------------|------|-----------|------------|
| `ID` | 伝票番号（取引識別用） | 20文字以内の半角英数字とハイフン | 自動採番 |
| `CUSTOMERID` | 顧客番号 | 20文字以内の半角英数字とハイフン | - |
| `MONTHLY` | 月次決済フラグ | `1`: 月次決済（顧客として登録される）<br>`0`: 即時決済（顧客として登録されない） | `0`: 即時決済 |
| `MONTHLYMODE` | 課金タイプ | `0`: 月次課金（データクリーニングが行われる）<br>`1`: 随時課金（データクリーニングが行われない） | `0`: 月次課金 |

**月額課金で重要なポイント:**
- `MONTHLY=1` を指定することで、顧客として登録される
- `CUSTOMERID` を指定することで、後続の月次売上処理で使用できる
- `MONTHLYMODE=0` を指定することで、月次課金として処理される

#### その他のパラメータ

| パラメータ名 | 説明 | 形式・制約 |
|------------|------|-----------|
| `HOLDERMAIL` | カード保有者のメールアドレス | RFC 5322形式、254文字以下 |
| `HOLDERHOMETEL` | カード保有者の自宅電話番号 | 半角15文字以下 |
| `HOLDERMOBILTEL` | カード保有者の携帯電話番号 | 半角15文字以下 |
| `HOLDERWORKTTEL` | カード保有者の職場電話番号 | 半角15文字以下 |
| `SCODE` | セキュリティコード | 3桁または4桁の半角数字（セキュリティコード契約加盟店は必須） |
| `CHARCODE` | 全角を送信する場合のエンコーディング方式 | `euc`, `sjis`, `utf8` | 自動判別 |
| `IP` | 承認時のユーザーのIPアドレス | - |
| `PAYMODE` | 支払方法 | `00`: 1回払い、`01`: リボ払いなど | `00`: 1回払い |
| `SALETOGETHER` | 売上処理を同時に行う | `1`: 承認OKの場合、売上処理を同時に行う<br>`0`: 承認処理のみ行う | `0`: 承認処理のみ行う |
| `REQUIRECOM` | カード会社及びカードブランドを返却 | `1`: 返却、`0`: 返却しない | `0`: 返却しない |
| `REQUIREAREA` | IPに対応する地域情報を要求 | `1`: 要求、`0`: 要求しない | `0`: 要求しない |
| `FREE` | 自由項目 | 最大255バイトの半角文字 |
| `QUIET` | 処理メールを送信 | `1`: 送信しない、`0`: 送信する | `0`: 送信する |

### 1.3 顧客登録済みのカードで承認を取る方法

既に登録されている顧客のカード番号で承認を取る場合：

**省略する引数:**
- `PAN1`, `PAN2`, `PAN3`, `PAN4`
- `CARDEXPIRY1`, `CARDEXPIRY2`
- `CARDNAME`
- `MONTHLY`, `MONTHLYMODE`

**必要な引数:**
- `CUSTOMERID`: 顧客登録時のものを設定

### 1.4 顧客登録情報の変更

**条件:** `MONTHLY=1` でカード承認に通った場合のみ変更可能

**方法:** 該当の `CUSTOMERID` + 変更後の情報で実行

### 1.5 即時決済を選択した場合

- `MONTHLY` パラメータを省略もしくは `0` とした場合
- `CUSTOMERID` の入力は任意
- `CUSTOMERID` が指定されても、顧客の登録及びカード情報の更新は行われない

### 1.6 レスポンス（CGI側からの出力）

**成功時:**
```
1行目: OK
2行目: 承認番号（最大6桁）
3行目: 取引番号 20桁
4行目: 付加情報
```

**失敗時:**
```
1行目: NG
2行目: 失敗理由
```

## 2. 売上処理

### 2.1 通常の売上処理（sale.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/sale.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/sale.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `SEQNO`（必須）: 取引番号（authm.cgiで取得されたもの）
- `IP`（任意）: 売上時のユーザーのIPアドレス
- `QUIET`（任意）: 処理メール送信設定（`1`: 送信しない、`0`: 送信する）

**レスポンス:**
- 成功時: `OK` + 取引番号（20桁）
- 失敗時: `NG` + 失敗理由

### 2.2 売上処理（月次運用）（salem.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/salem.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/salem.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `CUSTOMERID`（必須）: 顧客番号
- `PAY`（必須）: 金額
- `SALEDATE`（任意）: 売上日（YYYY/MM/DD または YYYYMMDD）。省略時は処理実行月の1日
- `QUIET`（任意）: 処理メール送信設定（`1`: 送信しない、`0`: 送信する）

**レスポンス:**
- 成功時: `OK` + 承認番号（最大6桁）+ 取引番号（20桁）
- 失敗時: `NG` + 失敗理由

**月額課金での使用:**
- `CUSTOMERID` を使用して、登録済みの顧客のカード情報で月次売上処理を実行
- カード情報を再入力する必要がない

## 3. 承認取消・売上取消

### 3.1 承認取消（authcancel.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/authcancel.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/authcancel.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `CANCELSEQNO`（必須）: 取消対象の取引番号（authm.cgiで取得したもの）
- `QUIET`（任意）: 処理メール送信設定

**レスポンス:**
- 成功時: `OK`
- 失敗時: `NG` + 失敗理由

### 3.2 売上取消（salecancel.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/salecancel.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/salecancel.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `CANCELSEQNO`（必須）: 取消対象の取引番号（authm.cgiで取得したもの）
- `QUIET`（任意）: 処理メール送信設定

**レスポンス:**
- 成功時: `OK` + 取消を実行した取引番号
- 失敗時: `NG` + 失敗理由

## 4. 承認金額変更・売上金額変更

### 4.1 承認金額変更（authchange.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/authchange.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/authchange.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `SEQNO`（必須）: 変更元取引の取引番号（authm.cgiで取得したもの）
- `PAY`（必須）: 新しい金額
- `QUIET`（任意）: 処理メール送信設定
- `CANCELFIRST`（任意）: `1`: 変更前に元取引を取消、`0`: 変更後に元取引を取消（予め許可設定された加盟店のみ指定可能）

**レスポンス:**
- 成功時: `OK` + 新しい取引番号 + 新しい承認番号
- 失敗時: `NG` + 失敗理由

### 4.2 売上金額変更（salechange.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/salechange.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/salechange.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `SEQNO`（必須）: 変更元取引の取引番号（authm.cgiで取得したもの）
- `PAY`（必須）: 新しい金額
- `QUIET`（任意）: 処理メール送信設定
- `CANCELFIRST`（任意）: `1`: 変更前に元取引を取消、`0`: 変更後に元取引を取消（予め許可設定された加盟店のみ指定可能）

**レスポンス:**
- 成功時: `OK` + 新しい取引番号 + 新しい承認番号
- 失敗時: `NG` + 失敗理由

## 5. 顧客管理

### 5.1 顧客ID削除（leavecustomer.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/leavecustomer.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/leavecustomer.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `CUSTOMERID`（必須）: 顧客番号

**レスポンス:**
- 成功時: `OK`
- 失敗時: `NG` + 失敗理由

### 5.2 顧客情報取得（customerinfo.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/customerinfo.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/customerinfo.cgi`

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `CUSTOMERID`（必須）: 顧客番号
- `GETEXPIRE`（任意）: `0`: カード番号下4桁のみ取得、`1`: カード番号下4桁と有効期限を取得

**レスポンス:**
- 成功時: `OK` + カード番号下4桁 + 有効期限（月）（GETEXPIRE=1の場合）+ 有効期限（年）（GETEXPIRE=1の場合）
- 失敗時: `NG` + 失敗理由

## 6. 売上一括処理（月次運用）

### 6.1 一括売上処理（csvsalem.cgi）

**エンドポイント:**
- 本番: `https://ssl.f-regi.com/connect/csvsalem.cgi`
- テスト: `https://ssl.f-regi.com/connecttest/csvsalem.cgi`

**通信方式:** POST（GETは不可）

**パラメータ:**
- `SHOPID`（必須）: 店舗ID
- `CSVDATA`（必須）: 1行=1売上のCSVデータ（カンマ区切り、改行コードはCR+LF）

**CSVデータ構造:**
1. 伝票番号（20文字以内の半角英数字とハイフン。省略時は自動採番）
2. 顧客番号
3. 金額
4. 売上日（YYYY/MM/DD または YYYYMMDD。省略時は1日）

**レスポンス:**
- 成功時: `OK`（受付成功。実際の処理は非同期で実行される）
- 失敗時: `NG` + 失敗理由

**重要:** 一括売上処理は件数により長時間を要するため、受付に成功した段階で一旦 `OK` を返却し、すべての売上処理が完了したタイミングで改めて F-REGI サーバより御社側システムへと結果の通知を行います。

### 6.2 一括売上結果通知URL

**通知方法:** F-REGIサーバから指定されたURLにPOSTリクエストで送信

**通知データ（CSVDATA形式）:**
1. 伝票番号
2. 顧客番号
3. 金額
4. 売上日
5. 売上結果（`OK` または `NG`）
6. 取引番号（売上結果が `NG` の場合は返却されない場合あり）
7. エラー理由（売上結果が `NG` の場合のみ返却）

**期待される応答:**
- 成功時: 1行目に `OK` を出力

**リトライ:**
- 1回目: 5分後
- 2回目: 55分後
- 失敗時: 55分後のリトライでも `OK` が出力されない場合、決済処理メールアドレスに通知が送信される

**IPアドレス制限:**
- 一括売上結果通知URLへのアクセスをIP制限する場合は、以下のIPを登録: `203.76.164.2`

## 7. 承認結果通知URL

**通知方法:** F-REGIサーバから指定されたURLにリアルタイムで送信

**通知パラメータ:**
- `STATUS`: 承認結果（`OK` または `NG`）
- `ID`: 伝票番号（最大20文字）
- `AUTHCODE`: 承認番号（1-6桁の半角英数字。STATUS=NGの場合は返却されない場合あり）
- `SEQNO`: 取引番号（20桁の半角英数字。STATUS=NGの場合は返却されない場合あり）
- `ERRORCODE`: エラーコード（STATUS=NGの場合のみ）
- `ERRORMSG`: 失敗理由（STATUS=NGの場合のみ）
- `CARDCOM`: カード会社ブランド（REQUIRECOM=1を指定した場合のみ）
- `CARDLID`: 端末処理通番（REQUIRELID=1を指定した場合のみ）
- `IPAREA`: IPに対応する地域情報（REQUIREAREA=1を指定した場合のみ）

**期待される応答:**
- 成功時: 1行目に `OK` を出力

**リトライ:**
- 1回目: 5分後
- 2回目: 55分後
- 失敗時: 55分後のリトライでも `OK` が出力されない場合、決済処理メールアドレスに通知が送信される

**IPアドレス制限:**
- 承認結果通知URLへのアクセスをIP制限する場合は、以下のIPを登録: `203.76.164.2`

## 8. 基本仕様

### 8.1 通信仕様

- **システム様式:** サーバAPI
- **通信種別:** HTTPSプロトコル（暗号化送信）
- **通信方式:** POST（enctypeをapplication/x-www-form-urlencoded）またはGET
- **日本語エンコード:** EUC-JP
- **I/O:** 
  - Input: POST または GET
  - Output: HTTPSレスポンス
  - 3D認証接続I/FではHTTPSリダイレクト

### 8.2 タイムアウト

- ブラウザの保持時間は約30秒を想定
- ネットワーク状況やインターフェース起動時間を考慮
- 注文確認などのメールをシステムから自動送信することを推奨

### 8.3 IPアドレス制限

- IPアドレスによるアクセス制限がございます
- 加盟店側のサーバにモジュール等をお渡しできませんので、インストール等の必要はございません

### 8.4 エラーコード

- エラーコードは、正常に処理が行われなかった際に異常処理の結果として加盟店側のサーバへ送り返します
- エラーコードには、F-REGIサーバから送信されるエラーとF-REGIサーバからさらに先にあるシステムから送信されるエラーがあります
- **パラメータの不備等によるエラーについて:** 取引番号が発行されていない為、管理画面上で確認できない事がありますので、ご注意ください
- エラーコード表は、F-REGI管理画面にログインいただき、エラーコード一覧よりご参照ください

## 9. 現在の実装との関係

### 9.1 現在の実装

現在のシステムは**リダイレクト決済（compsettleapply.cgi）**を使用しています。

- エンドポイント: `https://ssl.f-regi.com/connect/compsettleapply.cgi`
- 用途: 一回限りの決済
- ユーザーをF-REGIの決済画面にリダイレクト
- `MONTHLYMODE`パラメータは使用できない（エラーコードCSA1-1-107）

### 9.2 月額課金の実装に必要な変更

月額課金を実装する場合は、以下の変更が必要です：

1. **オーソリ処理（authm.cgi）への切り替え**
   - 初回決済時: `authm.cgi`を使用
   - `MONTHLY=1`, `MONTHLYMODE=0`を指定
   - `CUSTOMERID`を生成・指定

2. **月次売上処理（salem.cgi）の実装**
   - 毎月の自動引き落とし時: `salem.cgi`を使用
   - `CUSTOMERID`を指定して売上処理を実行

3. **カード情報の直接入力**
   - ユーザーからカード情報を直接受け取る必要がある
   - セキュリティ面での考慮が必要（PCI DSS準拠など）

4. **通知処理の実装**
   - 承認結果通知URLの実装
   - 一括売上結果通知URLの実装（必要に応じて）

## 10. まとめ

| 項目 | リダイレクト決済（現在） | オーソリ処理（月額課金用） |
|------|----------------------|------------------------|
| **APIエンドポイント** | `compsettleapply.cgi` | `authm.cgi` |
| **決済タイプ** | 一回限り | 一回限りまたは月額課金 |
| **カード情報入力** | F-REGI画面 | 自社サイト（直接API） |
| **月額課金対応** | ❌ 不可 | ✅ 可能（`MONTHLY=1`） |
| **自動引き落とし** | ❌ 不可 | ✅ 可能（`salem.cgi`） |
| **CUSTOMERID** | 使用しない | 使用する（月次売上用） |

**結論:**
- 現在の実装（リダイレクト決済）では月額課金の自動引き落としは実装できない
- 月額課金の自動引き落としを実装する場合は、オーソリ処理（authm.cgi）への切り替えが必要

---

作成日: 2026-01-13  
参考資料: F-REGI クレジットカード処理インターフェース仕様書（月次課金仕様 authm.cgi）Ver2.8 2025/07/23版

# 本番環境ファイルアップロード手順（正確版）

作成日: 2026-01-21

## 重要な前提

**本番環境のディレクトリ構成**:
- **アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`
- **公開URL**: `https://dschatbot.ai/webroot/billing/`
- **構成**: `deploy/webroot_billing/` の中身を**そのまま**アップロードする

**注意**: Laravel本体と公開ディレクトリは**分離されていません**。`deploy/webroot_billing/` の中に `app/` ディレクトリ（Laravel本体）が含まれており、それをそのままアップロードします。

---

## デプロイパッケージの構成

```
deploy/webroot_billing/
├── index.php              # エントリーポイント（app/を参照）
├── .htaccess              # Apache設定
├── build/                 # Viteビルド成果物
├── css/                   # CSSファイル
├── js/                    # JavaScriptファイル
├── app/                   # Laravel本体（非公開、.htaccessで保護）
│   ├── .htaccess         # アクセス禁止
│   ├── app/
│   ├── bootstrap/
│   ├── config/
│   ├── database/
│   ├── resources/
│   ├── routes/
│   ├── storage/          # 書き込み権限必要（775）
│   ├── vendor/
│   ├── artisan
│   ├── composer.json
│   └── .env              # 本番環境用設定ファイル
└── README.md
```

---

## FTPアップロード手順

### ステップ1: FTP接続

FTPクライアント（FileZilla、Cyberduck等）を使用して本番サーバーに接続します。

### ステップ2: アップロード先の確認

**アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`

**重要**: このディレクトリに `deploy/webroot_billing/` の中身を**そのまま**アップロードします。

### ステップ3: ファイルのアップロード

`deploy/webroot_billing/` ディレクトリ内の**すべてのファイルとディレクトリ**をアップロードします。

**アップロードする内容**:
- `index.php`
- `.htaccess`
- `build/` ディレクトリ
- `css/` ディレクトリ
- `js/` ディレクトリ
- `app/` ディレクトリ（Laravel本体、vendor含む）
- `favicon.ico`
- `robots.txt`
- その他の静的ファイル

**アップロード時の注意**:
- `.htaccess` ファイルも必ずアップロードしてください
- `app/.htaccess` も必ずアップロードしてください（`app/` ディレクトリへの直接アクセスを禁止）
- ディレクトリ構造を保持したままアップロードしてください

### ステップ4: パーミッションの設定

以下のパーミッションを設定してください：

```bash
# storage ディレクトリの書き込み権限
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/storage

# bootstrap/cache ディレクトリの書き込み権限
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/bootstrap/cache

# storage/logs ディレクトリの書き込み権限
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/storage/logs
```

**注意**: FTPクライアントでパーミッションを設定できない場合は、Pleskファイルマネージャーから設定してください。

### ステップ5: .envファイルの設定

`/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/.env` ファイルを編集します。

**必須設定項目**:
- `APP_ENV=production`
- `APP_DEBUG=false`
- `APP_URL=https://dschatbot.ai/webroot/billing`
- `APP_KEY`（既存の値または新規生成）
- データベース接続情報

**テンプレート**: `AIdocs/本番環境.envテンプレート.txt` を参照してください。

### ステップ6: Config Cacheのクリア（必要に応じて）

`/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/bootstrap/cache/config.php` を削除すると、次回アクセス時に自動的に再生成されます。

---

## 動作確認

### 1. 基本動作確認

- [ ] `https://dschatbot.ai/webroot/billing/` にアクセスできる
- [ ] `https://dschatbot.ai/webroot/billing/build/manifest.json` が 200 OK で返る
- [ ] 新規申込フォームが表示される

### 2. オプション製品機能の確認

- [ ] 製品（契約プラン）を選択すると、オプション製品が動的に表示される
- [ ] ブラウザの開発者ツール（コンソール）でエラーがないことを確認

### 3. セキュリティ確認

以下のURLにアクセスして、**403 Forbidden** が返されることを確認：

- [ ] `https://dschatbot.ai/webroot/billing/app/.env` → 403 Forbidden
- [ ] `https://dschatbot.ai/webroot/billing/app/vendor/` → 403 Forbidden
- [ ] `https://dschatbot.ai/webroot/billing/app/storage/` → 403 Forbidden

---

## トラブルシューティング

### 500 Internal Server Error

**確認事項**:
- `app/storage/` と `app/bootstrap/cache/` のパーミッションが 775 になっているか
- `app/.env` ファイルが正しく設定されているか
- `APP_KEY` が設定されているか

### 404 Not Found

**確認事項**:
- `.htaccess` ファイルが正しく配置されているか
- `index.php` が正しく配置されているか
- Apacheの `mod_rewrite` が有効になっているか

---

## 参考資料

- `deploy/webroot_billing/README.md` - デプロイパッケージの詳細説明
- `AIdocs/deploy_rules.md` - デプロイルール
- `AIdocs/本番環境.envテンプレート.txt` - .envテンプレート

---

作成日: 2026-01-21

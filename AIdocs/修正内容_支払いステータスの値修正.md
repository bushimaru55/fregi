# 修正内容：支払いステータスの値修正

作成日: 2026-01-13

## 問題点

「決済へ進む」ボタンをクリックした際に、以下のエラーが発生しました：

```
SQLSTATE[01000]: Warning: 1265 Data truncated for column 'status' at row 1
```

## 原因

`payments`テーブルの`status`カラムはENUM型で、以下の値のみ許可されています：
- `created`
- `redirect_issued`
- `waiting_notify`
- `paid`
- `failed`
- `canceled`
- `expired`

しかし、コードでは`'completed'`という値を設定しようとしていました。これはENUMに含まれていないため、データベースエラーが発生していました。

**エラーが発生したコード**:
```php
$payment->update([
    'receiptno' => $authCode,
    'slipno' => $seqno,
    'status' => 'completed', // ❌ ENUMに存在しない値
    'completed_at' => now(),
]);
```

## 修正内容

`status`の値を`'completed'`から`'paid'`に変更しました。

**修正箇所**: `app/app/Http/Controllers/ContractController.php`（356行目付近）

```php
// Paymentに承認番号、取引番号を保存
$payment->update([
    'receiptno' => $authCode, // 承認番号
    'slipno' => $seqno, // 取引番号
    'status' => 'paid', // ✅ ENUM値: created, redirect_issued, waiting_notify, paid, failed, canceled, expired
    'completed_at' => now(),
]);
```

## データベーススキーマ

`payments`テーブルの`status`カラム定義（マイグレーションファイルより）:

```php
$table->enum('status', [
    'created',
    'redirect_issued',
    'waiting_notify',
    'paid',          // ← 決済完了時はこの値を使用
    'failed',
    'canceled',
    'expired'
])->default('created')->comment('ステータス');
```

## 動作確認

1. 決済処理を実行
2. F-REGI APIから承認が返ってきた場合
3. `status`が`'paid'`に更新されることを確認
4. データベースエラーが発生しないことを確認

## まとめ

- `payments.status`はENUM型で、`'paid'`が決済完了時の正しい値
- `'completed'`は存在しない値のため、エラーが発生していた
- 修正後は正常に決済処理が完了する

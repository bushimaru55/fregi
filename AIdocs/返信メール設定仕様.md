# 返信メール設定仕様

作成日: 2026-01-30

## 概要

申込完了時に、申込者が入力したメールアドレスに申込内容を含む返信メールを自動送信する機能。管理画面で「上部文章」と「下部文章」を設定でき、メール本文は以下の構成となる。

## メール構成

1. **上部文章**（管理画面で設定）- 挨拶や案内文など
2. **申込内容**（自動生成）- 会社名、プラン、料金、担当者情報など
3. **下部文章**（管理画面で設定）- 署名や連絡先など

## 画面・ルート

| 画面 | URL | 説明 |
|------|-----|------|
| サイト管理（一覧） | `/billing/admin/site-settings` | 返信メール設定のプレビューと編集リンク |
| 返信メール設定編集 | `/billing/admin/site-settings/reply-mail/edit` | 上部文章・下部文章を編集 |

## データベース

`site_settings` テーブルに以下のキーで保存：

| key | 説明 | 最大文字数 |
|-----|------|------------|
| `reply_mail_header` | 上部文章（テキスト形式） | 10,000文字 |
| `reply_mail_footer` | 下部文章（テキスト形式） | 10,000文字 |

## メール仕様

| 項目 | 値 |
|------|-----|
| 件名 | 「【申込受付完了】DSchatbotサービスへのお申し込みありがとうございます」 |
| 送信先 | 申込フォームで入力されたメールアドレス（`contracts.email`） |
| 送信タイミング | 申込完了時（`ContractController::store()`） |
| 形式 | HTML形式 |

## ファイル構成

| ファイル | 説明 |
|----------|------|
| `app/Mail/ContractReplyMail.php` | 返信メール用Mailableクラス |
| `resources/views/emails/contract-reply.blade.php` | メールテンプレート |
| `resources/views/admin/site-settings/edit-reply-mail.blade.php` | 編集画面ビュー |

## メール内容

### 自動挿入される申込内容

- **お申し込み内容**
  - 受付番号
  - 契約プラン
  - 料金
  - 利用開始希望日

- **オプション商品**（選択時のみ）
  - 各オプション商品名・料金
  - オプション小計
  - 合計金額

- **お客様情報**
  - 会社名（フリガナ含む）
  - 部署名・役職（入力時のみ）
  - 担当者名（フリガナ含む）
  - メールアドレス
  - 電話番号
  - 住所（入力時のみ）

- **ご利用情報**
  - ご利用URL・ドメイン
  - 体験版からのインポート希望

## 動作フロー

1. 申込者が申込フォームに必要事項を入力
2. 確認画面で「申し込む」をクリック
3. `ContractController::store()` で契約データ作成
4. 管理者への通知メール送信（既存機能）
5. **申込者への返信メール送信**（本機能）
   - `SiteSetting` から上部文章・下部文章を取得
   - `ContractReplyMail` でメール生成
   - 申込者のメールアドレスに送信
6. 完了画面へリダイレクト

## ログ

申込者への返信メール送信結果は以下のログチャンネルに記録：

- `contract_payment` チャンネル
- `mail` チャンネル

### 成功時
```
申込者への返信メール送信完了
- contract_id: 契約ID
- to: 送信先メールアドレス
```

### エラー時
```
申込者への返信メール送信エラー
- contract_id: 契約ID
- to: 送信先メールアドレス
- error_message: エラーメッセージ
- exception_class: 例外クラス
```

## 変更履歴

| 日付 | 変更者 | 変更内容 |
|------|--------|----------|
| 2026-01-30 | AI | 初版作成 |

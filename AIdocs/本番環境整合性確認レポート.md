# 本番環境整合性確認レポート

作成日: 2026-01-15

## 本番環境情報（AIdocsより）

### 基本情報
- **本番URL**: `https://dschatbot.ai/billing/`
- **技術スタック**: Laravel 10 / PHP 8.1
- **本番サーバ**: Apache + FastCGI（公開ディレクトリは `httpdocs/webroot`）
- **デプロイ方法**: SSHなし・Composerなし → ローカルで構築してFTPアップロード（publicのみ公開、本体は公開領域外）

### ディレクトリ構成（本番）
- **公開ディレクトリ（Laravel public）**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`
- **本体（非公開）**: `/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/`

### FTPアップロード方針
- `httpdocs/laravel_billing/` に Laravel本体（vendor含む）をアップロード
- `httpdocs/webroot/billing/` に `public/` のみアップロード
- `webroot/billing/index.php` から本体の `vendor/autoload.php` と `bootstrap/app.php` を参照するように書き換える（絶対パス推奨）

---

## 現在の実装との整合性確認

### ✅ 整合性が取れている項目

#### 1. URL設計
- **本番URL**: `https://dschatbot.ai/billing/` ✅
- **ローカルURL**: `http://localhost:8080/billing/` ✅
- **ベースパス**: `/billing` で統一 ✅

#### 2. 環境判定ロジック
- **実装箇所**: `ContractController::store()`, `ReturnController::handle()`, `FregiPaymentService::issuePayment()`
- **判定方法**: `env('APP_ENV') === 'production' ? 'prod' : 'test'` ✅
- **F-REGI環境**: 本番環境では `prod`、それ以外は `test` を使用 ✅

#### 3. 設定ファイル
- **`config/app.php`**: 
  - `'env' => env('APP_ENV', 'production')` ✅
  - `'url' => env('APP_URL', 'http://localhost')` ✅
- **デフォルト値**: 本番環境を想定した設定 ✅

#### 4. Nginx設定（ローカル）
- **ベースパス**: `/billing/` で設定 ✅
- **本番再現**: ローカルでも `/billing` ベースで動作 ✅

#### 5. セッション設定
- **SESSION_COOKIE**: `billing_session` ✅
- **SESSION_PATH**: `/billing` ✅
- **Cookie衝突回避**: 本番同一ドメイン想定で設定 ✅

#### 6. デフォルトURL（ビュー）
- **製品ページURL**: デフォルト `https://www.dschatbot.ai/` ✅
- **トップページURL**: 設定可能（デフォルトは `url('/')`） ✅

---

### ⚠️ 確認が必要な項目

#### 1. 本番環境のデータベース設定
- **現状**: ドキュメントに本番DBの詳細情報が記載されていない
- **確認事項**:
  - 本番DBのホスト名
  - 本番DBのデータベース名
  - 本番DBのユーザー名・パスワード
  - 本番DBの接続方式（ソケット/ネットワーク）

#### 2. 本番環境の `.env` 設定
- **現状**: ローカル用の `.env` のみ存在
- **確認事項**:
  - `APP_ENV=production` が設定されているか
  - `APP_DEBUG=false` が設定されているか
  - `APP_URL=https://dschatbot.ai/billing` が設定されているか
  - 本番DB接続情報が正しく設定されているか
  - `FREGI_SECRET_KEY` が設定されているか

#### 3. 本番環境の `index.php` パス設定
- **現状**: ドキュメントに記載されているが、実装ファイルが存在しない
- **確認事項**:
  - `webroot/billing/index.php` が正しく設定されているか
  - 本体へのパス参照（`/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/`）が正しいか

#### 4. 本番環境のF-REGI設定
- **現状**: 管理画面から設定可能だが、本番環境の設定値が不明
- **確認事項**:
  - 本番環境のF-REGI設定（SHOPID、接続パスワード等）がDBに登録されているか
  - `environment=prod` の設定が存在するか

#### 5. 本番環境のファイルパーミッション
- **現状**: ドキュメントに記載なし
- **確認事項**:
  - `storage/` ディレクトリの書き込み権限
  - `bootstrap/cache/` ディレクトリの書き込み権限

---

### 📝 推奨される確認手順

#### 1. 本番環境への接続確認
```bash
# 本番環境のURLにアクセスして動作確認
curl https://dschatbot.ai/billing/
```

#### 2. 本番環境のログ確認
- エラーログの確認
- アプリケーションログの確認

#### 3. 本番環境のデータベース確認
- マイグレーションが適用されているか
- F-REGI設定が登録されているか
- 管理者アカウントが作成されているか

#### 4. 本番環境のF-REGI設定確認
- 管理画面から本番環境のF-REGI設定を確認
- `environment=prod` の設定が存在するか確認

---

## phpinfo()確認結果（2026-01-15）

### ✅ 確認できた情報

#### 1. PHPバージョン
- **PHP Version**: 8.1.33 ✅
- **ドキュメント記載**: PHP 8.1 ✅
- **整合性**: ✅ 一致

#### 2. サーバー環境
- **Server API**: CGI/FastCGI ✅
- **ドキュメント記載**: Apache + FastCGI ✅
- **整合性**: ✅ 一致（FastCGIで動作）

#### 3. システム情報
- **OS**: Linux (Red Hat Enterprise Linux release 9.6)
- **ホスト名**: svs60.dsbsv.net
- **アーキテクチャ**: x86_64

#### 4. ディレクトリ構成
- **Document Root**: `/var/www/vhosts/dschatbot.ai/httpdocs` ✅
- **Script Filename**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/info.php` ✅
- **ドキュメント記載**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/` ✅
- **整合性**: ✅ 完全一致

#### 5. ベースパス
- **REQUEST_URI**: `/billing/info.php` ✅
- **SCRIPT_URL**: `/billing/info.php` ✅
- **ドキュメント記載**: `/billing/` ✅
- **整合性**: ✅ 一致

#### 6. PHP設定ファイル
- **Configuration File Path**: `/etc/opt/remi/php81`
- **Loaded Configuration File**: `/var/www/vhosts/dschatbot.ai/httpdocs/cgi-bin/.cgi_wrapper/php.ini`
- **Custom PHP INI**: `/var/www/vhosts/system/dschatbot.ai/etc/php.ini`

#### 7. タイムゾーン
- **date.timezone**: `Asia/Tokyo` ✅
- **ドキュメント記載**: `Asia/Tokyo` ✅
- **整合性**: ✅ 一致

#### 8. 必要な拡張機能
- **PDO**: ✅ 有効 (mysql, pgsql, sqlite)
- **pdo_mysql**: ✅ 有効
- **mysqli**: ✅ 有効
- **mbstring**: ✅ 有効
- **curl**: ✅ 有効
- **openssl**: ✅ 有効
- **json**: ✅ 有効
- **zip**: ✅ 有効
- **gd**: ✅ 有効
- **intl**: ✅ 有効
- **xml**: ✅ 有効
- **session**: ✅ 有効

#### 9. メモリ・実行時間設定
- **memory_limit**: 518M (Local) / 128M (Master)
- **max_execution_time**: 360秒
- **max_input_time**: 360秒
- **post_max_size**: 128M
- **upload_max_filesize**: 128M

#### 10. OPcache設定
- **Status**: Up and Running ✅
- **Optimization**: Enabled ✅
- **SHM Cache**: Enabled ✅
- **Cached scripts**: 640
- **Used memory**: 31,683,696 bytes

---

### ⚠️ 改善が必要な項目（セキュリティ - 後で対応）

**注意**: 現在ドメイン全体にBasic認証がかかっているため、まずはシステムが正常に動作することを優先します。セキュリティ設定の改善は後で対応します。

#### 1. エラー表示設定（セキュリティ）
- **display_errors**: `On` ⚠️
  - **推奨**: `Off` (本番環境ではエラーを表示しない)
- **display_startup_errors**: `On` ⚠️
  - **推奨**: `Off` (本番環境ではエラーを表示しない)
- **log_errors**: `Off` ⚠️
  - **推奨**: `On` (エラーログを記録する)

**影響**: 本番環境でエラーが表示されると、システム情報が漏洩する可能性があります。

**対応タイミング**: システムが正常に動作することを確認してから対応

**対応方法**: 
- `/var/www/vhosts/system/dschatbot.ai/etc/php.ini` または
- `/var/www/vhosts/dschatbot.ai/httpdocs/cgi-bin/.cgi_wrapper/php.ini` で設定を変更

```ini
display_errors = Off
display_startup_errors = Off
log_errors = On
error_log = /var/www/vhosts/dschatbot.ai/logs/php_errors.log
```

#### 2. セッション設定（セキュリティ）
- **session.cookie_httponly**: `0` ⚠️
  - **推奨**: `1` (XSS攻撃対策)
- **session.cookie_secure**: `0` ⚠️
  - **推奨**: `1` (HTTPS環境では必須)
- **session.use_strict_mode**: `0` ⚠️
  - **推奨**: `1` (セッションフィクセーション対策)

**影響**: セキュリティリスクが高まります。

**対応タイミング**: システムが正常に動作することを確認してから対応

**対応方法**: PHP設定ファイルで変更
```ini
session.cookie_httponly = 1
session.cookie_secure = 1
session.use_strict_mode = 1
```

---

## 整合性確認結果

### ✅ 整合性が取れている項目: 10項目
1. URL設計 ✅
2. 環境判定ロジック ✅
3. 設定ファイル ✅
4. Nginx設定（ローカル） ✅
5. セッション設定 ✅
6. デフォルトURL（ビュー） ✅
7. PHPバージョン ✅
8. サーバー環境 ✅
9. ディレクトリ構成 ✅
10. 必要な拡張機能 ✅

### ⚠️ 確認が必要な項目: 5項目

#### 優先度: 高（動作確認）
1. 本番環境のデータベース設定（phpinfo()からは確認不可）
2. 本番環境の `.env` 設定（phpinfo()からは確認不可）
3. 本番環境のF-REGI設定（phpinfo()からは確認不可）
4. Apache設定（`.htaccess`）の動作確認

#### 優先度: 中（セキュリティ改善 - 後で対応）
5. **エラー表示設定** (display_errors, display_startup_errors, log_errors)
   - **対応タイミング**: システムが正常に動作することを確認してから対応
   - **理由**: 現在Basic認証がかかっているため、まずは動作確認を優先
6. **セッションセキュリティ設定** (cookie_httponly, cookie_secure, use_strict_mode)
   - **対応タイミング**: システムが正常に動作することを確認してから対応
   - **理由**: 現在Basic認証がかかっているため、まずは動作確認を優先

---

## 次のステップ

### 優先度: 高（動作確認・システム稼働）

**注意**: 現在ドメイン全体にBasic認証がかかっているため、まずはシステムが正常に動作することを優先します。セキュリティ設定の改善は後で対応します。

1. **本番環境の動作確認（最優先）**
   - 公開ページの動作確認
     - `https://dschatbot.ai/billing/` にアクセス
     - 新規申込フォームが表示されるか確認
   - 管理画面の動作確認
     - `https://dschatbot.ai/billing/login` にアクセス
     - ログインが正常に動作するか確認
     - ダッシュボードが表示されるか確認
   - ルーティングの確認
     - 404エラーが発生しないか確認
     - 各ページが正しく表示されるか確認

2. **本番環境の `.env` 設定を確認**
   - 本番環境の `.env` ファイルの内容を確認
   - `APP_ENV=production` が設定されているか確認
   - `APP_DEBUG=false` が設定されているか確認（動作確認後はfalse推奨）
   - `APP_URL=https://dschatbot.ai/billing` が設定されているか確認
   - 必要に応じて設定値を修正

3. **本番環境のデータベース設定を確認**
   - 本番DBの接続情報を確認
   - マイグレーションが適用されているか確認
   - 管理者アカウントが作成されているか確認

4. **本番環境のF-REGI設定を確認**
   - 管理画面から本番環境のF-REGI設定を確認
   - `environment=prod` の設定が存在するか確認
   - 必要に応じて設定を追加・修正

5. **Apache設定（`.htaccess`）の確認**
   - ルーティングが正しく動作するか確認
   - 問題が発生した場合は `RewriteBase /billing/` を追加

### 優先度: 中（セキュリティ改善 - 後で対応）

**注意**: システムが正常に動作することを確認してから対応します。

6. **PHP設定の修正（セキュリティ強化）**
   - `display_errors = Off` に変更
   - `display_startup_errors = Off` に変更
   - `log_errors = On` に変更
   - `session.cookie_httponly = 1` に変更
   - `session.cookie_secure = 1` に変更
   - `session.use_strict_mode = 1` に変更

   **設定ファイルの場所**:
   - `/var/www/vhosts/system/dschatbot.ai/etc/php.ini` または
   - `/var/www/vhosts/dschatbot.ai/httpdocs/cgi-bin/.cgi_wrapper/php.ini`

   **対応タイミング**: システムが正常に動作することを確認してから対応

### 優先度: 低（テスト・検証）

7. **決済フローの動作確認（テスト環境で）**
   - テスト環境での決済フローの動作確認
   - 本番環境での動作確認（Basic認証解除後）

---

## 参考資料

- `AIdocs/AIdocs_Cursor指示書_Billingアプリ_ローカルDocker開始.md`
- `README.md`

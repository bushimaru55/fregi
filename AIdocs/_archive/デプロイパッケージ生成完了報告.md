# デプロイパッケージ生成完了報告

作成日: 2026-01-15

## 作業概要

本番環境用のデプロイパッケージ（`deploy/webroot_billing/`）を正常に生成しました。

---

## 実行した作業

### 1. デプロイパッケージ生成スクリプトの作成

**ファイル**: `scripts/build_deploy_webroot_billing.sh`

**主な機能:**
- 既存のデプロイパッケージのバックアップ
- Viteビルドの自動実行
- 公開ディレクトリのコピー（.htaccess, build/, css/, js/, favicon.ico, robots.txt）
- Laravel本体のコピー（app/, bootstrap/, config/, database/, resources/, routes/, storage/, artisan, composer.json, composer.lock）
- app/.htaccessの作成（Require all denied）
- composer installの実行（--no-dev）
- パーミッションの設定（storage/, bootstrap/cache/）

### 2. デプロイパッケージの生成

**生成先**: `deploy/webroot_billing/`

**生成されたファイル/ディレクトリ:**

#### 公開ディレクトリ（webroot_billing/ 直下）
- ✅ `index.php` - パス修正済み（`app/` を参照）
- ✅ `.htaccess` - RewriteBase追加済み（`/webroot/billing/`）
- ✅ `build/` - Viteビルド成果物
  - `manifest.json` ✅
  - `assets/app-*.css` ✅
  - `assets/app-*.js` ✅
- ✅ `css/` - Filament CSSファイル
- ✅ `js/` - Filament JSファイル
- ✅ `favicon.ico`
- ✅ `robots.txt`
- ✅ `README.md` - FTPアップロード手順

#### Laravel本体（webroot_billing/app/ 配下）
- ✅ `app/` - アプリケーションコード
- ✅ `bootstrap/` - ブートストラップファイル
- ✅ `config/` - 設定ファイル
- ✅ `database/` - マイグレーション・シーダー
- ✅ `resources/` - ビュー・アセット
- ✅ `routes/` - ルート定義
- ✅ `storage/` - ストレージ（書き込み権限必要: 775）
- ✅ `vendor/` - Composer依存関係（--no-devで生成）
- ✅ `artisan` - Artisanコマンド
- ✅ `composer.json` - Composer設定
- ✅ `composer.lock` - Composerロックファイル
- ✅ `.htaccess` - アクセス禁止設定（Require all denied）
- ⏳ `.env` - 手動で設定が必要

### 3. 重要な設定ファイル

#### index.php
```php
require __DIR__.'/app/vendor/autoload.php';
$app = require_once __DIR__.'/app/bootstrap/app.php';
```
- ✅ パス参照が正しく設定されています

#### .htaccess（公開ディレクトリ）
```apache
RewriteBase /webroot/billing/
```
- ✅ RewriteBaseが追加されています

#### app/.htaccess
```apache
Require all denied
```
- ✅ app/ディレクトリへの直接アクセスが禁止されています

---

## 生成結果

### パッケージサイズ
- **総サイズ**: 約67MB
- **ファイル数**: 10,592ファイル

### 確認済み項目

- ✅ `build/manifest.json` が存在
- ✅ `app/.htaccess` が存在（Require all denied）
- ✅ `vendor/` ディレクトリが存在
- ✅ `storage/` ディレクトリが存在（書き込み権限設定済み）
- ✅ `bootstrap/cache/` ディレクトリが存在（書き込み権限設定済み）

### 手動設定が必要な項目

- ⏳ `app/.env` ファイルの設定
  - テンプレート: `AIdocs/本番環境.envテンプレート.txt`
  - 必須設定: `APP_ENV=production`, `APP_DEBUG=false`, `APP_URL=https://dschatbot.ai/webroot/billing`

---

## デプロイ手順

### 1. .envファイルの設定

`deploy/webroot_billing/app/.env` を作成し、以下を設定：

```env
APP_ENV=production
APP_DEBUG=false
APP_URL=https://dschatbot.ai/webroot/billing
DB_CONNECTION=mysql
DB_HOST=localhost
DB_DATABASE=your_database
DB_USERNAME=your_username
DB_PASSWORD=your_password
SESSION_COOKIE=billing_session
SESSION_PATH=/webroot/billing
（旧決済用の秘密鍵項目は削除済み）
```

### 2. FTPアップロード

**アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`

`deploy/webroot_billing/` 内のすべてのファイルとディレクトリをアップロードします。

### 3. パーミッション設定

```bash
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/storage
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/app/bootstrap/cache
```

### 4. 動作確認

**正常にアクセスできるURL:**
- `https://dschatbot.ai/webroot/billing/` - トップページ
- `https://dschatbot.ai/webroot/billing/build/manifest.json` - ビルド成果物

**403エラーが返るべきURL（セキュリティ確認）:**
- `https://dschatbot.ai/webroot/billing/app/.env` - 403エラー
- `https://dschatbot.ai/webroot/billing/app/vendor/` - 403エラー
- `https://dschatbot.ai/webroot/billing/app/storage/` - 403エラー

---

## 生成されたファイルの詳細

### スクリプト
- `scripts/build_deploy_webroot_billing.sh` - デプロイパッケージ生成スクリプト

### ドキュメント
- `AIdocs/デプロイパッケージ可視化_完全版.md` - 可視化結果
- `AIdocs/デプロイパッケージ生成計画.md` - 生成計画
- `AIdocs/現状とデプロイ成果物の可視化.md` - 現状と成果物の可視化
- `deploy/webroot_billing/README.md` - FTPアップロード手順

---

## 次のステップ

1. ✅ デプロイパッケージ生成（完了）
2. ⏳ `app/.env` ファイルの設定
3. ⏳ FTPアップロード
4. ⏳ パーミッション設定
5. ⏳ 動作確認

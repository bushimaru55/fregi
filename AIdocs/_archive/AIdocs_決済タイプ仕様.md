# 決済タイプ（一回限り/月額課金）仕様書

作成日: 2026-01-13  
最終更新: 2026-01-13

## 概要

契約プランに決済タイプ（一回限り/月額課金）を追加し、商品によって異なる決済方式をサポートする仕様を定義します。

**重要:** 各契約プラン（商品）に対して、決済タイプは必ず1対1で紐づきます。

## データベース設計

### contract_plansテーブルへの追加

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| billing_type | ENUM | NOT NULL, DEFAULT 'one_time' | 決済タイプ（one_time: 一回限り, monthly: 月額課金） |

**1対1の紐づけ保証:**
- 各契約プランは必ず1つの決済タイプを持つ（1対1の関係）
- `NOT NULL`制約により、NULL値は許可されない
- `DEFAULT 'one_time'`により、新規作成時のデフォルト値が設定される

**値の定義:**
- `one_time`: 一回限りの決済（リダイレクト決済）
- `monthly`: 月額課金（決済連携先の月額課金サービス）

**デフォルト値:** `one_time`

## 実装内容

### 1. データベーススキーマ

**マイグレーション:** `2026_01_13_025452_add_billing_type_to_contract_plans_table.php`

```php
$table->enum('billing_type', ['one_time', 'monthly'])
    ->default('one_time')
    ->after('price')
    ->comment('決済タイプ（one_time: 一回限り, monthly: 月額課金）');
```

### 2. モデル（ContractPlan）

**追加フィールド:**
- `billing_type` - fillableに追加

**追加メソッド:**
- `getBillingTypeLabelAttribute()`: 決済タイプのラベルを取得（一回限り/月額課金）
- `scopeOneTime($query)`: 一回限りの決済プランのみを取得
- `scopeMonthly($query)`: 月額課金プランのみを取得

**修正メソッド:**
- `getFormattedPriceAttribute()`: 月額課金の場合は「/月」を付加

### 3. 契約プラン管理画面

**フォーム（_form.blade.php）:**
- 決済タイプ選択フィールドを追加（プルダウン）
  - 一回限り
  - 月額課金
- JavaScriptで決済タイプに応じて料金の単位表示を変更（「円」→「円/月」）

**一覧画面（index.blade.php）:**
- 決済タイプ列を追加
- 月額課金: 青色バッジ「月額課金」
- 一回限り: グレー色バッジ「一回限り」

**コントローラー（ContractPlanController）:**
- `store()`: `billing_type`のバリデーションを追加（required|in:one_time,monthly）
- `update()`: 同様に`billing_type`のバリデーションを追加

### 4. 決済処理（ContractController）

**store()メソッド:**
- プランの`billing_type`を確認
- 決済連携（ROBOT PAYMENT 等）の API を呼び出し、決済画面へリダイレクトする
- 一回限り・月額課金の区別は、決済連携先の仕様に応じてパラメータやエンドポイントを切り替える

### 5. 表示・UI

**料金表示:**
- 一回限り: `5,500円`
- 月額課金: `5,500円/月`

**管理画面での表示:**
- 契約プラン一覧: 決済タイプをバッジで表示
- 契約プラン詳細: 決済タイプを表示（実装が必要）

## 決済フロー

### 一回限りの決済（billing_type = 'one_time'）

1. ユーザーが申込フォームからプランを選択
2. 決済情報を作成
3. 決済連携（ROBOT PAYMENT 等）の API を呼び出し
4. お支払い方法選択画面へリダイレクト
5. ユーザーがカード情報を入力
6. 決済処理実行
7. 通知受領（実装する決済方式のエンドポイント）
8. 戻りURL処理（/return）
9. 契約完了

**現在の実装:** 決済連携（ROBOT PAYMENT）実装に合わせて対応

### 月額課金（billing_type = 'monthly'）

1. ユーザーが申込フォームからプランを選択
2. 決済情報を作成
3. 決済連携の API を呼び出し（月額課金用パラメータ・エンドポイント）
4. お支払い方法選択画面へリダイレクト
5. ユーザーがカード情報を入力
6. 決済処理実行（初回決済）
7. 通知受領（実装する決済方式のエンドポイント）
8. 戻りURL処理（/return）
9. 契約完了
10. **毎月自動的に決済が実行される（決済連携先側で処理）**

**現在の実装:** 決済連携（ROBOT PAYMENT）実装に合わせて対応

## 今後の拡張（必要に応じて）

月額課金をさらに充実させるためには、以下を検討してください：

1. **決済連携先の月次課金サービス設定**
   - 決済連携先（ROBOT PAYMENT 等）の管理画面で月次課金の設定を確認
   - 自動決済のスケジュール設定を確認

2. **月額課金の通知処理**
   - 毎月の自動決済通知を受信する処理を実装
   - 通知パラメータの仕様を決済連携先のドキュメントで確認

3. **月額課金の管理機能**
   - 契約プラン詳細画面で決済タイプを表示
   - 月額課金契約の一覧表示
   - 月額課金契約のキャンセル機能

## 推奨事項

### 次のステップ（必要に応じて）

1. **テスト環境での動作確認**
   - 決済連携先のテスト環境で月額課金プランの決済をテスト
   - 月次課金として正しく処理されることを確認

2. **決済連携先の管理画面での確認**
   - 月次課金サービスの設定を確認
   - 自動決済の設定を確認

3. **月額課金の自動決済確認**
   - 月額課金契約の自動決済が正常に動作するか確認
   - 毎月の自動決済通知を受信できるか確認

4. **管理機能の拡張（必要に応じて）**
   - 月額課金契約の管理機能を実装
   - 月額課金契約のキャンセル機能を実装

---

作成日: 2026-01-13  
最終更新: 決済連携（ROBOT PAYMENT 予定）前提に整理

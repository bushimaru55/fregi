# F-REGI カード月次登録フラグ（MONTHLYMODE）確認結果

確認日時: 2026-01-13  
最終更新: 2026-01-13

## 確認内容

F-REGIの「カード月次登録フラグ（MONTHLYMODE）」が現在どのように設定されているかを確認しました。

## 確認結果

### ✅ **MONTHLYMODEパラメータを実装しました（2026-01-13更新）**

## MONTHLYMODEパラメータの仕様

**パラメータ名:** `MONTHLYMODE`（カード月次登録フラグ）  
**任意パラメータ:** はい

**値の定義:**
- `0`: 月次課金（データクリーニングが行われる）
- `1`: 随時課金（データクリーニングが行われない）
- **省略時**: 「1:随時課金」扱い（デフォルト）

## 実装状況（2026-01-13更新）

### 1. 現在の実装（2026-01-13更新後）

現在の実装では、**プランの決済タイプ（billing_type）に応じてMONTHLYMODEパラメータを送信します**。

**ContractController.php（実装コード）:**
```php
// 発行受付APIのパラメータを構築
$apiParams = [
    'SHOPID' => $fregiConfig->shopid,
    'ID' => $payment->orderid, // 伝票番号（最大20文字）
    'PAY' => (string)$payment->amount, // 金額
];

// MONTHLYMODE（カード月次登録フラグ）を設定
// 0: 月次課金（データクリーニングが行われる）
// 1: 随時課金（データクリーニングが行われない）
// 省略時は「1:随時課金」扱い
if ($billingType === 'monthly') {
    $apiParams['MONTHLYMODE'] = '0'; // 月額課金
} else {
    // 一回限りの場合は省略（デフォルトが1なので省略可）
}
```

**動作:**
- `billing_type = 'one_time'`（一回限り）: `MONTHLYMODE`を省略（デフォルトで`1:随時課金`）
- `billing_type = 'monthly'`（月額課金）: `MONTHLYMODE = '0'`を送信（月次課金）

### 2. サンプルプログラムの確認

F-REGIから提供されているサンプルプログラム（`compsettleapply_sample.php`）にも、カード月次登録フラグに関連するパラメータは含まれていません。

サンプルプログラムに含まれるパラメータ：
- `SHOPID` - 必須
- `ID` - 必須
- `PAY` - 必須
- `USERNAME1`, `USERNAME2` - 任意
- `USERNAMEKANA1`, `USERNAMEKANA2` - 任意
- `USERTEL` - 任意
- `ITEMTITLE`, `ITEMNAME`, `ITEMNAMEKANA` - 任意
- `EXPIRE` - 任意
- `CHARCODE` - 任意
- `QUIET` - 任意

**カード月次登録フラグは含まれていません。**

## カード月次登録フラグとは

### 概念の整理

F-REGIには、以下の2つの異なる概念があります：

1. **AUTOREGISTER（カード登録方式フラグ）**
   - `0`（または省略）: 選択登録（ユーザーがカード情報を登録するかどうかを選択できる）
   - `1`: 自動登録（カード情報が自動的に登録される）
   - **用途**: 一回限りの決済で、カード情報を保存するかどうかを制御

2. **カード月次登録フラグ（月次課金サービス）**
   - F-REGIの「月次課金サービス」機能で使用される
   - **用途**: 定期課金（月額課金）サービスで使用
   - 月次課金サービスは、F-REGI管理画面のメニューに「月次課金サービス」として存在する
   - 現在のシステムでは使用していない

### 現在のシステムの性質

現在のシステムは、**一回限りの決済**（リダイレクト決済）を使用しており、**月次課金サービス（定期課金）は使用していません**。

そのため、カード月次登録フラグは実装されていません。

## まとめ（2026-01-13更新）

| 項目 | 内容 |
|------|------|
| **MONTHLYMODE（カード月次登録フラグ）** | ✅ 実装済み（2026-01-13） |
| **実装方法** | `billing_type`に応じて`MONTHLYMODE`を送信 |
| **一回限り（billing_type = 'one_time'）** | `MONTHLYMODE`を省略（デフォルト: `1:随時課金`） |
| **月額課金（billing_type = 'monthly'）** | `MONTHLYMODE = '0'`を送信（月次課金） |
| **AUTOREGISTER（カード登録方式）** | 省略（デフォルト: 選択登録） |

## 実装の詳細

### MONTHLYMODEパラメータの動作

1. **一回限りの決済（billing_type = 'one_time'）**
   - `MONTHLYMODE`パラメータを省略
   - F-REGI側で自動的に「1:随時課金」として処理される
   - データクリーニングが行われない

2. **月額課金（billing_type = 'monthly'）**
   - `MONTHLYMODE = '0'`を送信
   - F-REGI側で「0:月次課金」として処理される
   - データクリーニングが行われる

### 注意事項

- `MONTHLYMODE = '0'`を送信することで、月次課金として処理されますが、F-REGI管理画面での月次課金サービスの設定も必要になる可能性があります
- 月次課金の自動決済処理の詳細については、F-REGIの仕様書を確認してください

## 補足情報

### F-REGIの決済方式の種類

F-REGIには、以下のような決済方式があります：

1. **リダイレクト決済（現在使用中）**
   - 発行受付API（`compsettleapply.cgi`）を使用
   - 一回限りの決済
   - カード月次登録フラグは不要

2. **月次課金サービス**
   - 月次課金サービス用のAPIを使用（別のAPIエンドポイント）
   - 定期課金（月額課金）
   - カード月次登録フラグを使用

3. **その他の決済方式**
   - コンビニ決済
   - 銀行振込
   - など

現在のシステムでは、リダイレクト決済（一回限りの決済）のみを使用しているため、カード月次登録フラグは不要です。

---

作成日: 2026-01-13  
最終更新: 2026-01-13（MONTHLYMODE実装完了）

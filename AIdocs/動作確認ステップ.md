# 動作確認ステップ：決済フロー（管理画面からURL生成 → 決済まで）

## 前提条件

- Dockerコンテナが起動していること
- 管理画面にログインできること
- 契約プランが登録されていること
- F-REGI設定が登録されていること（テスト環境）

---

## ステップ1: 管理画面にログイン

1. ブラウザで以下のURLにアクセス：
   ```
   http://localhost:8080/billing/login
   ```

2. ログイン情報を入力：
   - メールアドレス: `dsbrand@example.com`
   - パスワード: `cs20051101`

3. **確認ポイント**：
   - ログインが成功すること
   - ダッシュボードが表示されること

---

## ステップ2: 新規申込フォーム管理画面へ移動

1. 管理画面のナビゲーションメニューから「新規申込フォーム管理」をクリック
   - または直接URL: `http://localhost:8080/billing/admin/contract-forms`

2. **確認ポイント**：
   - 「新規申込フォーム管理」画面が表示されること
   - 契約プランの一覧が表示されること
   - 保存されているURL一覧が表示されること（既存のURLがある場合）

---

## ステップ3: プランを選択してURL生成

1. 「新規URL生成」セクションで、表示したいプランにチェックを入れる
   - 1つ以上のプランを選択（複数選択可）

2. 「URL生成」ボタンをクリック

3. **確認ポイント**：
   - 成功メッセージ「閲覧画面用URLが生成され、保存されました。」が表示されること
   - 生成されたURLが表示されること（例: `http://localhost:8080/billing/contract/create?plans=22`）
   - URL一覧テーブルに新しいURLが追加されること

---

## ステップ4: 生成されたURLをコピー

1. 生成されたURLフィールドの「コピー」ボタンをクリック
   - または、URLフィールドを直接選択してコピー（Ctrl+C / Cmd+C）

2. **確認ポイント**：
   - 「コピーしました」のメッセージが表示されること
   - クリップボードにURLがコピーされること

---

## ステップ5: 新しいブラウザタブ（またはシークレットモード）でURLにアクセス

1. 新しいブラウザタブを開く（またはシークレット/プライベートモード）

2. アドレスバーにコピーしたURLを貼り付けてアクセス
   ```
   http://localhost:8080/billing/contract/create?plans=22
   ```
   （プランIDは選択したプランに応じて異なります）

3. **確認ポイント**：
   - 申込フォームが表示されること
   - 選択したプランのみが表示されること（他のプランは表示されない）
   - エラーメッセージが表示されないこと
   - ページタイトルが「新規申込フォーム」であること

---

## ステップ6: フォーム入力

1. 以下の項目を入力：

   **申込企業情報**
   - 会社名: `テスト株式会社`（必須）
   - 会社名（フリガナ）: `テストカブシキガイシャ`（任意）
   - 部署名: `開発部`（任意）
   - 役職: `部長`（任意）
   - 担当者名: `テスト 太郎`（必須）
   - 担当者名（フリガナ）: `テスト タロウ`（任意）
   - メールアドレス: `test@example.com`（必須）
   - 電話番号: `03-1234-5678`（必須）
   - 郵便番号: `100-0001`（任意）
   - 都道府県: `東京都`（任意）
   - 市区町村: `千代田区`（任意）
   - 番地: `1-1-1`（任意）
   - 建物名: `テストビル5F`（任意）

   **契約内容の選択**
   - 契約プラン: 表示されているプランを選択（必須）
   - 利用開始希望日: 今日以降の日付を選択（必須）
   - 利用規約への同意: チェックボックスにチェック（必須）

2. 「確認」ボタンをクリック

3. **確認ポイント**：
   - 入力値のバリデーションエラーが表示されないこと
   - 確認画面に遷移すること

---

## ステップ7: 確認画面で内容確認

1. 確認画面で入力内容を確認

2. **確認ポイント**：
   - 入力した内容が正しく表示されること
   - エラーメッセージが表示されないこと
   - 「決済へ進む」ボタンが表示されること
   - ページタイトルが「申込内容確認」であること

3. 「決済へ進む」ボタンをクリック

---

## ステップ8: 決済処理

1. 決済処理が実行される（自動的にリダイレクトされる）

2. **確認ポイント（正常な場合）**：
   - F-REGI決済画面にリダイレクトされること
   - または、エラーメッセージが表示されること（F-REGI設定やAPI呼び出しに問題がある場合）

3. **確認ポイント（エラーの場合）**：
   - エラーメッセージの内容を確認
   - ログファイルで詳細を確認（ステップ9参照）

---

## ステップ9: ログファイルで確認

1. ターミナルでログファイルを確認：

   ```bash
   # 最新のログを表示（リアルタイム）
   docker compose exec app bash -c "cd /var/www && tail -f storage/logs/contract-payment-$(date +%Y-%m-%d).log"
   
   # または、最新100行を表示
   docker compose exec app bash -c "cd /var/www && tail -100 storage/logs/contract-payment-$(date +%Y-%m-%d).log"
   ```

2. **確認ポイント**：

   **正常な場合のログ例**：
   ```
   [2026-01-13 10:30:45] local.INFO: 申込フォーム表示 {"url":"...","plan_ids":[22],...}
   [2026-01-13 10:31:20] local.INFO: 確認画面表示 {"contract_plan_id":22,...}
   [2026-01-13 10:31:45] local.INFO: 決済処理開始 {"contract_plan_id":22,...}
   [2026-01-13 10:31:45] local.INFO: 契約作成完了 {"contract_id":123,...}
   [2026-01-13 10:31:45] local.INFO: 決済情報作成完了 {"payment_id":456,...}
   [2026-01-13 10:31:46] local.INFO: F-REGI API呼び出し開始 {...}
   [2026-01-13 10:31:47] local.INFO: F-REGI API呼び出し結果 {"result":"OK",...}
   [2026-01-13 10:31:47] local.INFO: 決済処理完了・リダイレクト {...}
   ```

   **エラー発生時のログ例**：
   ```
   [2026-01-13 10:31:47] local.ERROR: 決済処理エラー {"error":"...","trace":"...",...}
   ```

3. **エラーログのみを確認**：
   ```bash
   docker compose exec app bash -c "cd /var/www && grep -i error storage/logs/contract-payment-$(date +%Y-%m-%d).log"
   ```

---

## ステップ10: 管理画面で契約を確認（オプション）

1. 管理画面の「契約管理」に移動
   - URL: `http://localhost:8080/billing/admin/contracts`

2. **確認ポイント**：
   - 新しく作成された契約が表示されること（正常な場合）
   - 契約ステータスが「決済待ち」または「有効」であること
   - 契約詳細をクリックして、入力内容が正しく保存されていること

---

## トラブルシューティング

### エラー: 「確認画面に直接アクセスすることはできません」

**原因**: 誤って `/contract/confirm` にアクセスしている、またはセッションにエラーが残っている

**対処**:
- `/contract/create?plans=...` のURLを使用していることを確認
- ブラウザのキャッシュをクリア
- 新しいシークレットモードのタブで試す

### エラー: 「F-REGI設定が見つかりません」

**原因**: F-REGI設定が登録されていない、または無効になっている

**対処**:
1. 管理画面で「F-REGI設定」を確認
2. テスト環境用の設定が登録されているか確認
3. 設定が「有効」になっているか確認

### エラー: 「決済の発行に失敗しました」

**原因**: F-REGI APIの呼び出しに失敗

**対処**:
1. ログファイルで詳細なエラーメッセージを確認
2. F-REGI設定のSHOPID、接続パスワードが正しいか確認
3. F-REGIのテスト環境が利用可能か確認

### ログファイルが見つからない

**対処**:
```bash
# ログディレクトリを確認
docker compose exec app bash -c "cd /var/www && ls -la storage/logs/"

# ログファイルの権限を確認
docker compose exec app bash -c "cd /var/www && ls -lh storage/logs/contract-payment-*.log"
```

---

## 確認チェックリスト

- [ ] 管理画面にログインできる
- [ ] プランを選択してURLを生成できる
- [ ] 生成されたURLをコピーできる
- [ ] コピーしたURLで申込フォームが表示される
- [ ] 選択したプランのみが表示される
- [ ] フォーム入力ができる
- [ ] 確認画面に遷移できる
- [ ] 確認画面で入力内容が正しく表示される
- [ ] 「決済へ進む」ボタンが表示される
- [ ] 決済処理が実行される（またはエラーが表示される）
- [ ] ログファイルに記録されている
- [ ] エラーが発生した場合、ログファイルで原因が特定できる

---

## 次のステップ

正常に動作することを確認したら：
1. 実際のF-REGIテスト環境で決済を完了させてみる
2. 異なるプランでテストしてみる
3. 複数プランを選択したURLでテストしてみる
4. エラーケース（バリデーションエラーなど）もテストする

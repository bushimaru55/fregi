# Phase 2 テスト実行手順

作成日: 2026-01-13

## テスト環境の準備

### 1. F-REGIテスト環境の設定確認

1. ブラウザで管理画面にアクセス
   - URL: `http://localhost:8080/admin/fregi-configs`
   - または、アプリケーションの管理画面にログイン

2. F-REGI設定の確認
   - テスト環境（environment='test'）の設定が存在するか確認
   - `is_active=true` の設定が1件存在するか確認
   - SHOPID、接続パスワードが正しく設定されているか確認

3. 設定が存在しない場合
   - 管理画面から新規作成
   - または、コマンドラインから作成: `php artisan fregi:register-test-config`

### 2. テスト用プランの確認

1. ブラウザで管理画面にアクセス
   - URL: `http://localhost:8080/admin/contract-plans`

2. テスト用プランの確認
   - 一回限りプラン（billing_type='one_time'）が存在するか確認
   - 月額課金プラン（billing_type='monthly'）が存在するか確認
   - 両方とも `is_active=true` であることを確認

3. プランが存在しない場合
   - 管理画面から新規作成
   - または、コマンドラインから作成: `php artisan test:create-plans`

## テスト実行

### テスト1: カード情報入力フォームの表示確認

1. ブラウザで申込フォームにアクセス
   - URL: `http://localhost:8080/contract/create`

2. プランを選択して申込フォームを入力
   - 必要項目を入力
   - 「確認画面へ」をクリック

3. 確認画面でカード情報入力フォームを確認
   - カード番号入力フィールド（PAN1-4、4桁ずつ）が表示されるか確認
   - 有効期限入力（月：ドロップダウン、年：テキスト入力）が表示されるか確認
   - カード名義入力フィールドが表示されるか確認
   - セキュリティコード入力フィールドが表示されるか確認

### テスト2: フォームバリデーションの確認

1. カード情報入力フォームでバリデーションをテスト
   - カード番号を3桁で入力してエラーが表示されるか確認
   - 有効期限（月）を選択せずにエラーが表示されるか確認
   - カード名義を入力せずにエラーが表示されるか確認

### テスト3: 一回限り決済のテスト

1. 一回限りプランを選択
2. 申込フォームを入力
3. 確認画面でカード情報を入力
   - テストカード情報を使用（F-REGIテスト環境用）
4. 「決済へ進む」をクリック
5. 正常に完了画面にリダイレクトされるか確認
6. データベースで確認
   - Payment.status が 'completed' になっているか
   - Contract.status が 'active' になっているか
   - 承認番号、取引番号が保存されているか

### テスト4: 月額課金決済のテスト

1. 月額課金プランを選択
2. 申込フォームを入力
3. 確認画面でカード情報を入力
4. 「決済へ進む」をクリック
5. 正常に完了画面にリダイレクトされるか確認
6. データベースで確認
   - Payment.status が 'completed' になっているか
   - Contract.status が 'active' になっているか
   - Contract.customer_id が保存されているか
   - 承認番号、取引番号が保存されているか

### テスト5: エラーハンドリングのテスト

1. 無効なカード情報でテスト
2. エラーメッセージが表示されるか確認
3. 確認画面に戻るか確認
4. ログにエラー情報が記録されているか確認

## ログ確認

テスト実行後、ログファイルを確認:

```bash
tail -f storage/logs/laravel.log
# または
tail -f storage/logs/contract_payment.log
```

確認項目:
- オーソリ処理開始時にログが記録されているか
- カード情報がマスクされているか
- オーソリ処理結果時にログが記録されているか
- エラー時にログが記録されているか

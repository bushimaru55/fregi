# オプション商品機能実装仕様

作成日: 2026-01-21

## 概要

月額商品と買い切り商品（オプション）を同時に扱えるように、2回のオーソリ処理を実装しました。ベース商品（契約プラン）に加えて、オプション商品を選択できるようになりました。

## 実装方針

### 1. データ構造

- **ベース商品**: `contract_plans`テーブル（契約プラン）
  - `billing_type`: `one_time`（一回限り）または `monthly`（月額課金）
  
- **オプション商品**: `products`テーブル（`type='option'`）
  - 全て買い切り（一回限り）として扱う
  
- **契約明細**: `contract_items`テーブル
  - ベース商品の明細: `contract_plan_id`を使用、`product_id`はNULL
  - オプション商品の明細: `product_id`を使用、`contract_plan_id`はNULL

### 2. 決済処理

#### 月額商品 + 買い切り商品の場合

1. **月額商品のオーソリ**（MONTHLY=1, CUSTOMERID付き）
   - 金額: ベース商品（月額）の金額
   - CUSTOMERIDを生成・保存
   
2. **買い切り商品のオーソリ**（MONTHLY=0）
   - 金額: オプション商品の合計金額
   - 同じカード情報を再利用

#### 買い切り商品のみの場合

1. **買い切り商品のオーソリ**（MONTHLY=0）
   - 金額: ベース商品（買い切り）+ オプション商品の合計金額

#### 月額商品のみの場合

1. **月額商品のオーソリ**（MONTHLY=1, CUSTOMERID付き）
   - 金額: ベース商品（月額）の金額
   - CUSTOMERIDを生成・保存

---

## データベース変更

### 1. productsテーブルの拡張

**マイグレーション**: `2026_01_21_000001_add_option_fields_to_products_table.php`

追加カラム:
- `type`: ENUM('plan', 'option', 'addon') - 商品種別
- `description`: TEXT - 商品説明
- `is_active`: BOOLEAN - 有効フラグ
- `display_order`: INT UNSIGNED - 表示順

### 2. contract_itemsテーブルの修正

**マイグレーション**: `2026_01_21_000002_modify_contract_items_for_option_products.php`

変更内容:
- `product_id`: nullableに変更（ベース商品はNULL）
- `contract_plan_id`: 追加（ベース商品用、nullable）

### 3. contractsテーブルの修正

**マイグレーション**: `2026_01_21_000003_make_contracts_payment_id_nullable.php`

変更内容:
- `payment_id`: nullableに変更（1契約 = 複数決済に対応）

---

## モデルの作成・修正

### 1. Productモデル（新規作成）

`app/Models/Product.php`

**主な機能:**
- スコープ: `scopeOptions()` - オプション商品のみ取得
- アクセサ: `formatted_price`, `type_label`

### 2. ContractItemモデル（新規作成）

`app/Models/ContractItem.php`

**主な機能:**
- リレーション: `contract()`, `contractPlan()`, `product()`

### 3. Contractモデルの修正

**追加:**
- `payments()`リレーション（HasMany） - 複数決済に対応

---

## コントローラーの修正

### ContractController

#### create()メソッド

- オプション商品を取得してビューに渡す
- `$optionProducts`を追加

#### confirm()メソッド

- 選択されたオプション商品を取得
- オプション商品の合計金額を計算
- ビューに`$optionProducts`と`$optionTotalAmount`を渡す

#### store()メソッド（大幅修正）

**処理フロー:**

1. 契約作成
2. 契約明細（contract_items）作成
   - ベース商品の明細（必須・自動生成）
   - オプション商品の明細（任意・ユーザー選択）
3. 月額商品と買い切り商品を分離
4. 月額商品のオーソリ処理（あれば）
   - MONTHLY=1, CUSTOMERID付き
   - 成功時にCUSTOMERIDを保存
5. 買い切り商品のオーソリ処理（あれば）
   - MONTHLY=0
   - 同じカード情報を再利用
6. 両方が成功した場合のみ契約を有効化

**エラーハンドリング:**
- トランザクション内で実行
- 片方が失敗した場合はロールバック
- 月額商品のオーソリが成功し、買い切り商品のオーソリが失敗した場合は警告ログを記録

---

## バリデーション

### ContractRequest

**追加ルール:**
```php
'option_product_ids' => ['nullable', 'array'],
'option_product_ids.*' => [
    'exists:products,id',
    // カスタムバリデーション: type='option' かつ is_active=true であること
],
```

---

## UI/UXの変更

### 申込フォーム（create.blade.php）

**追加:**
- オプション商品選択セクション
- チェックボックスで選択可能
- 各オプション商品の金額を表示

### 確認画面（confirm.blade.php）

**追加:**
- オプション商品一覧の表示
- オプション商品合計の表示
- 合計金額の表示（ベース商品 + オプション商品）

---

## ログとイベント記録

### payment_eventsテーブル

**新規イベントタイプ:**
- `fregi_authorize_request_monthly`: 月額商品のオーソリリクエスト
- `fregi_authorize_request_one_time`: 買い切り商品のオーソリリクエスト
- `fregi_authorize_response_monthly`: 月額商品のオーソリレスポンス
- `fregi_authorize_response_one_time`: 買い切り商品のオーソリレスポンス
- `fregi_authorize_success_monthly`: 月額商品のオーソリ成功
- `fregi_authorize_success_one_time`: 買い切り商品のオーソリ成功
- `fregi_authorize_failed_monthly`: 月額商品のオーソリ失敗
- `fregi_authorize_failed_one_time`: 買い切り商品のオーソリ失敗

---

## 月次売上処理への影響

月次売上処理（salem.cgi）では、以下の点に注意が必要です：

1. **対象契約**: `billing_type='monthly'` の契約のみ
2. **金額**: 月額商品の金額のみ（オプション商品は除外）
3. **CUSTOMERID**: 契約の`customer_id`カラムから取得

**実装例（将来の月次売上処理）:**
```php
$monthlyContracts = Contract::where('status', 'active')
    ->whereHas('contractPlan', function($q) {
        $q->where('billing_type', 'monthly');
    })
    ->whereNotNull('customer_id')
    ->get();

foreach ($monthlyContracts as $contract) {
    // 月額商品の金額を取得（オプション商品は除外）
    $monthlyAmount = $contract->contractItems()
        ->whereNotNull('contract_plan_id')
        ->sum('subtotal');
    
    // salem.cgiを呼び出し（CUSTOMERIDを使用）
    // ...
}
```

---

## 後方互換性

### 既存契約との互換性

- 既存の契約データに影響なし
- `contract_items`が空の既存契約は、ベース商品のみとして扱う
- `contracts.payment_id`はnullableになったが、既存データはそのまま

### 既存APIとの互換性

- 既存の決済処理（オプション商品なし）は正常に動作
- オプション商品がない場合は、1回のオーソリ処理のみ実行

---

## 注意事項

### 1. エラー処理

月額商品のオーソリが成功し、買い切り商品のオーソリが失敗した場合：

- トランザクションはロールバックされる（DB上のデータは削除）
- ただし、F-REGI側では月額商品の顧客登録が完了している
- 警告ログに記録される
- **手動対応が必要な場合がある**（F-REGI側でのキャンセル処理）

### 2. 月次売上処理

- オプション商品は月次売上処理の対象外
- 月額商品のみが月次売上処理で処理される

### 3. オプション商品の追加

- 管理画面から`type='option'`の商品を登録する必要がある
- `is_active=true`である必要がある

---

## テスト項目

### 基本機能

- [ ] 月額商品のみの契約
- [ ] 買い切り商品のみの契約
- [ ] 月額商品 + オプション商品の契約
- [ ] 買い切り商品 + オプション商品の契約
- [ ] オプション商品なしの契約（既存動作の確認）

### エラー処理

- [ ] 月額商品のオーソリ失敗
- [ ] 買い切り商品のオーソリ失敗
- [ ] 月額商品成功 + 買い切り商品失敗の場合のロールバック

### UI/UX

- [ ] オプション商品選択UIの表示
- [ ] 確認画面でのオプション商品表示
- [ ] 合計金額の計算と表示

---

## 実装ファイル一覧

### 新規作成

1. `database/migrations/2026_01_21_000001_add_option_fields_to_products_table.php`
2. `database/migrations/2026_01_21_000002_modify_contract_items_for_option_products.php`
3. `database/migrations/2026_01_21_000003_make_contracts_payment_id_nullable.php`
4. `app/Models/Product.php`
5. `app/Models/ContractItem.php`

### 修正

1. `app/Models/Contract.php` - `payments()`リレーション追加
2. `app/Http/Controllers/ContractController.php` - `store()`メソッドの大幅修正、`create()`と`confirm()`の修正
3. `app/Http/Requests/ContractRequest.php` - バリデーション追加
4. `resources/views/contracts/create.blade.php` - オプション商品選択UI追加
5. `resources/views/contracts/confirm.blade.php` - オプション商品表示追加

---

## 今後の作業

1. **マイグレーション実行**: 本番環境でマイグレーションを実行
2. **オプション商品の登録**: 管理画面からオプション商品を登録
3. **動作確認**: 各種シナリオでの動作確認
4. **月次売上処理の確認**: 月額商品のみが処理されることを確認

---

作成日: 2026-01-21
# F-REGI仕様書確認結果

確認日時: 2026-01-13  
参考資料: F-REGIクレジットカード処理インターフェース仕様書

## 確認内容

ユーザーから提供されたF-REGI仕様書の画像を確認し、現在の実装との整合性を検証しました。

## 仕様書から確認された重要な情報

### 1. MONTHLYMODEパラメータについて

**仕様書の記載:**
- `MONTHLYMODE`: 月次課金モード
  - `0`: 月次課金（データクリーニングが行われる）
  - `1`: 随時課金（データクリーニングが行われない）
  - デフォルト: `0`（月次課金）

**重要な発見:**
- 仕様書には `MONTHLYMODE` パラメータが存在する
- しかし、エラーメッセージ「リダイレクト決済（SaaS型）発行処理時の洗替利用フラグは指定できません」から、**リダイレクト決済（SaaS型）では `MONTHLYMODE` パラメータを使用できない**ことが判明

### 2. MONTHLYパラメータについて

**仕様書の記載:**
- `MONTHLY`: Payment type
  - `1`: 月次決済（顧客として登録される）
  - `0`: 即時決済（顧客として登録されない）
  - デフォルト: `0`（即時決済）

**重要な発見:**
- 仕様書では `MONTHLY` パラメータが説明されている
- 現在の実装では `MONTHLY` パラメータを送信していない
- ただし、`compsettleapply.cgi`（リダイレクト決済）の仕様では、このパラメータが使用できるかどうかは不明

### 3. リダイレクト決済（compsettleapply.cgi）とオーソリ処理（authm.cgi）の違い

**仕様書から確認:**
- **オーソリ処理（authm.cgi）**: 直接APIで決済を実行する方式
  - カード情報を直接送信する必要がある
  - `MONTHLY`、`MONTHLYMODE` などのパラメータを使用できる可能性がある
- **リダイレクト決済（compsettleapply.cgi）**: ユーザーをF-REGIの決済画面にリダイレクトする方式
  - カード情報はユーザーがF-REGI画面で入力
  - `MONTHLYMODE` パラメータは使用できない（エラーメッセージから判明）

## 現在の実装状況

### 実装方法
現在のシステムは**リダイレクト決済（compsettleapply.cgi）**を使用しています。

### 送信パラメータ
```php
$apiParams = [
    'SHOPID' => $fregiConfig->shopid,
    'ID' => $payment->orderid,
    'PAY' => (string)$payment->amount,
    // MONTHLYMODE は送信しない（リダイレクト決済では使用不可）
];
```

## 修正内容（既に実施済み）

### 問題点
月額課金プラン（`billing_type = 'monthly'`）の場合に `MONTHLYMODE = '0'` を送信していたが、リダイレクト決済ではこのパラメータを使用できない。

### 修正
`MONTHLYMODE` パラメータの送信を停止しました。

```php
// 修正前
if ($billingType === 'monthly') {
    $apiParams['MONTHLYMODE'] = '0'; // エラーの原因
}

// 修正後
// リダイレクト決済（SaaS型）ではMONTHLYMODEパラメータを使用しない
// if ($billingType === 'monthly') {
//     $apiParams['MONTHLYMODE'] = '0'; // コメントアウト
// }
```

## 月額課金の実装について

### 現在の状況
- リダイレクト決済（compsettleapply.cgi）を使用している限り、`MONTHLYMODE` パラメータは使用できない
- 月額課金プランも、一回限り決済と同じようにリダイレクト決済で処理される

### 今後の検討事項
実際の月額課金機能を実装する場合は、以下のいずれかの方法を検討する必要があります：

1. **F-REGIの月次課金サービスAPIを使用**
   - 別のAPIエンドポイントを使用する可能性がある
   - F-REGIの月次課金サービス機能を利用

2. **オーソリ処理（authm.cgi）に切り替える**
   - 直接APIで決済を実行する方式
   - カード情報を直接送信する必要がある（セキュリティ面での考慮が必要）
   - `MONTHLY`、`MONTHLYMODE` パラメータが使用できる可能性がある

3. **現在の方式を維持（月額課金は実質的に一回限り決済として扱う）**
   - 月額課金プランも一回限り決済として処理
   - 実際の月額課金機能は別途実装が必要

## 結論

1. **現在の修正は正しい**: リダイレクト決済（compsettleapply.cgi）では `MONTHLYMODE` パラメータを使用できないため、送信を停止する修正は適切です。

2. **月額課金プランの動作**: 現在は月額課金プランも一回限り決済として処理されます。

3. **実際の月額課金機能の実装**: 将来的に実装する場合は、F-REGIの月次課金サービスAPIの仕様を確認する必要があります。

## 参考

- F-REGIクレジットカード処理インターフェース仕様書
- エラーコード CSA1-1-107: 「リダイレクト決済（SaaS型）発行処理時の洗替利用フラグは指定できません」

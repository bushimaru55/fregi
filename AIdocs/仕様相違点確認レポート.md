# 仕様相違点確認レポート

作成日: 2026-01-13

## 指摘事項の確認

ユーザーから指摘された仕様要件：
1. **商品ID付きURLで該当商品のみ表示（固定）**
2. **改ざん/存在しないIDのチェック**
3. **管理画面に実装していないことの確認**
4. **決済戻りの検証（冪等性）**

## 現在の実装状況

### 1. URLパラメータによるプラン表示

**実装状況**:
- ✅ `plans` パラメータによる絞り込みは実装済み
- ⚠️ **問題点**: パラメータ名が `plans`（複数形）で、複数プランに対応
- ⚠️ **仕様との相違**: ユーザー仕様では `plan_id`（単数）で単一プランの固定表示を想定

**現在のコード**:
```php
// ContractController::create()
if ($request->has('plans')) {
    $planIdsString = $request->input('plans');
    $planIds = array_filter(array_map('intval', explode(',', $planIdsString)));
    if (!empty($planIds)) {
        $query->whereIn('id', $planIds);
    }
}
```

**URL形式**:
- 現在: `/contract/create?plans=21,22` （複数プラン対応）
- 仕様想定: `/contract/create?plan_id=21` （単一プラン固定）

### 2. 改ざん/存在しないIDのチェック

**実装状況**:
- ⚠️ **問題点**: 非公開プラン（`is_active=false`）のチェックは `active()` スコープで対応
- ⚠️ **問題点**: 存在しないプランIDでアクセスした場合、空のプラン一覧が表示される（404にならない）
- ⚠️ **問題点**: プランが1件も見つからない場合のエラーハンドリングが不足

**現在のコード**:
```php
$query = ContractPlan::active(); // is_active=true のみ
if ($request->has('plans')) {
    // プランIDを指定しても、存在しないIDは無視される
    $query->whereIn('id', $planIds);
}
$plans = $query->orderBy('display_order')->get();
// プランが0件でも、空のフォームが表示される（エラーにならない）
```

### 3. 管理画面に実装していないことの確認

**実装状況**:
- ✅ 公開URLは `/contract/create` （`/admin` 配下ではない）
- ✅ 公開URLに `auth` ミドルウェアは付いていない（ログイン不要）
- ✅ 管理画面は商品/注文参照のみ（`/admin/contract-plans`, `/admin/contracts`）

**確認結果**: ✅ **仕様に適合**

### 4. 決済戻りの検証（冪等性）

**実装状況**:
- ⚠️ **確認必要**: F-REGIからの戻りURL処理（`ReturnController`）の冪等性確認が必要
- ⚠️ **確認必要**: 通知URL（`FregiNotifyController`）の実装状況確認が必要
- ⚠️ **問題点**: 同一通知が複数回来た場合の二重更新防止処理が不明

## 修正が必要な項目

### 優先度: 高

1. **プランが0件の場合のエラーハンドリング**
   - 存在しないプランIDや非公開プランIDでアクセスした場合、404またはエラーメッセージを表示

2. **単一プラン固定表示への対応**
   - `plan_id`（単数）パラメータにも対応
   - 単一プランの場合は選択不可（固定表示）にする

3. **テスト手順書の修正**
   - 商品ID付きURLでの固定表示テストを追加
   - 改ざん/存在しないIDテストを追加
   - ログイン不要確認テストを追加
   - 決済戻りの検証を追加

### 優先度: 中

4. **決済戻りの冪等性確認**
   - `ReturnController` と `FregiNotifyController` の実装を確認
   - 二重更新防止処理の実装を確認

## 推奨される修正内容

### 1. ContractController::create() の修正案

```php
public function create(Request $request): View
{
    try {
        $query = ContractPlan::active();
        $planIds = [];
        $isSinglePlan = false;
        
        // plan_id（単数）または plans（複数）パラメータに対応
        if ($request->has('plan_id')) {
            $planId = (int)$request->input('plan_id');
            $planIds = [$planId];
            $isSinglePlan = true;
        } elseif ($request->has('plans')) {
            $planIdsString = $request->input('plans');
            $planIds = array_filter(array_map('intval', explode(',', $planIdsString)));
        }
        
        if (!empty($planIds)) {
            $query->whereIn('id', $planIds);
        }
        
        $plans = $query->orderBy('display_order')->get();
        
        // プランが0件の場合は404
        if ($plans->isEmpty()) {
            abort(404, '指定されたプランが見つかりません。');
        }
        
        // 単一プランの場合は、URLで指定されたプラン以外が選択できないようにする
        $termsOfService = SiteSetting::getValue('terms_of_service', '');
        
        return view('contracts.create', compact('plans', 'termsOfService', 'isSinglePlan'));
    } catch (\Exception $e) {
        // エラーハンドリング
    }
}
```

### 2. ビューの修正案

単一プランの場合、ラジオボタンを hidden input + 表示のみにする：

```blade
@if($isSinglePlan && $plans->count() === 1)
    {{-- 単一プランの場合は選択不可（固定表示） --}}
    <input type="hidden" name="contract_plan_id" value="{{ $plans->first()->id }}">
    <div class="border-2 border-indigo-500 rounded-lg p-4 bg-indigo-50">
        <div class="text-center">
            <div class="text-lg font-bold text-gray-800 mb-2">{{ $plans->first()->name }}</div>
            <div class="text-3xl font-bold text-indigo-600 mb-2">{{ $plans->first()->formatted_price }}</div>
            <div class="text-sm text-gray-600">{{ $plans->first()->description }}</div>
        </div>
    </div>
@else
    {{-- 複数プランの場合は選択可能 --}}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @foreach($plans as $plan)
            {{-- ラジオボタン --}}
        @endforeach
    </div>
@endif
```

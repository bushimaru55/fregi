# F-REGI API選択：一回限りと月額課金の比較

作成日: 2026-01-13

## 質問

一回限りの決済と月額の決済は、それぞれ別々のAPIを利用するのか、月額の決済APIであればどちらにも対応できるのか？

## 回答

**月額課金のAPI（authm.cgi）を使用すれば、一回限りの決済にも月額課金にも対応できます。**

## APIの対応状況

### 1. compsettleapply.cgi（リダイレクト決済） - 現在使用中

| 項目 | 説明 |
|------|------|
| **対応決済タイプ** | 一回限りの決済のみ |
| **月額課金対応** | ❌ 不可（MONTHLYMODEパラメータが使用できない） |
| **カード情報入力** | F-REGI画面（リダイレクト） |
| **自動引き落とし** | ❌ 不可 |
| **CUSTOMERID** | 使用しない |

**特徴:**
- ユーザーをF-REGIの決済画面にリダイレクト
- カード情報はF-REGI側で入力
- 一回限りの決済のみ対応

### 2. authm.cgi（オーソリ処理） - 月額課金用

| 項目 | 説明 |
|------|------|
| **対応決済タイプ** | **一回限りの決済 + 月額課金の両方に対応** ✅ |
| **月額課金対応** | ✅ 可能（`MONTHLY=1`を指定） |
| **カード情報入力** | 自社サイト（直接API） |
| **自動引き落とし** | ✅ 可能（`salem.cgi`と組み合わせ） |
| **CUSTOMERID** | 使用する（月次売上用） |

**特徴:**
- `MONTHLY=0` または省略: 即時決済（一回限りの決済）
- `MONTHLY=1`: 月次決済（顧客として登録される）
- **両方の決済タイプに対応可能**

## 詳細な仕様

### authm.cgiのMONTHLYパラメータ

#### 一回限りの決済（即時決済）

```
MONTHLY=0 または 省略
```

- 即時決済として処理される
- 顧客として登録されない
- `CUSTOMERID`の入力は任意
- `CUSTOMERID`が指定されても、顧客の登録及びカード情報の更新は行われない

#### 月額課金（月次決済）

```
MONTHLY=1
MONTHLYMODE=0（月次課金の場合）
```

- 顧客としてF-REGI側に登録される
- `CUSTOMERID`を指定することで、後続の月次売上処理で使用できる
- 月次売上処理（salem.cgi）でCUSTOMERIDを指定して自動引き落とし可能

## 選択肢の比較

### 選択肢A: 両方にauthm.cgiを使用（統一API）

**メリット:**
- ✅ 一つのAPIで両方の決済タイプに対応
- ✅ コードの統一化が可能
- ✅ 月額課金の自動引き落としが可能

**デメリット:**
- ❌ カード情報を自社サイトで入力する必要がある（初回のみ）
- ❌ セキュリティ対応が必要（PCI DSS準拠など）
- ❌ カード情報入力フォームの実装が必要

### 選択肢B: compsettleapply.cgi + authm.cgi（現在の方式継続）

**メリット:**
- ✅ 一回限り決済はF-REGI画面でカード情報入力（セキュリティ負担が少ない）
- ✅ 既存の実装を継続使用可能

**デメリット:**
- ❌ 2つのAPIを使用する必要がある
- ❌ コードの分岐が必要
- ⚠️ 月額課金にはauthm.cgiが必要（カード情報入力が必要）

### 選択肢C: 両方にcompsettleapply.cgiを使用（現状維持）

**メリット:**
- ✅ カード情報はF-REGI画面で入力
- ✅ セキュリティ負担が少ない

**デメリット:**
- ❌ 月額課金の自動引き落としが実装できない
- ❌ 月額課金プランも一回限り決済として処理される

## 推奨される実装方針

### ユーザーの要望を考慮した場合

ユーザーの要望：「F-REGI側でカード情報を管理し、自社では決済画面と処理のみ対応したい」

この要望に基づくと：

1. **一回限りの決済**: compsettleapply.cgi（リダイレクト決済）を継続使用
   - カード情報はF-REGI画面で入力
   - セキュリティ負担が少ない

2. **月額課金の決済**: authm.cgi（オーソリ処理）を使用
   - ただし、初回のみカード情報入力が必要
   - または、F-REGI管理画面で既に顧客登録されている前提でCUSTOMERIDのみ使用

### 統一APIを使用する場合

authm.cgiに統一する場合：

- 一回限りの決済: `MONTHLY=0`または省略
- 月額課金の決済: `MONTHLY=1`, `MONTHLYMODE=0`

ただし、カード情報を自社サイトで入力する必要があるため、ユーザーの要望と矛盾する可能性がある。

## 結論

**月額課金のAPI（authm.cgi）を使用すれば、一回限りの決済にも月額課金にも対応できます。**

ただし、カード情報の入力方法が異なります：
- compsettleapply.cgi: F-REGI画面で入力（リダイレクト）
- authm.cgi: 自社サイトで入力（直接API）

ユーザーの要望（F-REGI側でカード情報を管理）を考慮すると、**一回限り決済はcompsettleapply.cgi、月額課金はauthm.cgi**という使い分けが適切かもしれません。

ただし、月額課金でも初回のみカード情報入力が必要な場合は、F-REGI管理画面で既に顧客登録されている前提でCUSTOMERIDのみを使用する方法を検討する必要があります。

# Phase 2 テスト実行手順（修正版）

作成日: 2026-01-13

## 重要な確認事項

**購入フォーム（契約申込フォーム）は公開ページとして実装されています。**

- URL: `/contract/create`（公開、ゲストアクセス可）
- 管理画面ログインは不要
- テストは公開ページから実行します

## テスト環境の準備

### 1. F-REGIテスト環境の設定確認（管理画面で確認）

**注意**: F-REGI設定の確認のみ管理画面を使用しますが、テスト自体は公開ページから実行します。

1. 必要に応じて管理画面にアクセス（設定確認のみ）
   - URL: `http://localhost:8080/billing/admin/fregi-configs`
   - テスト環境（environment='test'）の設定が存在するか確認
   - `is_active=true` の設定が1件存在するか確認

2. 設定が存在しない場合
   - 管理画面から新規作成
   - または、コマンドラインから作成: `php artisan fregi:register-test-config`

### 2. テスト用プランの確認（管理画面で確認）

1. 必要に応じて管理画面にアクセス（プラン確認のみ）
   - URL: `http://localhost:8080/billing/admin/contract-plans`
   - 一回限りプラン（billing_type='one_time'）が存在するか確認
   - 月額課金プラン（billing_type='monthly'）が存在するか確認
   - 両方とも `is_active=true` であることを確認

## テスト実行（公開ページから）

### テスト1: カード情報入力フォームの表示確認

1. **ブラウザで公開申込フォームにアクセス**
   - URL: `http://localhost:8080/billing/contract/create`
   - **ログイン不要（ゲストアクセス）**

2. プランを選択して申込フォームを入力
   - 必要項目を入力
   - 「確認画面へ」をクリック

3. 確認画面でカード情報入力フォームを確認
   - カード番号入力フィールド（PAN1-4、4桁ずつ）が表示されるか確認
   - 有効期限入力（月：ドロップダウン、年：テキスト入力）が表示されるか確認
   - カード名義入力フィールドが表示されるか確認
   - セキュリティコード入力フィールドが表示されるか確認

### テスト2: フォームバリデーションの確認

1. カード情報入力フォームでバリデーションをテスト
   - カード番号を3桁で入力してエラーが表示されるか確認
   - 有効期限（月）を選択せずにエラーが表示されるか確認
   - カード名義を入力せずにエラーが表示されるか確認

### テスト3: 一回限り決済のテスト

1. **公開申込フォームにアクセス**
   - URL: `http://localhost:8080/billing/contract/create`
   - **ログイン不要**

2. 一回限りプランを選択
3. 申込フォームを入力
4. 確認画面でカード情報を入力
   - テストカード情報を使用（F-REGIテスト環境用）
5. 「決済へ進む」をクリック
6. 正常に完了画面にリダイレクトされるか確認

### テスト4: 月額課金決済のテスト

1. **公開申込フォームにアクセス**
   - URL: `http://localhost:8080/billing/contract/create`
   - **ログイン不要**

2. 月額課金プランを選択
3. 申込フォームを入力
4. 確認画面でカード情報を入力
5. 「決済へ進む」をクリック
6. 正常に完了画面にリダイレクトされるか確認

### テスト5: エラーハンドリングのテスト

1. 無効なカード情報でテスト
2. エラーメッセージが表示されるか確認
3. 確認画面に戻るか確認

## データベース確認（オプション）

テスト実行後、必要に応じてデータベースを確認：

```sql
-- 最新の契約を確認
SELECT * FROM contracts ORDER BY id DESC LIMIT 1;

-- 最新の決済を確認
SELECT * FROM payments ORDER BY id DESC LIMIT 1;

-- 月額課金の場合、customer_idが保存されているか確認
SELECT id, customer_id, status FROM contracts WHERE billing_type = 'monthly' ORDER BY id DESC LIMIT 1;
```

## ログ確認

テスト実行後、ログファイルを確認:

```bash
tail -f storage/logs/laravel.log
# または
tail -f storage/logs/contract_payment.log
```

## まとめ

- **テストは公開ページ（`/contract/create`）から実行**
- **ログイン不要（ゲストアクセス）**
- F-REGI設定やプランの確認のみ管理画面を使用（オプション）

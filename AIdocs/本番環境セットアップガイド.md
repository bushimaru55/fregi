# 本番環境セットアップガイド

作成日: 2026-01-15

## 概要

このガイドでは、FTP接続を使用して本番環境の `/billing` ディレクトリにLaravelアプリケーションを設置する手順を説明します。

---

## 前提条件

- FTP接続情報（ホスト、ユーザー名、パスワード）
- 本番環境のデータベース接続情報
- 本番環境のF-REGI設定情報（SHOPID、接続パスワード等）

---

## ディレクトリ構成

本番環境では、Laravel本体と公開ディレクトリを分離して配置します。

```
/var/www/vhosts/dschatbot.ai/httpdocs/
├── laravel_billing/          # Laravel本体（非公開）
│   ├── app/
│   ├── bootstrap/
│   ├── config/
│   ├── database/
│   ├── public/              # この中身は使わない（webroot/billing/に配置）
│   ├── resources/
│   ├── routes/
│   ├── storage/
│   ├── vendor/
│   ├── .env                 # 本番環境用の設定ファイル
│   └── ...
└── webroot/
    └── billing/             # 公開ディレクトリ（Laravel public/の中身）
        ├── index.php        # 本体を参照するように書き換え
        ├── .htaccess
        ├── css/
        ├── js/
        └── ...
```

---

## ステップ1: ローカル環境での準備

### 1.1 アプリケーションのビルド

```bash
# プロジェクトルートに移動
cd /Users/dfn4459wgl/Desktop/billing/app

# 依存関係のインストール（vendorディレクトリを生成）
composer install --no-dev --optimize-autoloader
```

### 1.2 本番環境用のindex.phpを作成

`app/public/index.php` をコピーして、本番環境用に修正します。

**本番環境用 `index.php` の内容:**

```php
<?php

use Illuminate\Contracts\Http\Kernel;
use Illuminate\Http\Request;

define('LARAVEL_START', microtime(true));

/*
|--------------------------------------------------------------------------
| Check If The Application Is Under Maintenance
|--------------------------------------------------------------------------
|
| If the application is in maintenance / demo mode via the "down" command
| we will load this file so that any pre-rendered content can be shown
| instead of starting the framework, which could cause an exception.
|
*/

// 本体のパス（絶対パス）
$laravelBasePath = '/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing';

if (file_exists($maintenance = $laravelBasePath.'/storage/framework/maintenance.php')) {
    require $maintenance;
}

/*
|--------------------------------------------------------------------------
| Register The Auto Loader
|--------------------------------------------------------------------------
|
| Composer provides a convenient, automatically generated class loader for
| this application. We just need to utilize it! We'll simply require it
| into the script here so we don't need to manually load our classes.
|
*/

require $laravelBasePath.'/vendor/autoload.php';

/*
|--------------------------------------------------------------------------
| Run The Application
|--------------------------------------------------------------------------
|
| Once we have the application, we can handle the incoming request using
| the application's HTTP kernel. Then, we will send the response back
| to this client's browser, allowing them to enjoy our application.
|
*/

$app = require_once $laravelBasePath.'/bootstrap/app.php';

$kernel = $app->make(Kernel::class);

$response = $kernel->handle(
    $request = Request::capture()
)->send();

$kernel->terminate($request, $response);
```

このファイルを `app/public/index.php.production` として保存してください。

---

## ステップ2: FTP接続とファイルアップロード

### 2.1 FTP接続

FTPクライアント（FileZilla、Cyberduck等）を使用して本番サーバーに接続します。

### 2.2 Laravel本体のアップロード

**アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/`

**アップロードするディレクトリ/ファイル:**
- `app/`
- `bootstrap/`
- `config/`
- `database/`
- `resources/`
- `routes/`
- `storage/`（後でパーミッション設定が必要）
- `vendor/`
- `.env`（後で設定）
- `.gitignore`
- `artisan`
- `composer.json`
- `composer.lock`

**アップロードしないもの:**
- `public/` ディレクトリ全体（中身のみアップロード）
- `.git/`
- `node_modules/`
- `tests/`

### 2.3 公開ディレクトリのアップロード

**アップロード先**: `/var/www/vhosts/dschatbot.ai/httpdocs/webroot/billing/`

**アップロードする内容:**
- `public/index.php.production` → `index.php` にリネーム
- `public/.htaccess.production` → `.htaccess` にリネーム（推奨）
  - または `public/.htaccess` をそのまま使用（動作確認後）
- `public/css/`（存在する場合）
- `public/js/`（存在する場合）
- `public/fonts/`（存在する場合）
- `public/images/`（存在する場合）
- その他 `public/` 内の静的ファイル

**注意**: `.htaccess.production` には `RewriteBase /billing/` が追加されています。これにより、より確実にルーティングが動作します。

---

## ステップ3: 環境変数（.env）の設定

### 3.1 .envファイルの作成

`/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/.env` を作成します。

**テンプレートファイル**: `AIdocs/本番環境.envテンプレート.txt` を参照してください。

### 3.2 必須設定項目

以下の項目を必ず設定してください：

```env
APP_NAME="Billing System"
APP_ENV=production
APP_KEY=                    # 後で生成（ステップ3.3参照）
APP_DEBUG=false
APP_URL=https://dschatbot.ai/billing

LOG_CHANNEL=stack
LOG_DEPRECATIONS_CHANNEL=null
LOG_LEVEL=error             # 本番環境ではerror推奨

DB_CONNECTION=mysql
DB_HOST=localhost           # 本番環境のデータベースホスト
DB_PORT=3306
DB_DATABASE=                # 本番環境のデータベース名
DB_USERNAME=                # 本番環境のデータベースユーザー名
DB_PASSWORD=                # 本番環境のデータベースパスワード

SESSION_DRIVER=file
SESSION_LIFETIME=120
SESSION_COOKIE=billing_session
SESSION_PATH=/billing

# F-REGI暗号化キー（ローカル環境と同じ値を使用）
FREGI_SECRET_KEY=           # ローカル環境の.envからコピー
```

**その他の設定項目**: `AIdocs/本番環境.envテンプレート.txt` を参照して、必要に応じて設定してください。

### 3.3 APP_KEYの生成

ローカル環境で生成したAPP_KEYを使用するか、本番環境で生成します。

**ローカル環境で生成:**
```bash
cd /Users/dfn4459wgl/Desktop/billing/app
php artisan key:generate --show
```

生成されたキーを `.env` の `APP_KEY` に設定します。

**本番環境で生成（推奨）:**
FTP接続後、SSHまたはコマンド実行機能があれば：
```bash
cd /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing
php artisan key:generate
```

### 3.4 データベース接続情報の設定

本番環境のデータベース接続情報を `.env` に設定します。

```env
DB_CONNECTION=mysql
DB_HOST=localhost          # またはデータベースサーバーのホスト名
DB_PORT=3306
DB_DATABASE=billing        # 本番環境のデータベース名
DB_USERNAME=billing_user   # 本番環境のデータベースユーザー名
DB_PASSWORD=your_password  # 本番環境のデータベースパスワード
```

---

## ステップ4: ファイルパーミッションの設定

FTPクライアントまたはSSH接続で以下のパーミッションを設定します。

### 4.1 ストレージディレクトリ

```bash
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/storage
chmod -R 775 /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/bootstrap/cache
```

### 4.2 所有者の設定（必要に応じて）

```bash
chown -R www-data:www-data /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/storage
chown -R www-data:www-data /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/bootstrap/cache
```

**注意**: サーバー環境によっては、FTP接続でアップロードしたファイルの所有者が異なる場合があります。サーバー管理者に確認してください。

---

## ステップ5: データベースのセットアップ

### 5.1 マイグレーションの実行

SSH接続が可能な場合：

```bash
cd /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing
php artisan migrate --force
```

**SSH接続が不可能な場合:**
- ローカル環境でSQLファイルを生成して、本番環境のデータベースに直接インポートする方法もあります。
- または、管理画面から手動でテーブルを作成する必要があります。

### 5.2 管理者アカウントの作成

SSH接続が可能な場合：

```bash
cd /var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing
php artisan tinker
```

Tinker内で実行：

```php
use App\Models\User;
use Illuminate\Support\Facades\Hash;

User::create([
    'name' => '管理者',
    'email' => 'kanri@dschatbot.ai',
    'password' => Hash::make('cs20051101'),
]);
```

**SSH接続が不可能な場合:**
- データベースに直接INSERT文を実行するか、
- 管理画面のログイン機能を一時的に無効化して、初回ログイン時にアカウント作成を可能にする方法もあります。

---

## ステップ6: F-REGI設定の登録

### 6.1 管理画面にログイン

1. `https://dschatbot.ai/billing/login` にアクセス
2. Basic認証を通過
3. 管理者アカウントでログイン

### 6.2 F-REGI設定の登録

1. 管理画面の「F-REGI設定」メニューにアクセス
2. 「新規作成」をクリック
3. 以下の情報を入力：
   - **環境**: 本番環境
   - **SHOPID**: 本番環境のSHOPID
   - **接続パスワード**: 本番環境の接続パスワード
   - **通知URL**: `https://dschatbot.ai/billing/api/fregi/notify`
   - **戻りURL（成功）**: `https://dschatbot.ai/billing/return/success`
   - **戻りURL（キャンセル）**: `https://dschatbot.ai/billing/return/cancel`
   - **戻りURL（失敗）**: `https://dschatbot.ai/billing/return/failure`
4. 「保存」をクリック

---

## ステップ7: 動作確認

### 7.1 基本動作確認

1. **公開ページ**
   - `https://dschatbot.ai/billing/` にアクセス
   - 新規申込フォームが表示されることを確認
   - 404エラーが発生しないことを確認

2. **管理画面**
   - `https://dschatbot.ai/billing/login` にアクセス
   - ログインが正常に動作することを確認
   - ダッシュボードが表示されることを確認

3. **静的ファイル**
   - CSS、JS、画像が正しく読み込まれることを確認
   - ブラウザの開発者ツールでエラーがないか確認

### 7.2 エラーの確認

問題が発生した場合：

1. **エラーログの確認**
   - `/var/www/vhosts/dschatbot.ai/httpdocs/laravel_billing/storage/logs/laravel.log` を確認

2. **Apacheのエラーログ**
   - サーバー管理者に確認

3. **よくある問題**
   - パーミッションエラー: `storage/` と `bootstrap/cache/` のパーミッションを確認
   - データベース接続エラー: `.env` のデータベース設定を確認
   - 404エラー: `.htaccess` と `mod_rewrite` を確認

---

## トラブルシューティング

### 問題1: 500 Internal Server Error

**原因**: パーミッション、.env設定、APP_KEYの問題

**解決方法**:
1. `storage/` と `bootstrap/cache/` のパーミッションを確認
2. `.env` ファイルが正しく設定されているか確認
3. `APP_KEY` が設定されているか確認

### 問題2: 404 Not Found

**原因**: `.htaccess` または `mod_rewrite` の問題

**解決方法**:
1. `.htaccess` ファイルが正しく配置されているか確認
2. Apacheの `mod_rewrite` が有効になっているか確認
3. `RewriteBase /billing/` を追加してみる

### 問題3: データベース接続エラー

**原因**: `.env` のデータベース設定が間違っている

**解決方法**:
1. `.env` の `DB_*` 設定を確認
2. データベースサーバーが起動しているか確認
3. データベースのユーザー名・パスワードが正しいか確認

### 問題4: 静的ファイルが読み込まれない

**原因**: ファイルパスまたはパーミッションの問題

**解決方法**:
1. ファイルが正しくアップロードされているか確認
2. ファイルパーミッションを確認
3. ブラウザの開発者ツールで404エラーを確認

---

## デプロイ後のメンテナンス

### 定期的な確認事項

1. **ログファイルの確認**
   - `storage/logs/laravel.log` を定期的に確認
   - エラーが発生していないか確認

2. **ストレージのクリーンアップ**
   - `storage/logs/` のログファイルを定期的に削除
   - `storage/framework/cache/` のキャッシュをクリア

3. **セキュリティアップデート**
   - Composerの依存関係を定期的に更新
   - Laravelのセキュリティパッチを適用

### アップデート手順

1. ローカル環境で変更をテスト
2. 変更されたファイルのみをFTPでアップロード
3. 必要に応じてマイグレーションを実行
4. 動作確認

---

## チェックリスト

### デプロイ前

- [ ] ローカル環境で `composer install --no-dev` を実行
- [ ] 本番環境用の `index.php` を作成
- [ ] `.env` ファイルのテンプレートを準備

### デプロイ中

- [ ] Laravel本体を `/laravel_billing/` にアップロード
- [ ] 公開ディレクトリを `/webroot/billing/` にアップロード
- [ ] `index.php` を本番環境用に書き換え
- [ ] `.env` ファイルを設定
- [ ] パーミッションを設定

### デプロイ後

- [ ] マイグレーションを実行
- [ ] 管理者アカウントを作成
- [ ] F-REGI設定を登録
- [ ] 動作確認（公開ページ、管理画面）
- [ ] エラーログを確認

---

## 参考資料

- `AIdocs/本番環境整合性確認レポート.md`
- `AIdocs/本番環境デプロイチェックリスト.md`
- `AIdocs/Apache設定確認レポート.md`
- `AIdocs/AIdocs_Cursor指示書_Billingアプリ_ローカルDocker開始.md`
- `AIdocs/本番環境.envテンプレート.txt` - 本番環境用の.envテンプレート

## 添付ファイル

### 1. `app/public/index.php.production`
本番環境用の `index.php` ファイル。アップロード時に `index.php` にリネームして使用してください。

### 2. `app/public/.htaccess.production`
本番環境用の `.htaccess` ファイル（`RewriteBase /billing/` を追加）。アップロード時に `.htaccess` にリネームして使用してください。

### 3. `AIdocs/本番環境.envテンプレート.txt`
本番環境用の `.env` テンプレートファイル。コピーして `.env` として使用し、実際の値を設定してください。

---

## 注意事項

1. **Basic認証**: 現在ドメイン全体にBasic認証がかかっているため、動作確認時もBasic認証を通過する必要があります。

2. **セキュリティ設定**: システムが正常に動作することを確認してから、セキュリティ設定の改善を行ってください。

3. **バックアップ**: デプロイ前に既存のファイルやデータベースのバックアップを取得してください。

4. **テスト環境**: 可能であれば、本番環境と同じ構成のテスト環境で事前に動作確認を行うことを推奨します。

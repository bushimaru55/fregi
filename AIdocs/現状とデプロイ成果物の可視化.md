# 現状とデプロイ成果物の可視化

作成日: 2026-01-15

## 1. 現状のプロジェクト構造

### 1.1 リポジトリ直下のディレクトリ一覧

```bash
$ ls -la
drwxr-xr-x@ 11 dfn4459wgl  staff   352 Jan 15 13:24 .
drwx------@ 22 dfn4459wgl  staff   704 Jan 15 11:21 ..
-rw-r--r--@  1 dfn4459wgl  staff  6148 Jan 13 10:15 .DS_Store
drwxr-xr-x@ 13 dfn4459wgl  staff   416 Jan 15 13:20 .git
-rw-r--r--@  1 dfn4459wgl  staff   535 Jan  8 14:42 .gitignore
drwxr-xr-x  62 dfn4459wgl  staff  1984 Jan 15 10:58 AIdocs
-rw-r--r--@  1 dfn4459wgl  staff  9088 Jan  8 12:28 README.md
drwxr-xr-x  28 dfn4459wgl  staff   896 Jan  8 14:22 app              # Laravel本体
drwxr-xr-x@  3 dfn4459wgl  staff    96 Jan 15 13:24 deploy           # デプロイパッケージ生成先
drwxr-xr-x@  4 dfn4459wgl  staff   128 Jan  7 13:49 docker
-rw-r--r--@  1 dfn4459wgl  staff   810 Jan  8 12:28 docker-compose.yml
```

### 1.2 billing.zip展開後のトップ階層（billing/ 配下）の構造

```
billing/
├── .git/
├── AIdocs/
├── app/                    # Laravel本体
│   ├── app/                # アプリケーションコード
│   ├── artisan            # ← Laravel本体の所在
│   ├── bootstrap/
│   │   └── cache/         # 書き込み権限必要
│   ├── composer.json      # ← Laravel本体の所在
│   ├── composer.lock
│   ├── config/
│   ├── database/
│   │   ├── migrations/
│   │   └── seeders/
│   ├── public/            # ← public/ の所在
│   │   ├── .htaccess
│   │   ├── index.php
│   │   ├── build/         # Viteビルド成果物（既に存在）
│   │   │   ├── assets/
│   │   │   └── manifest.json
│   │   ├── css/
│   │   ├── js/
│   │   ├── favicon.ico
│   │   └── robots.txt
│   ├── resources/
│   │   ├── css/
│   │   ├── js/
│   │   └── views/
│   ├── routes/
│   ├── storage/           # 書き込み権限必要
│   │   ├── app/
│   │   ├── framework/
│   │   └── logs/
│   ├── vendor/            # composer install で生成
│   ├── node_modules/      # npm install で生成（デプロイには含めない）
│   ├── package.json
│   ├── vite.config.js
│   └── ...
├── deploy/
│   └── webroot_billing/   # デプロイパッケージ（部分的な作成済み）
│       ├── index.php      # 既に作成済み
│       └── README.md      # 既に作成済み
├── docker/
└── docker-compose.yml
```

### 1.3 Laravel本体の場所

- **artisan**: `./app/artisan` ✅
- **composer.json**: `./app/composer.json` ✅
- **public/**: `./app/public/` ✅
- **Viteビルド成果物**: `./app/public/build/` ✅（既に存在）

---

## 2. 生成予定のデプロイ成果物構造

### 2.1 deploy/webroot_billing/ 配下の完全な構造（計画）

```
deploy/webroot_billing/
├── index.php              # ✅ 既に作成済み（要確認・修正）
├── .htaccess              # ⏳ 作成予定（app/public/.htaccess からコピー）
├── build/                 # ⏳ 作成予定（app/public/build/ からコピー）
│   ├── assets/
│   │   ├── app-*.js
│   │   └── app-*.css
│   └── manifest.json      # ← 動作確認用（/webroot/billing/build/manifest.json）
├── css/                   # ⏳ 作成予定（app/public/css/ からコピー）
│   └── filament/
├── js/                    # ⏳ 作成予定（app/public/js/ からコピー）
│   └── filament/
├── favicon.ico            # ⏳ 作成予定（app/public/favicon.ico からコピー）
├── robots.txt             # ⏳ 作成予定（app/public/robots.txt からコピー）
├── app/                   # ⏳ 作成予定（Laravel本体）
│   ├── .htaccess          # ⏳ 新規作成（Require all denied）
│   ├── artisan
│   ├── app/
│   ├── bootstrap/
│   │   └── cache/         # 書き込み権限必要（775）
│   ├── config/
│   ├── database/
│   ├── resources/
│   ├── routes/
│   ├── storage/           # 書き込み権限必要（775）
│   │   ├── app/
│   │   ├── framework/
│   │   └── logs/
│   ├── vendor/            # ⏳ composer install --no-dev で生成
│   ├── composer.json
│   ├── composer.lock
│   └── .env               # ⏳ 手動で設定（テンプレートから作成）
└── README.md              # ✅ 既に作成済み（要確認・更新）
```

### 2.2 生成するファイル/ディレクトリの一覧（計画）

#### ✅ 既に作成済み
- `deploy/webroot_billing/index.php`
- `deploy/webroot_billing/README.md`

#### ⏳ 作成予定（公開ディレクトリ）

1. **.htaccess**
   - コピー元: `app/public/.htaccess`
   - 修正: `RewriteBase /webroot/billing/` を追加（推奨）

2. **build/**
   - コピー元: `app/public/build/`
   - 内容: `assets/`, `manifest.json`
   - 確認URL: `https://dschatbot.ai/webroot/billing/build/manifest.json`

3. **css/**
   - コピー元: `app/public/css/`
   - 内容: `filament/` 配下

4. **js/**
   - コピー元: `app/public/js/`
   - 内容: `filament/` 配下

5. **favicon.ico**
   - コピー元: `app/public/favicon.ico`

6. **robots.txt**
   - コピー元: `app/public/robots.txt`

#### ⏳ 作成予定（Laravel本体: app/ 配下）

1. **app/.htaccess** - 新規作成
   ```apache
   Require all denied
   ```
   - 確認URL: `https://dschatbot.ai/webroot/billing/app/.env` → 403エラー

2. **app/app/** - コピー元: `app/app/`

3. **app/bootstrap/** - コピー元: `app/bootstrap/`
   - `cache/` は書き込み権限必要（775）

4. **app/config/** - コピー元: `app/config/`

5. **app/database/** - コピー元: `app/database/`

6. **app/resources/** - コピー元: `app/resources/`

7. **app/routes/** - コピー元: `app/routes/`

8. **app/storage/** - コピー元: `app/storage/`
   - 書き込み権限必要（775）

9. **app/vendor/** - 生成: `composer install --no-dev` を実行

10. **app/artisan** - コピー元: `app/artisan`

11. **app/composer.json** - コピー元: `app/composer.json`

12. **app/composer.lock** - コピー元: `app/composer.lock`

13. **app/.env** - 手動で設定（テンプレートから作成）

#### ❌ 除外するファイル/ディレクトリ

- `node_modules/`
- `.git/`
- `__MACOSX/`
- `.DS_Store`
- `tests/`
- `phpunit.xml`
- `package.json`, `package-lock.json`
- `vite.config.js`
- `tailwind.config.js`
- `postcss.config.js`
- `.editorconfig`
- `.gitattributes`
- `.gitignore`

---

## 3. スクリプト作成計画

### 3.1 スクリプト名・配置先

- **スクリプト名**: `scripts/build_deploy_webroot_billing.sh`
- **配置先**: `/Users/dfn4459wgl/Desktop/billing/scripts/build_deploy_webroot_billing.sh`

### 3.2 スクリプトの処理フロー（詳細）

1. **作業ディレクトリの確認**
   - プロジェクトルート（`/Users/dfn4459wgl/Desktop/billing`）にいることを確認

2. **既存のデプロイパッケージのクリーンアップ**
   - `deploy/webroot_billing/` が存在する場合は削除（バックアップ推奨）

3. **デプロイディレクトリの作成**
   - `deploy/webroot_billing/` を作成
   - `deploy/webroot_billing/app/` を作成

4. **Viteビルドの実行**
   - `cd app && npm run build`
   - 成功確認: `app/public/build/manifest.json` の存在確認

5. **公開ディレクトリのコピー**
   - `app/public/.htaccess` → `deploy/webroot_billing/.htaccess`
   - `app/public/build/` → `deploy/webroot_billing/build/`
   - `app/public/css/` → `deploy/webroot_billing/css/`
   - `app/public/js/` → `deploy/webroot_billing/js/`
   - `app/public/favicon.ico` → `deploy/webroot_billing/favicon.ico`
   - `app/public/robots.txt` → `deploy/webroot_billing/robots.txt`

6. **index.php の修正**
   - `deploy/webroot_billing/index.php` を確認・修正
   - パス参照を `__DIR__.'/app/...` に変更

7. **Laravel本体のコピー**
   - `app/app/` → `deploy/webroot_billing/app/app/`
   - `app/bootstrap/` → `deploy/webroot_billing/app/bootstrap/`
   - `app/config/` → `deploy/webroot_billing/app/config/`
   - `app/database/` → `deploy/webroot_billing/app/database/`
   - `app/resources/` → `deploy/webroot_billing/app/resources/`
   - `app/routes/` → `deploy/webroot_billing/app/routes/`
   - `app/storage/` → `deploy/webroot_billing/app/storage/`
   - `app/artisan` → `deploy/webroot_billing/app/artisan`
   - `app/composer.json` → `deploy/webroot_billing/app/composer.json`
   - `app/composer.lock` → `deploy/webroot_billing/app/composer.lock`

8. **app/.htaccess の作成**
   - `deploy/webroot_billing/app/.htaccess` を作成
   - 内容: `Require all denied`

9. **composer install の実行**
   - `cd deploy/webroot_billing/app && composer install --no-dev --optimize-autoloader`

10. **パーミッションの設定**
    - `chmod -R 775 deploy/webroot_billing/app/storage`
    - `chmod -R 775 deploy/webroot_billing/app/bootstrap/cache`

11. **README.md の生成/更新**
    - FTPアップロード手順
    - 動作確認URL
    - パーミッション設定手順

---

## 4. npm run build の実行

### 4.1 実行ディレクトリ

```bash
cd /Users/dfn4459wgl/Desktop/billing/app
npm run build
```

### 4.2 成功条件

- **manifest.json の場所**: `app/public/build/manifest.json` ✅（既に存在）
- **確認方法**: 
  ```bash
  ls -la app/public/build/manifest.json
  # または
  test -f app/public/build/manifest.json && echo "Vite build成功" || echo "Vite build失敗"
  ```
- **ビルド成果物**: `app/public/build/` ディレクトリに以下が生成される
  - `assets/` ディレクトリ（CSS/JSファイル）
  - `manifest.json`

### 4.3 現在の状態

- ✅ `app/public/build/manifest.json` が存在
- ✅ `app/public/build/assets/` が存在
- ⚠️ 最新のビルドかどうか要確認（必要に応じて再ビルド）

### 4.4 再ビルドが必要な場合

```bash
cd /Users/dfn4459wgl/Desktop/billing/app
npm run build
```

---

## 5. 動作確認URL（デプロイ後）

### 5.1 正常にアクセスできるURL

- `https://dschatbot.ai/webroot/billing/` - トップページ（新規申込フォーム）
- `https://dschatbot.ai/webroot/billing/login` - ログインページ
- `https://dschatbot.ai/webroot/billing/build/manifest.json` - ビルド成果物の確認

### 5.2 403エラーが返るべきURL（セキュリティ確認）

- `https://dschatbot.ai/webroot/billing/app/.env` - 403エラー（.htaccessで保護）
- `https://dschatbot.ai/webroot/billing/app/vendor/` - 403エラー（.htaccessで保護）
- `https://dschatbot.ai/webroot/billing/app/storage/` - 403エラー（.htaccessで保護）
- `https://dschatbot.ai/webroot/billing/app/config/` - 403エラー（.htaccessで保護）

---

## 6. 次のステップ

1. ✅ 現状の可視化（完了）
2. ⏳ スクリプト `scripts/build_deploy_webroot_billing.sh` を作成
3. ⏳ スクリプトを実行してデプロイパッケージを生成
4. ⏳ 生成されたパッケージの確認
5. ⏳ README.md の更新
